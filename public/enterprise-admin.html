<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Enterprise Admin - StablePay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Base: Dark theme (matches dashboard) */
        body {
            background: #0f172a;
            color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            min-height: 100vh;
        }

        /* Neo-brutalism elements */
        .brutal-border {
            border: 4px solid #000;
            box-shadow: 8px 8px 0px #000;
        }

        .brutal-border-thin {
            border: 3px solid #000;
            box-shadow: 6px 6px 0px #000;
        }

        .brutal-shadow {
            box-shadow: 6px 6px 0px #000;
        }

        .brutal-shadow-sm {
            box-shadow: 4px 4px 0px #000;
        }

        .btn-brutal {
            background: #000;
            color: #fff;
            border: 4px solid #000;
            box-shadow: 6px 6px 0px #000;
            transition: all 0.15s ease;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-brutal:hover {
            transform: translate(-2px, -2px);
            box-shadow: 8px 8px 0px #000;
        }

        .btn-brutal:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        h1, h2, h3 {
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* Status badges */
        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        .status-inactive {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }
        .status-pending {
            background: rgba(234, 179, 8, 0.2);
            color: #facc15;
            border: 1px solid rgba(234, 179, 8, 0.3);
        }
        .plan-starter {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .plan-growth {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        .plan-enterprise {
            background: rgba(234, 179, 8, 0.2);
            color: #facc15;
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        /* Tab styling */
        .tab-btn {
            transition: all 0.15s ease;
        }
        .tab-btn.active {
            border-color: #3b82f6;
            color: #60a5fa;
        }

        /* Table row hover */
        tbody tr:hover {
            background: rgba(30, 41, 59, 0.5);
        }

        /* Day mode (light theme) - toggle when user clicks sun icon */
        body.day-mode {
            background: #f8fafc;
            color: #0f172a;
        }

        body.day-mode .bg-slate-900,
        body.day-mode .bg-slate-950 {
            background: #fff !important;
            border-color: #e2e8f0 !important;
        }

        body.day-mode .bg-slate-800 {
            background: #f1f5f9 !important;
        }

        body.day-mode .border-slate-800,
        body.day-mode .border-slate-700 {
            border-color: #e2e8f0 !important;
        }

        body.day-mode .text-white {
            color: #0f172a !important;
        }

        body.day-mode .text-slate-400,
        body.day-mode .text-slate-500,
        body.day-mode .text-slate-300 {
            color: #64748b !important;
        }

        body.day-mode .text-blue-400 {
            color: #2563eb !important;
        }

        body.day-mode .text-green-400 {
            color: #16a34a !important;
        }

        body.day-mode .text-yellow-400,
        body.day-mode .text-yellow-500 {
            color: #d97706 !important;
        }

        body.day-mode .text-purple-400 {
            color: #9333ea !important;
        }

        body.day-mode .text-red-400 {
            color: #dc2626 !important;
        }

        body.day-mode .divide-slate-800 > * + * {
            border-color: #e2e8f0 !important;
        }

        body.day-mode tbody tr:hover {
            background: rgba(241, 245, 249, 0.8) !important;
        }

        body.day-mode .tab-btn {
            color: #64748b !important;
        }

        body.day-mode .tab-btn.active {
            color: #2563eb !important;
            border-color: #2563eb !important;
        }

        body.day-mode .status-active {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
            border-color: rgba(34, 197, 94, 0.3);
        }

        body.day-mode .status-pending {
            background: rgba(234, 179, 8, 0.15);
            color: #d97706;
            border-color: rgba(234, 179, 8, 0.3);
        }

        body.day-mode .plan-starter {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }

        body.day-mode .plan-growth {
            background: rgba(168, 85, 247, 0.15);
            color: #9333ea;
        }

        body.day-mode input,
        body.day-mode select,
        body.day-mode textarea {
            background: #fff;
            color: #0f172a;
            border-color: #e2e8f0;
        }

        body.day-mode .bg-blue-600 {
            background: #2563eb !important;
        }

        body.day-mode .bg-red-600 {
            background: #dc2626 !important;
        }

        body.day-mode .bg-black {
            background: #f8fafc !important;
        }

        body.day-mode .border-b {
            border-color: #e2e8f0 !important;
        }

        body.day-mode h3.text-white,
        body.day-mode label.text-white,
        body.day-mode .text-sm.font-medium.text-white {
            color: #0f172a !important;
        }

        body.day-mode .text-xs.text-slate-400,
        body.day-mode p.text-slate-400,
        body.day-mode .text-sm.text-slate-400 {
            color: #64748b !important;
        }

        /* Input styling */
        input, select, textarea {
            background: #0f172a;
            color: #fff;
            border: 1px solid #334155;
            border-radius: 0;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-slate-950 border border-slate-800 p-10 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-white mb-2">Enterprise Admin Login</h2>
                <p class="text-slate-400">Super admin access only</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">EMAIL</label>
                    <input
                        type="email"
                        id="adminEmail"
                        required
                        placeholder="admin@stablepay.com"
                        class="w-full px-4 py-3 bg-black border border-slate-800 text-white focus:border-blue-600 focus:outline-none"
                    >
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">PASSWORD</label>
                    <input
                        type="password"
                        id="adminPassword"
                        required
                        autocomplete="current-password"
                        class="w-full px-4 py-3 bg-black border border-slate-800 text-white focus:border-blue-600 focus:outline-none"
                    >
                </div>

                <div id="loginError" class="hidden text-red-400 text-sm text-center border border-red-900 bg-red-900/20 py-2">
                    Invalid credentials
                </div>

                <button
                    type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 font-medium transition-colors"
                >
                    LOGIN
                </button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div id="adminContent" class="hidden">
        <!-- Header -->
        <nav class="bg-slate-900 border-b border-slate-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <a href="/" class="text-xl font-bold text-white uppercase tracking-tight">
                            StablePay
                        </a>
                        <span class="ml-4 px-3 py-1 bg-red-600/20 text-red-400 border border-red-600/30 text-xs font-medium uppercase">
                            Enterprise Admin
                        </span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Language Selector -->
                        <select id="languageSelector" class="bg-slate-800 border border-slate-700 text-white px-2 py-1 text-xs cursor-pointer hover:bg-slate-700">
                            <option value="en">EN</option>
                            <option value="es">ES</option>
                            <option value="fr">FR</option>
                            <option value="pt">PT</option>
                        </select>
                        <!-- Day/Night Mode Toggle -->
                        <button id="nightModeToggle" class="px-3 py-1 border border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-medium uppercase">
                            <span class="night-icon">Dark</span>
                            <span class="day-icon hidden">Light</span>
                        </button>
                        <button id="refreshBtn" class="bg-slate-800 text-white px-4 py-1.5 font-medium border border-slate-700 hover:bg-slate-700 transition-all text-xs" data-i18n="nav.refresh">
                            Refresh
                        </button>
                        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-1.5 font-medium border border-red-700 hover:bg-red-700 transition-all text-xs" data-i18n="nav.logout">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Tabs -->
            <div class="mb-6 border-b border-slate-800">
                <nav class="-mb-px flex space-x-8">
                    <button class="tab-btn border-b-2 border-blue-500 text-blue-400 py-4 px-1 text-sm font-medium" data-tab="merchants">
                        Merchants
                    </button>
                    <button class="tab-btn border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 py-4 px-1 text-sm font-medium" data-tab="orders">
                        All Orders
                    </button>
                    <button class="tab-btn border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 py-4 px-1 text-sm font-medium" data-tab="refunds">
                        Refunds
                    </button>
                    <button class="tab-btn border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 py-4 px-1 text-sm font-medium" data-tab="receipts">
                        Receipts
                    </button>
                    <button class="tab-btn border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 py-4 px-1 text-sm font-medium" data-tab="analytics">
                        Platform Analytics
                    </button>
                    <button class="tab-btn border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 py-4 px-1 text-sm font-medium" data-tab="settings">
                        System Settings
                    </button>
                    <button class="tab-btn border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 py-4 px-1 text-sm font-medium" data-tab="wallets">
                        Fee Wallets
                    </button>
                    <button class="tab-btn border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 py-4 px-1 text-sm font-medium" data-tab="billing">
                        Billing & Fees
                    </button>
                </nav>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                <div class="bg-slate-950 border border-slate-800 p-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-lg bg-blue-900/30 border border-blue-700 flex items-center justify-center">
                            <div class="w-3 h-3 rounded-full bg-blue-400"></div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-slate-400">Total Merchants</p>
                            <p class="text-2xl font-bold text-white" id="totalMerchants">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-950 border border-slate-800 p-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-lg bg-green-900/30 border border-green-700 flex items-center justify-center">
                            <div class="w-3 h-3 rounded-full bg-green-400"></div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-slate-400">Active Merchants</p>
                            <p class="text-2xl font-bold text-green-400" id="activeMerchants">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-950 border border-slate-800 p-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-lg bg-purple-900/30 border border-purple-700 flex items-center justify-center">
                            <div class="w-3 h-3 rounded-full bg-purple-400"></div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-slate-400">Total Orders</p>
                            <p class="text-2xl font-bold text-purple-400" id="totalOrders">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-950 border border-slate-800 p-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-lg bg-yellow-900/30 border border-yellow-700 flex items-center justify-center">
                            <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-slate-400">Total Volume</p>
                            <p class="text-2xl font-bold text-yellow-400" id="totalVolume">$0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-950 border border-slate-800 p-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-lg bg-emerald-900/30 border border-emerald-700 flex items-center justify-center">
                            <div class="w-3 h-3 rounded-full bg-emerald-400"></div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-slate-400">Fees Earned</p>
                            <p class="text-2xl font-bold text-emerald-400" id="totalFeesEarned">$0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Merchants Tab -->
            <div id="merchantsTab" class="tab-content">
                <div class="bg-slate-950 border shadow-sm border">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h2 class="text-xl font-bold text-white">Merchant Accounts</h2>
                        <button id="addMerchantBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 border font-medium">
                            Add Merchant
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-950 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase w-48">Company</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase w-40">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase w-28">Plan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase w-24">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase w-20">Orders</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase w-28">Volume</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase w-32">Created</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-400 uppercase w-32">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="merchantsTableBody" class="divide-y divide-slate-800">
                                <tr>
                                    <td colspan="8" class="px-6 py-8 text-center text-slate-400">
                                        Loading merchants...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="tab-content hidden">
                <div class="bg-slate-950 border shadow-sm border">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">All Platform Orders</h2>
                            <select id="merchantFilter" class="border border-slate-800 border px-4 py-2">
                                <option value="">All Merchants</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-950 border-b">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Order ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Merchant</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Fee %</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Your Fee</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Chain</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Date</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody" class="divide-y divide-slate-800">
                                <tr>
                                    <td colspan="9" class="px-6 py-8 text-center text-slate-400">
                                        Loading orders...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Refunds Tab -->
            <div id="refundsTab" class="tab-content hidden">
                <!-- Refund Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-400">Pending Refunds</p>
                                <p class="text-2xl font-bold text-orange-400" id="pendingRefundsCount">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-lg bg-orange-900/30 border border-orange-700 flex items-center justify-center">
                                <span class="text-orange-400">!</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-400">Total Refunded</p>
                                <p class="text-2xl font-bold text-green-400" id="totalRefunded">$0.00</p>
                            </div>
                            <div class="w-10 h-10 rounded-lg bg-green-900/30 border border-green-700 flex items-center justify-center">
                                <span class="text-green-400">$</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-400">Rejected</p>
                                <p class="text-2xl font-bold text-red-400" id="rejectedRefundsCount">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-lg bg-red-900/30 border border-red-700 flex items-center justify-center">
                                <span class="text-red-400">X</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Refunds Table -->
                <div class="bg-slate-950 border shadow-sm border">
                    <div class="p-6 border-b">
                        <h2 class="text-xl font-bold text-white">Refund Requests</h2>
                        <p class="text-sm text-slate-400 mt-1">Review, approve, and process customer refund requests</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-950 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Order</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Merchant</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Reason</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="refundsTableBody" class="divide-y divide-slate-800">
                                <tr>
                                    <td colspan="8" class="px-6 py-8 text-center text-slate-400">
                                        Loading refunds...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Refund Process Instructions -->
                <div class="mt-6 bg-slate-950 border shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">How Refunds Work</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 rounded-full bg-orange-900/30 border border-orange-700 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-orange-400 text-xs font-bold">1</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-slate-300">Review & Approve</h4>
                                <p class="text-slate-400 mt-1">Review the refund request and click Approve or Reject</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 rounded-full bg-blue-900/30 border border-blue-700 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-blue-400 text-xs font-bold">2</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-slate-300">Send Crypto Manually</h4>
                                <p class="text-slate-400 mt-1">Send USDC to the customer's wallet on the correct chain</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 rounded-full bg-green-900/30 border border-green-700 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-green-400 text-xs font-bold">3</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-slate-300">Record TX Hash</h4>
                                <p class="text-slate-400 mt-1">Click Process and paste the transaction hash to complete the refund</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipts Tab -->
            <div id="receiptsTab" class="tab-content hidden">
                <!-- Receipt Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-400">Total Receipts</p>
                                <p class="text-2xl font-bold text-blue-400" id="totalReceiptsCount">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-lg bg-blue-900/30 border border-blue-700 flex items-center justify-center">
                                <span class="text-blue-400">#</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-400">Emails Sent</p>
                                <p class="text-2xl font-bold text-green-400" id="emailsSentCount">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-lg bg-green-900/30 border border-green-700 flex items-center justify-center">
                                <span class="text-green-400">@</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-400">Emails Pending</p>
                                <p class="text-2xl font-bold text-yellow-400" id="emailsPendingCount">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-lg bg-yellow-900/30 border border-yellow-700 flex items-center justify-center">
                                <span class="text-yellow-400">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Receipts Table -->
                <div class="bg-slate-950 border shadow-sm border">
                    <div class="p-6 border-b flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-white">Payment Receipts</h2>
                            <p class="text-sm text-slate-400 mt-1">View all receipts, download PDFs, and resend emails</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-950 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Receipt #</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Order</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Chain</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Email Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="receiptsTableBody" class="divide-y divide-slate-800">
                                <tr>
                                    <td colspan="8" class="px-6 py-8 text-center text-slate-400">
                                        Loading receipts...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content hidden">
                <div class="bg-slate-950 border shadow-sm border p-6">
                    <h2 class="text-xl font-bold text-white mb-6">Platform Analytics</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-4">Revenue by Merchant</h3>
                            <div id="revenueByMerchant" class="space-y-3">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Settings Tab -->
            <div id="settingsTab" class="tab-content hidden">
                <div class="bg-slate-950 border shadow-sm border p-6">
                    <h2 class="text-xl font-bold text-white mb-6">System Settings</h2>

                    <div class="space-y-8">
                        <!-- UI Visibility Settings -->
                        <div class="border-b border-slate-800 pb-6">
                            <h3 class="text-lg font-semibold text-white mb-4">User Interface Visibility</h3>
                            <p class="text-sm text-slate-400 mb-4">Control which features are visible to merchants in their dashboards</p>

                            <div class="space-y-4">
                                <!-- Payment Plan Visibility -->
                                <div class="flex items-center justify-between p-4 bg-black border border-slate-800">
                                    <div>
                                        <label class="text-sm font-medium text-white">Payment Plan References</label>
                                        <p class="text-xs text-slate-400 mt-1">Show/hide plan fields and pricing tiers across all merchant views</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="showPaymentPlans" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>

                                <!-- Invoice Feature Toggle -->
                                <div class="flex items-center justify-between p-4 bg-black border border-slate-800">
                                    <div>
                                        <label class="text-sm font-medium text-white">Invoice System</label>
                                        <p class="text-xs text-slate-400 mt-1">Enable/disable invoice creation and management for merchants</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="enableInvoices" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="flex justify-end">
                            <button id="saveSystemSettings" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 font-medium transition-colors">
                                ðŸ’¾ Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fee Wallets Tab -->
            <div id="walletsTab" class="tab-content hidden">
                <div class="bg-slate-950 border shadow-sm border">
                    <div class="p-6 border-b flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-white">Platform Fee Wallets</h2>
                            <p class="text-sm text-slate-400 mt-1">Configure wallets for collecting merchant fee payments (one per chain)</p>
                        </div>
                        <button id="addWalletBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 border font-medium">
                            Add Wallet
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-950 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Chain</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Wallet Address</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Label</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Added</th>
                                    <th class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="walletsTableBody" class="divide-y divide-slate-800">
                                <tr>
                                    <td colspan="6" class="px-6 py-8 text-center text-slate-400">
                                        Loading wallets...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Wallet Info -->
                <div class="mt-6 bg-slate-950 border shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Fee Collection Info</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                        <div>
                            <h4 class="font-medium text-slate-300 mb-2">How it works</h4>
                            <ul class="text-slate-400 space-y-1">
                                <li>- Merchants receive 100% of customer payments directly</li>
                                <li>- Fees accumulate and are invoiced based on billing cycle</li>
                                <li>- Merchants pay fees to your platform wallets</li>
                                <li>- One wallet per chain for fee collection</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-medium text-slate-300 mb-2">Supported Tokens</h4>
                            <ul class="text-slate-400 space-y-1">
                                <li>- USDC (primary)</li>
                                <li>- USDT</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Billing & Fees Tab -->
            <div id="billingTab" class="tab-content hidden">
                <!-- Fees Overview Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-400">Total Fees Owed</p>
                                <p class="text-2xl font-bold text-yellow-400" id="totalFeesOwed">$0.00</p>
                            </div>
                            <div class="w-10 h-10 rounded-lg bg-yellow-900/30 border border-yellow-700 flex items-center justify-center">
                                <span class="text-yellow-400">$</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-400">Pending Payments</p>
                                <p class="text-2xl font-bold text-orange-400" id="pendingPayments">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-lg bg-orange-900/30 border border-orange-700 flex items-center justify-center">
                                <span class="text-orange-400">!</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-400">Total Collected</p>
                                <p class="text-2xl font-bold text-green-400" id="totalCollected">$0.00</p>
                            </div>
                            <div class="w-10 h-10 rounded-lg bg-green-900/30 border border-green-700 flex items-center justify-center">
                                <span class="text-green-400">+</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Merchants with Fees Due -->
                <div class="bg-slate-950 border shadow-sm border mb-6">
                    <div class="p-6 border-b">
                        <h2 class="text-xl font-bold text-white">Merchants with Fees Due</h2>
                        <p class="text-sm text-slate-400 mt-1">View merchants who owe platform fees</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-950 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Merchant</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Plan</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Fees Due</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Last Payment</th>
                                </tr>
                            </thead>
                            <tbody id="merchantFeesTableBody" class="divide-y divide-slate-800">
                                <tr>
                                    <td colspan="5" class="px-6 py-8 text-center text-slate-400">
                                        Loading merchant fees...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pending Fee Payments -->
                <div class="bg-slate-950 border shadow-sm border">
                    <div class="p-6 border-b">
                        <h2 class="text-xl font-bold text-white">Pending Fee Payments</h2>
                        <p class="text-sm text-slate-400 mt-1">Review and verify merchant fee payments</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-950 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Merchant</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Chain</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">TX Hash</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingPaymentsTableBody" class="divide-y divide-slate-800">
                                <tr>
                                    <td colspan="6" class="px-6 py-8 text-center text-slate-400">
                                        Loading pending payments...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Merchant Modal -->
    <div id="addMerchantModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-950 border shadow-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-white mb-6">Add New Merchant</h2>

            <form id="addMerchantForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Company Name *</label>
                        <input type="text" id="companyName" required class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Contact Name *</label>
                        <input type="text" id="contactName" required class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Email *</label>
                        <input type="email" id="merchantEmail" required class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Website</label>
                        <input type="url" id="website" class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Plan</label>
                        <select id="plan" class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                            <option value="STARTER">Starter</option>
                            <option value="GROWTH">Growth</option>
                            <option value="ENTERPRISE">Enterprise</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Network Mode</label>
                        <select id="networkMode" class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                            <option value="TESTNET">Testnet</option>
                            <option value="MAINNET">Mainnet</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Industry</label>
                    <input type="text" id="industry" class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Notes</label>
                    <textarea id="notes" rows="3" class="w-full px-3 py-2 bg-black border border-slate-800 text-white "></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelAddMerchant" class="px-4 py-2 border border-slate-800  text-slate-300 hover:bg-slate-950">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white  hover:bg-blue-700">
                        Create Merchant
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Merchant Modal -->
    <div id="editMerchantModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-950 border shadow-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-white mb-6">Edit Merchant</h2>

            <form id="editMerchantForm" class="space-y-4">
                <input type="hidden" id="editMerchantId">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Company Name *</label>
                        <input type="text" id="editCompanyName" required class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Contact Name *</label>
                        <input type="text" id="editContactName" required class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Email *</label>
                        <input type="email" id="editEmail" required class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Website</label>
                        <input type="url" id="editWebsite" class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Plan</label>
                        <select id="editPlan" class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                            <option value="">None</option>
                            <option value="STARTER">Starter</option>
                            <option value="GROWTH">Growth</option>
                            <option value="ENTERPRISE">Enterprise</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Network Mode</label>
                        <select id="editNetworkMode" class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                            <option value="TESTNET">Testnet</option>
                            <option value="MAINNET">Mainnet</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Industry</label>
                        <input type="text" id="editIndustry" class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Status</label>
                        <select id="editIsActive" class="w-full px-3 py-2 bg-black border border-slate-800 text-white ">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Notes</label>
                    <textarea id="editNotes" rows="3" class="w-full px-3 py-2 bg-black border border-slate-800 text-white "></textarea>
                </div>

                <!-- Chain Configuration -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Payment Chains & Wallets</h3>
                    <p class="text-sm text-slate-400 mb-4">Enable chains and configure wallet addresses to receive payments</p>

                    <div id="editChainToggles" class="space-y-3">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="cancelEditMerchant" class="px-4 py-2 border border-slate-800  text-slate-300 hover:bg-slate-950">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white  hover:bg-green-700">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-950 border shadow-xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-white mb-4">Confirm Deletion</h2>
            <p class="text-slate-400 mb-6">Are you sure you want to delete <strong id="deleteMerchantName"></strong>? This action cannot be undone.</p>

            <div class="bg-yellow-900/20 border-l-4 border-yellow-800 p-4 mb-6">
                <p class="text-sm text-yellow-300">WARNING: This will permanently delete the merchant and all associated data including orders, wallets, and transactions.</p>
            </div>

            <div class="flex justify-end space-x-3">
                <button id="cancelDelete" class="px-4 py-2 border border-slate-800  text-slate-300 hover:bg-slate-950">
                    Cancel
                </button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white  hover:bg-red-700">
                    Delete Permanently
                </button>
            </div>
        </div>
    </div>

    <!-- Merchant Details Modal -->
    <div id="merchantDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-950 border shadow-xl p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white" id="detailMerchantName">Merchant Details</h2>
                    <p class="text-slate-400 text-sm mt-1" id="detailMerchantEmail"></p>
                </div>
                <button id="closeMerchantDetails" class="text-slate-400 hover:text-slate-400">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>

            <div id="merchantDetailsContent" class="space-y-6">
                <!-- Profile Section -->
                <div class="bg-slate-950 border p-6">
                    <h3 class="text-lg font-semibold mb-4">Profile Information</h3>
                    <div class="grid grid-cols-2 gap-4" id="detailProfile">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Wallets Section -->
                <div class="bg-slate-950 border p-6">
                    <h3 class="text-lg font-semibold mb-4">Payment Wallets</h3>
                    <div id="detailWallets" class="space-y-2">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Orders Section -->
                <div class="bg-slate-950 border p-6">
                    <h3 class="text-lg font-semibold mb-4">Recent Orders</h3>
                    <div id="detailOrders">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Analytics Section -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-blue-900/20 border p-4">
                        <div class="text-sm text-blue-400 font-medium">Total Orders</div>
                        <div class="text-2xl font-bold text-blue-300" id="detailTotalOrders">0</div>
                    </div>
                    <div class="bg-green-900/20 border p-4">
                        <div class="text-sm text-green-400 font-medium">Total Volume</div>
                        <div class="text-2xl font-bold text-green-300" id="detailTotalVolume">$0.00</div>
                    </div>
                    <div class="bg-purple-900/20 border p-4">
                        <div class="text-sm text-purple-400 font-medium">Avg Order Value</div>
                        <div class="text-2xl font-bold text-purple-300" id="detailAvgOrder">$0.00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Platform Wallet Modal -->
    <div id="walletModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-950 border shadow-xl p-8 max-w-lg w-full mx-4">
            <h2 class="text-2xl font-bold text-white mb-6" id="walletModalTitle">Add Platform Wallet</h2>

            <form id="walletForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Chain *</label>
                    <select id="walletChain" required class="w-full px-3 py-2 bg-black border border-slate-800 text-white">
                        <option value="">Select a chain...</option>
                        <option value="BASE_SEPOLIA">Base Sepolia (Testnet)</option>
                        <option value="BASE_MAINNET">Base Mainnet</option>
                        <option value="ETHEREUM_SEPOLIA">Ethereum Sepolia (Testnet)</option>
                        <option value="ETHEREUM_MAINNET">Ethereum Mainnet</option>
                        <option value="POLYGON_MAINNET">Polygon Mainnet</option>
                        <option value="POLYGON_MUMBAI">Polygon Mumbai (Testnet)</option>
                        <option value="ARBITRUM_MAINNET">Arbitrum Mainnet</option>
                        <option value="ARBITRUM_SEPOLIA">Arbitrum Sepolia (Testnet)</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Only one wallet per chain is allowed</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Wallet Address *</label>
                    <input type="text" id="walletAddress" required placeholder="0x..." class="w-full px-3 py-2 bg-black border border-slate-800 text-white font-mono">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Label (Optional)</label>
                    <input type="text" id="walletLabel" placeholder="e.g., Treasury, Main, Operations" class="w-full px-3 py-2 bg-black border border-slate-800 text-white">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelWallet" class="px-4 py-2 border border-slate-800 text-slate-300 hover:bg-slate-950">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700">
                        Save Wallet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let merchants = [];
        let orders = [];
        let merchantWallets = {}; // Store wallets by merchantId
        let platformWallets = []; // Store platform wallets for fee collection

        // Chain configuration
        const CHAINS = [
            { id: 'BASE_SEPOLIA', name: 'Base Sepolia', network: 'testnet', icon: 'ðŸ”µ' },
            { id: 'BASE_MAINNET', name: 'Base Mainnet', network: 'mainnet', icon: 'ðŸ”µ' },
            { id: 'ETHEREUM_SEPOLIA', name: 'Ethereum Sepolia', network: 'testnet', icon: 'âŸ ' },
            { id: 'ETHEREUM_MAINNET', name: 'Ethereum Mainnet', network: 'mainnet', icon: 'âŸ ' },
            { id: 'POLYGON_MAINNET', name: 'Polygon Mainnet', network: 'mainnet', icon: 'ðŸŸ£' },
            { id: 'POLYGON_MUMBAI', name: 'Polygon Mumbai', network: 'testnet', icon: 'ðŸŸ£' },
            { id: 'ARBITRUM_MAINNET', name: 'Arbitrum Mainnet', network: 'mainnet', icon: 'ðŸ”·' },
            { id: 'ARBITRUM_SEPOLIA', name: 'Arbitrum Sepolia', network: 'testnet', icon: 'ðŸ”·' },
            { id: 'SOLANA_MAINNET', name: 'Solana Mainnet', network: 'mainnet', icon: 'ðŸŒž' },
            { id: 'SOLANA_DEVNET', name: 'Solana Devnet', network: 'testnet', icon: 'ðŸŒž' }
        ];

        // Authentication check
        function checkAuth() {
            const isAdmin = sessionStorage.getItem('isAdminAuthenticated');
            if (isAdmin === 'true') {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                loadDashboard();
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch(`${API_BASE}/api/v1/admin?resource=login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    sessionStorage.setItem('isAdminAuthenticated', 'true');
                    sessionStorage.setItem('adminToken', data.token);
                    checkAuth();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('isAdminAuthenticated');
            sessionStorage.removeItem('adminToken');
            window.location.reload();
        });

        // Get auth header for API calls
        function getAuthHeader() {
            const token = sessionStorage.getItem('adminToken');
            return token ? `Bearer ${token}` : '';
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-blue-500', 'text-blue-400');
                    b.classList.add('border-transparent', 'text-slate-400');
                });
                btn.classList.add('border-blue-500', 'text-blue-400');
                btn.classList.remove('border-transparent', 'text-slate-400');

                // Update content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tab + 'Tab').classList.remove('hidden');

                // Load data when switching tabs
                if (tab === 'wallets') loadPlatformWallets();
                if (tab === 'billing') loadBillingData();
                if (tab === 'refunds') loadRefunds();
                if (tab === 'receipts') loadReceipts();
            });
        });

        // Load dashboard data
        async function loadDashboard() {
            await Promise.all([
                loadMerchants(),
                loadOrders(),
                loadPlatformWallets(),
                loadBillingData()
            ]);
            updateStats();
        }

        // Load merchants
        async function loadMerchants() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin?resource=merchants`, {
                    headers: { 'Authorization': getAuthHeader() }
                });

                if (response.ok) {
                    merchants = await response.json();
                    renderMerchants();
                    populateMerchantFilter();
                } else {
                    // Fallback - show mock data if API not ready
                    merchants = [];
                    renderMerchants();
                }
            } catch (error) {
                console.error('Error loading merchants:', error);
                merchants = [];
                renderMerchants();
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin?resource=orders`, { headers: { 'Authorization': getAuthHeader() } });
                console.log('Orders response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Orders data received:', data);
                    // Handle both array response and { orders: [...] } response
                    orders = Array.isArray(data) ? data : (data.orders || []);
                    console.log('Orders array:', orders.length, 'orders');
                    renderOrders();
                } else {
                    const errorText = await response.text();
                    console.error('Orders API error:', response.status, errorText);
                    orders = [];
                    renderOrders();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                orders = [];
                renderOrders();
            }
        }

        // Render merchants table
        function renderMerchants() {
            const tbody = document.getElementById('merchantsTableBody');

            if (merchants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-slate-400">
                            No merchants yet. Click "Add Merchant" to create your first customer account.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = merchants.map(m => `
                <tr class="hover:bg-slate-950">
                    <td class="px-6 py-4">
                        <div class="font-medium text-white">${m.companyName}</div>
                        <div class="text-sm text-slate-400">${m.email}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-white">${m.contactName}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs  font-medium plan-${(m.plan || 'starter').toLowerCase()}">
                            ${m.plan || 'Starter'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs  font-medium status-${m.isActive ? 'active' : 'inactive'}">
                            ${m.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-white">${m.orderCount || 0}</td>
                    <td class="px-6 py-4 text-sm font-medium text-white">$${(m.totalVolume || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 text-sm text-slate-400">${new Date(m.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-right text-sm">
                        <button onclick="viewMerchantDetail('${m.id}')" class="text-blue-400 hover:text-blue-300 mr-3">View</button>
                        <button onclick="editMerchant('${m.id}')" class="text-green-400 hover:text-green-300 mr-3">Edit</button>
                        <button onclick="toggleMerchantStatus('${m.id}')" class="text-orange-600 hover:text-orange-500 mr-3">
                            ${m.isActive ? 'Disable' : 'Activate'}
                        </button>
                        <button onclick="deleteMerchant('${m.id}')" class="text-red-600 hover:text-red-400">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Render orders table
        function renderOrders(filteredOrders = null) {
            const tbody = document.getElementById('ordersTableBody');
            const data = filteredOrders || orders;

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-8 text-center text-slate-400">
                            No orders found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(o => {
                const feePercent = Number(o.feePercent) || 0.5;
                const feeAmount = Number(o.feeAmount) || 0;
                const showFee = o.status === 'CONFIRMED';

                return `
                <tr class="hover:bg-slate-950">
                    <td class="px-4 py-4 font-mono text-sm text-white">${o.id.substring(0, 8)}...</td>
                    <td class="px-4 py-4 text-sm text-white">
                        ${o.merchant?.companyName || 'Demo/Unassigned'}
                    </td>
                    <td class="px-4 py-4 text-sm font-medium text-white">$${Number(o.amount).toFixed(2)}</td>
                    <td class="px-4 py-4 text-sm text-slate-400">${feePercent.toFixed(2)}%</td>
                    <td class="px-4 py-4 text-sm ${showFee ? 'text-green-400 font-medium' : 'text-slate-500'}">
                        ${showFee ? '$' + feeAmount.toFixed(4) : '-'}
                    </td>
                    <td class="px-4 py-4 text-sm text-slate-400">${o.chain}</td>
                    <td class="px-4 py-4">
                        <span class="px-2 py-1 text-xs font-medium status-${o.status.toLowerCase()}">
                            ${o.status}
                        </span>
                    </td>
                    <td class="px-4 py-4 text-sm text-slate-400">${new Date(o.createdAt).toLocaleString()}</td>
                    <td class="px-4 py-4 text-right text-sm">
                        ${o.status === 'PENDING' || o.status === 'PAID' ? `
                            <button onclick="confirmOrder('${o.id}')" class="text-green-400 hover:text-green-300 mr-2">
                                Confirm
                            </button>
                        ` : ''}
                        ${o.status === 'CONFIRMED' ? `
                            <span class="text-slate-500">Completed</span>
                        ` : ''}
                    </td>
                </tr>
            `}).join('');
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalMerchants').textContent = merchants.length;
            document.getElementById('activeMerchants').textContent = merchants.filter(m => m.isActive).length;
            document.getElementById('totalOrders').textContent = orders.length;

            const confirmedOrders = orders.filter(o => o.status === 'CONFIRMED');

            const totalVolume = confirmedOrders
                .reduce((sum, o) => sum + parseFloat(o.amount), 0);
            document.getElementById('totalVolume').textContent = `$${totalVolume.toFixed(2)}`;

            const totalFees = confirmedOrders
                .reduce((sum, o) => sum + parseFloat(o.feeAmount || 0), 0);
            document.getElementById('totalFeesEarned').textContent = `$${totalFees.toFixed(2)}`;
        }

        // Manually confirm an order (for testing without blockchain detection)
        window.confirmOrder = async function(orderId) {
            // Prompt for transaction hash
            const txHash = prompt(
                'Enter the transaction hash (tx ID) to confirm this order:\n\n' +
                'You can find this in the blockchain explorer or wallet transaction history.\n' +
                'Example: 0x1234...abcd\n\n' +
                'Leave empty to confirm without tx hash (not recommended):'
            );

            if (txHash === null) {
                return; // User cancelled
            }

            if (!txHash && !confirm('No transaction hash provided. Are you sure you want to confirm without blockchain verification?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/orders/${orderId}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        txHash: txHash || undefined,
                        confirmations: 1
                    })
                });

                if (response.ok) {
                    alert('Order confirmed successfully!');
                    loadDashboard(); // Refresh data
                } else {
                    const error = await response.json();
                    alert('Error confirming order: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error confirming order:', error);
                alert('Error confirming order: ' + error.message);
            }
        };

        // Populate merchant filter
        function populateMerchantFilter() {
            const select = document.getElementById('merchantFilter');
            select.innerHTML = '<option value="">All Merchants</option>' +
                merchants.map(m => `<option value="${m.id}">${m.companyName}</option>`).join('');

            select.addEventListener('change', (e) => {
                const merchantId = e.target.value;
                if (merchantId) {
                    const filtered = orders.filter(o => o.merchantId === merchantId);
                    renderOrders(filtered);
                } else {
                    renderOrders();
                }
            });
        }

        // Add merchant modal
        document.getElementById('addMerchantBtn').addEventListener('click', () => {
            document.getElementById('addMerchantModal').classList.remove('hidden');
        });

        document.getElementById('cancelAddMerchant').addEventListener('click', () => {
            document.getElementById('addMerchantModal').classList.add('hidden');
        });

        document.getElementById('addMerchantForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const merchantData = {
                companyName: document.getElementById('companyName').value,
                contactName: document.getElementById('contactName').value,
                email: document.getElementById('merchantEmail').value,
                website: document.getElementById('website').value,
                plan: document.getElementById('plan').value,
                networkMode: document.getElementById('networkMode').value,
                industry: document.getElementById('industry').value,
                notes: document.getElementById('notes').value,
                isActive: true
            };

            try {
                const response = await fetch(`${API_BASE}/api/v1/admin?resource=merchants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify(merchantData)
                });

                if (response.ok) {
                    alert('Merchant created successfully!');
                    document.getElementById('addMerchantModal').classList.add('hidden');
                    document.getElementById('addMerchantForm').reset();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to create merchant'));
                }
            } catch (error) {
                console.error('Error creating merchant:', error);
                alert('Error: Failed to create merchant. API endpoint may not be available yet.');
            }
        });

        // View merchant details
        window.viewMerchant = function(merchantId) {
            const merchant = merchants.find(m => m.id === merchantId);
            if (!merchant) return;

            const merchantOrders = orders.filter(o => o.merchantId === merchantId);
            const totalRevenue = merchantOrders
                .filter(o => o.status === 'CONFIRMED')
                .reduce((sum, o) => sum + parseFloat(o.amount), 0);

            const content = `
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-sm font-medium text-slate-400 mb-1">Company</h3>
                        <p class="text-lg font-semibold">${merchant.companyName}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-slate-400 mb-1">Contact</h3>
                        <p class="text-lg">${merchant.contactName}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-slate-400 mb-1">Email</h3>
                        <p class="text-lg">${merchant.email}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-slate-400 mb-1">Plan</h3>
                        <p class="text-lg">${merchant.plan || 'Starter'}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-slate-400 mb-1">Total Orders</h3>
                        <p class="text-lg font-semibold">${merchantOrders.length}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-slate-400 mb-1">Total Revenue</h3>
                        <p class="text-lg font-semibold text-green-400">$${totalRevenue.toFixed(2)}</p>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <button onclick="window.location.href='/dashboard.html?merchantId=${merchant.id}'" class="w-full bg-blue-600 text-white py-2 border hover:bg-blue-700">
                        View Merchant Dashboard
                    </button>
                </div>
            `;

            document.getElementById('detailMerchantName').textContent = merchant.companyName;
            document.getElementById('merchantDetailsContent').innerHTML = content;
            document.getElementById('merchantDetailsModal').classList.remove('hidden');
        };

        document.getElementById('closeMerchantDetails').addEventListener('click', () => {
            document.getElementById('merchantDetailsModal').classList.add('hidden');
        });

        window.viewMerchantOrders = function(merchantId) {
            document.querySelector('[data-tab="orders"]').click();
            document.getElementById('merchantFilter').value = merchantId;
            document.getElementById('merchantFilter').dispatchEvent(new Event('change'));
        };

        // Edit merchant
        window.editMerchant = async function(merchantId) {
            const merchant = merchants.find(m => m.id === merchantId);
            if (!merchant) return;

            document.getElementById('editMerchantId').value = merchant.id;
            document.getElementById('editCompanyName').value = merchant.companyName;
            document.getElementById('editContactName').value = merchant.contactName;
            document.getElementById('editEmail').value = merchant.email;
            document.getElementById('editWebsite').value = merchant.website || '';
            document.getElementById('editPlan').value = merchant.plan || '';
            document.getElementById('editNetworkMode').value = merchant.networkMode || 'TESTNET';
            document.getElementById('editIndustry').value = merchant.industry || '';
            document.getElementById('editIsActive').value = merchant.isActive.toString();
            document.getElementById('editNotes').value = merchant.notes || '';

            // Load wallets and render chain toggles
            await loadMerchantWallets(merchantId);
            renderChainToggles(merchantId);

            document.getElementById('editMerchantModal').classList.remove('hidden');
        };

        // Load merchant wallets
        async function loadMerchantWallets(merchantId) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin?resource=wallets&merchantId=${merchantId}`, {
                    headers: { 'Authorization': getAuthHeader() }
                });
                if (response.ok) {
                    merchantWallets[merchantId] = await response.json();
                } else {
                    merchantWallets[merchantId] = [];
                }
            } catch (error) {
                merchantWallets[merchantId] = [];
            }
        }

        // Render chain toggles with wallet inputs
        function renderChainToggles(merchantId) {
            const wallets = merchantWallets[merchantId] || [];
            const container = document.getElementById('editChainToggles');

            container.innerHTML = CHAINS.map(chain => {
                const wallet = wallets.find(w => w.chain === chain.id);
                const isEnabled = !!wallet;
                const address = wallet?.address || '';

                return `
                    <div class="bg-slate-950 border p-4 border border-slate-800 hover:border-slate-800 transition">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${chain.icon}</span>
                                <div>
                                    <div class="font-medium text-white">${chain.name}</div>
                                    <div class="text-xs text-slate-400">${chain.network}</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox"
                                       class="sr-only peer chain-toggle"
                                       data-chain="${chain.id}"
                                       ${isEnabled ? 'checked' : ''}
                                       onchange="toggleChainInput('${chain.id}')">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300  peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-950 after:border-slate-800 after:border after: after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div id="wallet-input-${chain.id}" class="${isEnabled ? '' : 'hidden'} mt-2">
                            <input type="text"
                                   class="w-full px-3 py-2 text-sm bg-black border border-slate-800 text-white font-mono"
                                   placeholder="0x... or wallet address"
                                   data-wallet-chain="${chain.id}"
                                   value="${address}">
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle chain wallet input visibility
        window.toggleChainInput = function(chainId) {
            const input = document.getElementById(`wallet-input-${chainId}`);
            const checkbox = document.querySelector(`input[data-chain="${chainId}"]`);

            if (checkbox.checked) {
                input.classList.remove('hidden');
            } else {
                input.classList.add('hidden');
                // Clear the input when disabled
                const walletInput = input.querySelector('input');
                if (walletInput) walletInput.value = '';
            }
        };

        document.getElementById('editMerchantForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const merchantId = document.getElementById('editMerchantId').value;
            const updateData = {
                merchantId,
                companyName: document.getElementById('editCompanyName').value,
                contactName: document.getElementById('editContactName').value,
                email: document.getElementById('editEmail').value,
                website: document.getElementById('editWebsite').value || null,
                plan: document.getElementById('editPlan').value || null,
                networkMode: document.getElementById('editNetworkMode').value,
                industry: document.getElementById('editIndustry').value || null,
                isActive: document.getElementById('editIsActive').value === 'true',
                notes: document.getElementById('editNotes').value || null
            };

            // Collect wallet configurations
            const wallets = [];
            document.querySelectorAll('.chain-toggle').forEach(toggle => {
                if (toggle.checked) {
                    const chain = toggle.dataset.chain;
                    const addressInput = document.querySelector(`input[data-wallet-chain="${chain}"]`);
                    const address = addressInput?.value.trim();

                    if (address) {
                        wallets.push({ chain, address });
                    }
                }
            });

            try {
                // Update merchant info
                const response = await fetch(`${API_BASE}/api/v1/admin?resource=merchants`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update merchant');
                }

                // Update wallets
                const walletsResponse = await fetch(`${API_BASE}/api/v1/admin?resource=wallets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ merchantId, wallets })
                });

                if (!walletsResponse.ok) {
                    const error = await walletsResponse.json();
                    throw new Error(error.error || 'Failed to update wallets');
                }

                alert('Merchant and wallets updated successfully!');
                document.getElementById('editMerchantModal').classList.add('hidden');
                loadDashboard();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('cancelEditMerchant').addEventListener('click', () => {
            document.getElementById('editMerchantModal').classList.add('hidden');
        });

        // Delete merchant
        let merchantToDelete = null;

        window.deleteMerchant = function(merchantId) {
            const merchant = merchants.find(m => m.id === merchantId);
            if (!merchant) return;

            merchantToDelete = merchantId;
            document.getElementById('deleteMerchantName').textContent = merchant.companyName;
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        };

        document.getElementById('confirmDelete').addEventListener('click', async () => {
            if (!merchantToDelete) return;

            try {
                const response = await fetch(`${API_BASE}/api/v1/admin?resource=merchants`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ merchantId: merchantToDelete })
                });

                if (response.ok) {
                    alert('Merchant deleted successfully');
                    document.getElementById('deleteConfirmModal').classList.add('hidden');
                    merchantToDelete = null;
                    loadDashboard();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to delete merchant'));
                }
            } catch (error) {
                alert('Error deleting merchant: ' + error.message);
            }
        });

        document.getElementById('cancelDelete').addEventListener('click', () => {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            merchantToDelete = null;
        });

        // View merchant details
        window.viewMerchantDetail = async function(merchantId) {
            const merchant = merchants.find(m => m.id === merchantId);
            if (!merchant) return;

            // Set basic info
            document.getElementById('detailMerchantName').textContent = merchant.companyName;
            document.getElementById('detailMerchantEmail').textContent = merchant.email;

            // Profile info
            document.getElementById('detailProfile').innerHTML = `
                <div>
                    <div class="text-sm text-slate-400">Contact Name</div>
                    <div class="font-medium">${merchant.contactName}</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400">Email</div>
                    <div class="font-medium">${merchant.email}</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400">Plan</div>
                    <div class="font-medium">${merchant.plan || 'None'}</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400">Network Mode</div>
                    <div class="font-medium">${merchant.networkMode || 'Testnet'}</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400">Status</div>
                    <div class="font-medium">
                        <span class="px-2 py-1 text-xs  ${merchant.isActive ? 'bg-green-900/20 text-green-400' : 'bg-slate-900/20 text-slate-300'}">
                            ${merchant.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                </div>
                <div>
                    <div class="text-sm text-slate-400">Setup Completed</div>
                    <div class="font-medium">${merchant.setupCompleted ? 'Yes' : 'No'}</div>
                </div>
                ${merchant.loginToken ? `
                <div class="col-span-2">
                    <div class="text-sm text-slate-400 mb-2">Login Token</div>
                    <div class="bg-black border border-slate-800 p-3 rounded">
                        <code class="text-sm text-blue-400 font-mono break-all">${merchant.loginToken}</code>
                    </div>
                    ${merchant.tokenExpiresAt ? `
                    <div class="text-xs text-slate-500 mt-1">
                        Expires: ${new Date(merchant.tokenExpiresAt).toLocaleDateString()}
                    </div>
                    ` : ''}
                    <div class="flex gap-2 mt-2">
                        <button onclick="navigator.clipboard.writeText('${window.location.origin}/login.html?email=${encodeURIComponent(merchant.email)}&token=${merchant.loginToken}'); alert('Login URL copied!');"
                                class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                            Copy Login URL
                        </button>
                        <button onclick="regenerateToken('${merchant.id}')"
                                class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded">
                            Regenerate Token
                        </button>
                    </div>
                </div>
                ` : `
                <div class="col-span-2">
                    <div class="text-sm text-slate-400">Login Token</div>
                    <div class="text-slate-500 mb-2">Not generated yet</div>
                    <button onclick="regenerateToken('${merchant.id}')"
                            class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                        Generate Token
                    </button>
                </div>
                `}
                ${merchant.website ? `
                <div>
                    <div class="text-sm text-slate-400">Website</div>
                    <div class="font-medium"><a href="${merchant.website}" target="_blank" class="text-blue-400 hover:underline">${merchant.website}</a></div>
                </div>
                ` : ''}
                ${merchant.industry ? `
                <div>
                    <div class="text-sm text-slate-400">Industry</div>
                    <div class="font-medium">${merchant.industry}</div>
                </div>
                ` : ''}
                ${merchant.notes ? `
                <div class="col-span-2">
                    <div class="text-sm text-slate-400">Notes</div>
                    <div class="font-medium">${merchant.notes}</div>
                </div>
                ` : ''}
            `;

            // Fetch and display wallets
            try {
                const walletsResponse = await fetch(`${API_BASE}/api/v1/admin?resource=wallets&merchantId=${merchantId}`, {
                    headers: { 'Authorization': getAuthHeader() }
                });

                if (walletsResponse.ok) {
                    const wallets = await walletsResponse.json();
                    if (wallets.length > 0) {
                        document.getElementById('detailWallets').innerHTML = wallets.map(w => `
                            <div class="flex justify-between items-center p-3 bg-slate-950 rounded border">
                                <div>
                                    <div class="font-mono text-sm font-medium">${w.address}</div>
                                    <div class="text-xs text-slate-400">${w.chain}</div>
                                </div>
                                <span class="px-2 py-1 text-xs rounded ${w.isActive ? 'bg-green-900/20 text-green-400' : 'bg-slate-900/20 text-slate-300'}">
                                    ${w.isActive ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('detailWallets').innerHTML = '<p class="text-slate-400 text-sm">No wallets configured yet</p>';
                    }
                } else {
                    document.getElementById('detailWallets').innerHTML = '<p class="text-slate-400 text-sm">Failed to load wallets</p>';
                }
            } catch (error) {
                document.getElementById('detailWallets').innerHTML = '<p class="text-slate-400 text-sm">No wallets configured yet</p>';
            }

            // Display orders
            const merchantOrders = orders.filter(o => o.merchantId === merchantId);
            if (merchantOrders.length > 0) {
                document.getElementById('detailOrders').innerHTML = `
                    <table class="w-full text-sm">
                        <thead class="bg-slate-950 border-b">
                            <tr>
                                <th class="px-3 py-2 text-left">Order ID</th>
                                <th class="px-3 py-2 text-left">Amount</th>
                                <th class="px-3 py-2 text-left">Chain</th>
                                <th class="px-3 py-2 text-left">Status</th>
                                <th class="px-3 py-2 text-left">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${merchantOrders.slice(0, 10).map(o => `
                                <tr class="border-b">
                                    <td class="px-3 py-2 font-mono">${o.id.substring(0, 8)}...</td>
                                    <td class="px-3 py-2 font-medium">${o.amount} USDC</td>
                                    <td class="px-3 py-2">${o.chain}</td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-1 text-xs  ${o.status === 'CONFIRMED' ? 'bg-green-900/20 text-green-400' : 'bg-yellow-900/20 text-yellow-400'}">
                                            ${o.status}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-slate-400">${new Date(o.createdAt).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                document.getElementById('detailOrders').innerHTML = '<p class="text-slate-400 text-sm">No orders yet</p>';
            }

            // Analytics
            const totalOrders = merchantOrders.length;
            const totalVolume = merchantOrders
                .filter(o => o.status === 'CONFIRMED')
                .reduce((sum, o) => sum + parseFloat(o.amount), 0);
            const avgOrder = totalOrders > 0 ? totalVolume / totalOrders : 0;

            document.getElementById('detailTotalOrders').textContent = totalOrders;
            document.getElementById('detailTotalVolume').textContent = `$${totalVolume.toFixed(2)}`;
            document.getElementById('detailAvgOrder').textContent = `$${avgOrder.toFixed(2)}`;

            // Show modal
            document.getElementById('merchantDetailsModal').classList.remove('hidden');
        };

        document.getElementById('closeMerchantDetails').addEventListener('click', () => {
            document.getElementById('merchantDetailsModal').classList.add('hidden');
        });

        // Toggle merchant status
        window.toggleMerchantStatus = async function(merchantId) {
            const merchant = merchants.find(m => m.id === merchantId);
            if (!merchant) return;

            const action = merchant.isActive ? 'disable' : 'activate';
            if (!confirm(`Are you sure you want to ${action} ${merchant.companyName}?`)) return;

            try {
                const response = await fetch(`${API_BASE}/api/v1/admin?resource=merchants`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({
                        merchantId,
                        isActive: !merchant.isActive
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    // If activating and a login token was generated, show it to the admin
                    if (action === 'activate' && result.loginToken) {
                        const loginUrl = `${window.location.origin}/login.html?email=${encodeURIComponent(merchant.email)}&token=${result.loginToken}`;

                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        modal.innerHTML = `
                            <div class="bg-slate-950 border shadow-2xl p-8 max-w-2xl w-full mx-4">
                                <h2 class="text-2xl font-bold text-white mb-4">Merchant Activated!</h2>
                                <p class="text-slate-300 mb-6">Send this login link to ${merchant.email}:</p>

                                <div class="bg-black border border-slate-800 p-4 mb-4">
                                    <div class="text-xs text-slate-400 mb-2">Login URL:</div>
                                    <code class="text-sm text-green-400 break-all">${loginUrl}</code>
                                </div>

                                <div class="bg-black border border-slate-800 p-4 mb-6">
                                    <div class="text-xs text-slate-400 mb-2">Login Token:</div>
                                    <code class="text-sm text-blue-400 font-mono">${result.loginToken}</code>
                                </div>

                                <div class="flex space-x-3">
                                    <button onclick="navigator.clipboard.writeText('${loginUrl}'); alert('Login URL copied!');"
                                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 transition-colors">
                                        Copy Login URL
                                    </button>
                                    <button onclick="this.closest('.fixed').remove(); loadDashboard();"
                                            class="flex-1 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 transition-colors">
                                        Close
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    } else {
                        alert(`Merchant ${action}d successfully!`);
                        loadDashboard();
                    }
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to update status'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        // Regenerate token
        window.regenerateToken = async function(merchantId) {
            const merchant = merchants.find(m => m.id === merchantId);
            if (!merchant) return;

            if (!confirm(`Generate a new login token for ${merchant.email}?\n\nThis will invalidate the old token if one exists.`)) return;

            try {
                // Call the same activate endpoint to regenerate token
                const response = await fetch(`${API_BASE}/api/v1/admin?resource=merchants`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({
                        merchantId,
                        regenerateToken: true // Force token regeneration
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.loginToken) {
                        const loginUrl = `${window.location.origin}/login.html?email=${encodeURIComponent(merchant.email)}&token=${result.loginToken}`;

                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        modal.innerHTML = `
                            <div class="bg-slate-950 border shadow-2xl p-8 max-w-2xl w-full mx-4">
                                <h2 class="text-2xl font-bold text-white mb-4">New Login Token Generated</h2>
                                <p class="text-slate-300 mb-6">Send this new login link to ${merchant.email}:</p>

                                <div class="bg-black border border-slate-800 p-4 mb-4">
                                    <div class="text-xs text-slate-400 mb-2">Login URL:</div>
                                    <code class="text-sm text-green-400 break-all">${loginUrl}</code>
                                </div>

                                <div class="bg-black border border-slate-800 p-4 mb-6">
                                    <div class="text-xs text-slate-400 mb-2">Login Token:</div>
                                    <code class="text-sm text-blue-400 font-mono">${result.loginToken}</code>
                                </div>

                                <div class="flex space-x-3">
                                    <button onclick="navigator.clipboard.writeText('${loginUrl}'); alert('Login URL copied!');"
                                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 transition-colors">
                                        Copy Login URL
                                    </button>
                                    <button onclick="this.closest('.fixed').remove(); loadDashboard();"
                                            class="flex-1 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 transition-colors">
                                        Close
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    } else {
                        alert('Token generated successfully!');
                        loadDashboard();
                    }
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to generate token'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        // System Settings
        function loadSystemSettings() {
            const showPaymentPlans = localStorage.getItem('showPaymentPlans') !== 'false';
            const enableInvoices = localStorage.getItem('enableInvoices') === 'true';
            document.getElementById('showPaymentPlans').checked = showPaymentPlans;
            document.getElementById('enableInvoices').checked = enableInvoices;
        }

        document.getElementById('saveSystemSettings')?.addEventListener('click', () => {
            const showPaymentPlans = document.getElementById('showPaymentPlans').checked;
            const enableInvoices = document.getElementById('enableInvoices').checked;
            localStorage.setItem('showPaymentPlans', showPaymentPlans.toString());
            localStorage.setItem('enableInvoices', enableInvoices.toString());
            alert('System settings saved! Changes will apply when merchants reload their dashboards.');
        });

        // =====================
        // Platform Wallets
        // =====================

        // Load platform wallets
        async function loadPlatformWallets() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/platform-wallets`, {
                    headers: { 'Authorization': getAuthHeader() }
                });

                if (response.ok) {
                    platformWallets = await response.json();
                    renderPlatformWallets();
                } else {
                    platformWallets = [];
                    renderPlatformWallets();
                }
            } catch (error) {
                console.error('Error loading platform wallets:', error);
                platformWallets = [];
                renderPlatformWallets();
            }
        }

        // Render platform wallets table
        function renderPlatformWallets() {
            const tbody = document.getElementById('walletsTableBody');

            if (!platformWallets || platformWallets.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-slate-400">
                            No platform wallets configured yet. Click "Add Wallet" to add your first fee collection wallet.
                        </td>
                    </tr>
                `;
                return;
            }

            const chainIcons = {
                'BASE_SEPOLIA': 'ðŸ”µ',
                'BASE_MAINNET': 'ðŸ”µ',
                'ETHEREUM_SEPOLIA': 'âŸ ',
                'ETHEREUM_MAINNET': 'âŸ ',
                'POLYGON_MAINNET': 'ðŸŸ£',
                'POLYGON_MUMBAI': 'ðŸŸ£',
                'ARBITRUM_MAINNET': 'ðŸ”·',
                'ARBITRUM_SEPOLIA': 'ðŸ”·',
                'SOLANA_MAINNET': 'ðŸŒž',
                'SOLANA_DEVNET': 'ðŸŒž'
            };

            const chainNames = {
                'BASE_SEPOLIA': 'Base Sepolia',
                'BASE_MAINNET': 'Base Mainnet',
                'ETHEREUM_SEPOLIA': 'Ethereum Sepolia',
                'ETHEREUM_MAINNET': 'Ethereum Mainnet',
                'POLYGON_MAINNET': 'Polygon Mainnet',
                'POLYGON_MUMBAI': 'Polygon Mumbai',
                'ARBITRUM_MAINNET': 'Arbitrum Mainnet',
                'ARBITRUM_SEPOLIA': 'Arbitrum Sepolia',
                'SOLANA_MAINNET': 'Solana Mainnet',
                'SOLANA_DEVNET': 'Solana Devnet'
            };

            tbody.innerHTML = platformWallets.map(w => `
                <tr class="hover:bg-slate-950">
                    <td class="px-6 py-4">
                        <span class="mr-2">${chainIcons[w.chain] || 'ðŸ”—'}</span>
                        <span class="font-medium text-white">${chainNames[w.chain] || w.chain}</span>
                    </td>
                    <td class="px-6 py-4 font-mono text-sm text-slate-300">
                        <span title="${w.address}">${w.address.substring(0, 10)}...${w.address.substring(w.address.length - 8)}</span>
                        <button onclick="navigator.clipboard.writeText('${w.address}'); alert('Address copied!');" class="ml-2 text-blue-400 hover:text-blue-300 text-xs">Copy</button>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-400">${w.label || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium ${w.isActive ? 'bg-green-900/20 text-green-400' : 'bg-slate-900/20 text-slate-400'}">
                            ${w.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-400">${new Date(w.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-right text-sm">
                        <button onclick="editPlatformWallet('${w.chain}')" class="text-blue-400 hover:text-blue-300 mr-3">Edit</button>
                        ${w.isActive
                            ? `<button onclick="deactivatePlatformWallet('${w.chain}')" class="text-orange-400 hover:text-orange-300">Deactivate</button>`
                            : `<button onclick="activatePlatformWallet('${w.chain}', '${w.address}')" class="text-green-400 hover:text-green-300">Activate</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        // Show add wallet modal
        document.getElementById('addWalletBtn')?.addEventListener('click', () => {
            document.getElementById('walletModalTitle').textContent = 'Add Platform Wallet';
            document.getElementById('walletChain').value = '';
            document.getElementById('walletChain').disabled = false;
            document.getElementById('walletAddress').value = '';
            document.getElementById('walletLabel').value = '';
            document.getElementById('walletModal').classList.remove('hidden');
        });

        // Cancel wallet modal
        document.getElementById('cancelWallet')?.addEventListener('click', () => {
            document.getElementById('walletModal').classList.add('hidden');
        });

        // Edit platform wallet
        window.editPlatformWallet = function(chain) {
            const wallet = platformWallets.find(w => w.chain === chain);
            if (!wallet) return;

            document.getElementById('walletModalTitle').textContent = 'Edit Platform Wallet';
            document.getElementById('walletChain').value = wallet.chain;
            document.getElementById('walletChain').disabled = true;
            document.getElementById('walletAddress').value = wallet.address;
            document.getElementById('walletLabel').value = wallet.label || '';
            document.getElementById('walletModal').classList.remove('hidden');
        };

        // Save platform wallet (add or update)
        document.getElementById('walletForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const chain = document.getElementById('walletChain').value;
            const address = document.getElementById('walletAddress').value.trim();
            const label = document.getElementById('walletLabel').value.trim();

            if (!chain || !address) {
                alert('Please fill in all required fields');
                return;
            }

            // Basic address validation
            if (!address.startsWith('0x') || address.length !== 42) {
                alert('Please enter a valid Ethereum address (0x followed by 40 hex characters)');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/platform-wallets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ chain, address, label: label || null })
                });

                if (response.ok) {
                    document.getElementById('walletModal').classList.add('hidden');
                    await loadPlatformWallets();
                    alert('Platform wallet saved successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save wallet'));
                }
            } catch (error) {
                console.error('Error saving wallet:', error);
                alert('Error: ' + error.message);
            }
        });

        // Deactivate platform wallet
        window.deactivatePlatformWallet = async function(chain) {
            if (!confirm(`Are you sure you want to deactivate the ${chain} wallet? Merchants will no longer be able to pay fees on this chain.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/platform-wallets/${chain}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': getAuthHeader() }
                });

                if (response.ok) {
                    await loadPlatformWallets();
                    alert('Wallet deactivated successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to deactivate wallet'));
                }
            } catch (error) {
                console.error('Error deactivating wallet:', error);
                alert('Error: ' + error.message);
            }
        };

        // Re-activate platform wallet
        window.activatePlatformWallet = async function(chain, address) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/platform-wallets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ chain, address, isActive: true })
                });

                if (response.ok) {
                    await loadPlatformWallets();
                    alert('Wallet activated successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to activate wallet'));
                }
            } catch (error) {
                console.error('Error activating wallet:', error);
                alert('Error: ' + error.message);
            }
        };

        // ============================================
        // BILLING & FEES FUNCTIONS
        // ============================================

        let feePayments = [];

        async function loadBillingData() {
            try {
                // Load admin stats
                const statsResponse = await fetch(`${API_BASE}/api/v1/admin/stats`, {
                    headers: {
                        'Authorization': getAuthHeader(),
                        'x-admin-key': sessionStorage.getItem('adminToken')
                    }
                });

                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('totalFeesOwed').textContent = '$' + Number(stats.fees?.totalOwed || 0).toFixed(2);
                    document.getElementById('pendingPayments').textContent = stats.fees?.pendingPayments || 0;
                    document.getElementById('totalCollected').textContent = '$' + Number(stats.fees?.totalCollected || 0).toFixed(2);
                }

                // Load pending fee payments
                const paymentsResponse = await fetch(`${API_BASE}/api/v1/admin/fee-payments?status=PENDING`, {
                    headers: {
                        'Authorization': getAuthHeader(),
                        'x-admin-key': sessionStorage.getItem('adminToken')
                    }
                });

                if (paymentsResponse.ok) {
                    const data = await paymentsResponse.json();
                    feePayments = data.payments || [];
                    renderPendingPayments();
                }

                // Render merchants with fees from existing merchants data
                renderMerchantFees();

            } catch (error) {
                console.error('Error loading billing data:', error);
            }
        }

        function renderMerchantFees() {
            const tbody = document.getElementById('merchantFeesTableBody');
            if (!tbody) return;

            // Filter merchants with fees due or suspended
            const merchantsWithFees = merchants.filter(m => (m.feesDue && Number(m.feesDue) > 0) || m.isSuspended);

            if (merchantsWithFees.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-slate-400">
                            No merchants with outstanding fees
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = merchantsWithFees.map(m => {
                const feesDue = Number(m.feesDue || 0);
                return `
                <tr class="hover:bg-slate-900/50">
                    <td class="px-6 py-4">
                        <div class="font-medium text-white">${m.companyName}</div>
                        <div class="text-sm text-slate-400">${m.email}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium bg-slate-800 text-slate-300 rounded">${m.plan || 'STARTER'}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-lg font-bold ${feesDue > 0 ? 'text-yellow-400' : 'text-green-400'}">
                            $${feesDue.toFixed(2)}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        ${m.isSuspended
                            ? '<span class="px-2 py-1 text-xs font-medium bg-red-900/50 text-red-400 rounded">Suspended</span>'
                            : feesDue > 0
                                ? '<span class="px-2 py-1 text-xs font-medium bg-yellow-900/50 text-yellow-400 rounded">Due</span>'
                                : '<span class="px-2 py-1 text-xs font-medium bg-green-900/50 text-green-400 rounded">Paid</span>'
                        }
                    </td>
                    <td class="px-6 py-4 text-slate-400 text-sm">
                        ${m.lastFeeCalculation ? new Date(m.lastFeeCalculation).toLocaleDateString() : 'Never'}
                    </td>
                </tr>
            `}).join('');
        }

        function renderPendingPayments() {
            const tbody = document.getElementById('pendingPaymentsTableBody');
            if (!tbody) return;

            if (feePayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-slate-400">
                            No pending fee payments to review
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = feePayments.map(p => `
                <tr class="hover:bg-slate-900/50">
                    <td class="px-6 py-4">
                        <div class="font-medium text-white">${p.merchant?.companyName || 'Unknown'}</div>
                        <div class="text-sm text-slate-400">${p.merchant?.email || ''}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-lg font-bold text-green-400">$${Number(p.amount).toFixed(2)}</span>
                        <div class="text-xs text-slate-400">${p.token || 'USDC'}</div>
                    </td>
                    <td class="px-6 py-4 text-slate-300">${p.chain}</td>
                    <td class="px-6 py-4">
                        <a href="https://basescan.org/tx/${p.txHash}" target="_blank"
                           class="text-blue-400 hover:text-blue-300 text-sm font-mono">
                            ${p.txHash ? p.txHash.slice(0, 10) + '...' : 'N/A'}
                        </a>
                    </td>
                    <td class="px-6 py-4 text-slate-400 text-sm">
                        ${new Date(p.createdAt).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button onclick="verifyPayment('${p.id}')"
                                class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded">
                            Verify
                        </button>
                        <button onclick="rejectPayment('${p.id}')"
                                class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded">
                            Reject
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.verifyPayment = async function(paymentId) {
            if (!confirm('Verify this payment? This will credit the merchant account.')) return;

            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/fee-payments/${paymentId}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader(),
                        'x-admin-key': sessionStorage.getItem('adminToken')
                    }
                });

                if (response.ok) {
                    alert('Payment verified successfully!');
                    await loadBillingData();
                    await loadMerchants();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to verify payment'));
                }
            } catch (error) {
                console.error('Error verifying payment:', error);
                alert('Error: ' + error.message);
            }
        };

        window.rejectPayment = async function(paymentId) {
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;

            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/fee-payments/${paymentId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader(),
                        'x-admin-key': sessionStorage.getItem('adminToken')
                    },
                    body: JSON.stringify({ reason })
                });

                if (response.ok) {
                    alert('Payment rejected');
                    await loadBillingData();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to reject payment'));
                }
            } catch (error) {
                console.error('Error rejecting payment:', error);
                alert('Error: ' + error.message);
            }
        };

        // Refresh
        document.getElementById('refreshBtn').addEventListener('click', loadDashboard);

        // ============================================================================
        // REFUNDS
        // ============================================================================
        let refunds = [];

        async function loadRefunds() {
            try {
                // Load stats and refunds in parallel
                const [statsRes, refundsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/v1/admin/refunds/stats`, {
                        headers: { 'Authorization': getAuthHeader(), 'x-admin-key': sessionStorage.getItem('adminToken') }
                    }),
                    fetch(`${API_BASE}/api/v1/admin/refunds`, {
                        headers: { 'Authorization': getAuthHeader(), 'x-admin-key': sessionStorage.getItem('adminToken') }
                    })
                ]);

                if (statsRes.ok) {
                    const stats = await statsRes.json();
                    document.getElementById('pendingRefundsCount').textContent = stats.pending || 0;
                    document.getElementById('totalRefunded').textContent = '$' + Number(stats.totalRefunded || 0).toFixed(2);
                    document.getElementById('rejectedRefundsCount').textContent = stats.rejected || 0;
                }

                if (refundsRes.ok) {
                    const data = await refundsRes.json();
                    refunds = data.refunds || [];
                    renderRefunds();
                }
            } catch (error) {
                console.error('Error loading refunds:', error);
            }
        }

        function renderRefunds() {
            const tbody = document.getElementById('refundsTableBody');
            if (!tbody) return;

            if (refunds.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-slate-400">
                            No refund requests found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = refunds.map(r => {
                const amount = Number(r.amount || 0);
                const orderAmount = Number(r.order?.amount || 0);
                const statusColors = {
                    PENDING: 'bg-yellow-900/50 text-yellow-400',
                    APPROVED: 'bg-blue-900/50 text-blue-400',
                    PROCESSED: 'bg-green-900/50 text-green-400',
                    REJECTED: 'bg-red-900/50 text-red-400'
                };
                const statusClass = statusColors[r.status] || 'bg-slate-800 text-slate-300';

                let actions = '';
                if (r.status === 'PENDING') {
                    actions = `
                        <button onclick="approveRefund('${r.id}')" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded mr-1">
                            Approve
                        </button>
                        <button onclick="rejectRefund('${r.id}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded">
                            Reject
                        </button>
                    `;
                } else if (r.status === 'APPROVED') {
                    actions = `
                        <button onclick="processRefund('${r.id}', '${r.order?.chain || ''}')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded">
                            Process
                        </button>
                    `;
                } else if (r.status === 'PROCESSED' && r.refundTxHash) {
                    const explorer = getExplorerUrl(r.order?.chain, r.refundTxHash);
                    actions = `<a href="${explorer}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm font-mono">${r.refundTxHash.slice(0, 10)}...</a>`;
                } else if (r.status === 'REJECTED') {
                    actions = '<span class="text-sm text-slate-500">Closed</span>';
                }

                return `
                <tr class="hover:bg-slate-900/50">
                    <td class="px-6 py-4">
                        <span class="text-sm font-mono text-slate-300">${r.orderId?.slice(0, 8)}...</span>
                        <div class="text-xs text-slate-500">$${orderAmount.toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-white">${r.order?.merchant?.companyName || 'Unknown'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-slate-300">${r.order?.customerEmail || 'N/A'}</div>
                        ${r.order?.transactions?.[0]?.fromAddress ? `<div class="text-xs text-slate-500 font-mono">${r.order.transactions[0].fromAddress.slice(0, 10)}...</div>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-lg font-bold text-white">$${amount.toFixed(2)}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-slate-400">${r.reason || '-'}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded ${statusClass}">${r.status}</span>
                    </td>
                    <td class="px-6 py-4 text-slate-400 text-sm">
                        ${new Date(r.createdAt).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 text-right">
                        ${actions}
                    </td>
                </tr>
                `;
            }).join('');
        }

        function getExplorerUrl(chain, txHash) {
            const explorers = {
                'BASE_MAINNET': 'https://basescan.org/tx/',
                'BASE_SEPOLIA': 'https://sepolia.basescan.org/tx/',
                'ETHEREUM_MAINNET': 'https://etherscan.io/tx/',
                'ETHEREUM_SEPOLIA': 'https://sepolia.etherscan.io/tx/',
                'POLYGON_MAINNET': 'https://polygonscan.com/tx/',
                'ARBITRUM_MAINNET': 'https://arbiscan.io/tx/',
            };
            const base = explorers[chain] || 'https://basescan.org/tx/';
            return base + txHash;
        }

        window.approveRefund = async function(refundId) {
            if (!confirm('Approve this refund? You will need to send the crypto manually next.')) return;
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/refunds/${refundId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader(),
                        'x-admin-key': sessionStorage.getItem('adminToken')
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    const wallet = data.customerWallet || 'Not available';
                    alert(`Refund approved!\n\nCustomer wallet: ${wallet}\n\nSend the refund amount to this wallet, then click "Process" to record the transaction hash.`);
                    await loadRefunds();
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.error || 'Failed to approve'));
                }
            } catch (error) {
                console.error('Error approving refund:', error);
                alert('Error: ' + error.message);
            }
        };

        window.rejectRefund = async function(refundId) {
            const reason = prompt('Enter rejection reason:');
            if (reason === null) return;
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/refunds/${refundId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader(),
                        'x-admin-key': sessionStorage.getItem('adminToken')
                    },
                    body: JSON.stringify({ reason })
                });
                if (response.ok) {
                    alert('Refund rejected.');
                    await loadRefunds();
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.error || 'Failed to reject'));
                }
            } catch (error) {
                console.error('Error rejecting refund:', error);
                alert('Error: ' + error.message);
            }
        };

        window.processRefund = async function(refundId, chain) {
            const txHash = prompt(`Enter the transaction hash for the refund you sent on ${chain || 'chain'}:`);
            if (!txHash) return;
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/refunds/${refundId}/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader(),
                        'x-admin-key': sessionStorage.getItem('adminToken')
                    },
                    body: JSON.stringify({ txHash })
                });
                if (response.ok) {
                    alert('Refund processed successfully! The order has been marked as REFUNDED.');
                    await loadRefunds();
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.error || 'Failed to process'));
                }
            } catch (error) {
                console.error('Error processing refund:', error);
                alert('Error: ' + error.message);
            }
        };

        // ============================================================================
        // RECEIPTS
        // ============================================================================
        let receipts = [];

        async function loadReceipts() {
            try {
                const [statsRes, receiptsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/v1/admin/receipts/stats`, {
                        headers: { 'Authorization': getAuthHeader(), 'x-admin-key': sessionStorage.getItem('adminToken') }
                    }),
                    fetch(`${API_BASE}/api/v1/admin/receipts`, {
                        headers: { 'Authorization': getAuthHeader(), 'x-admin-key': sessionStorage.getItem('adminToken') }
                    })
                ]);

                if (statsRes.ok) {
                    const stats = await statsRes.json();
                    document.getElementById('totalReceiptsCount').textContent = stats.total || 0;
                    document.getElementById('emailsSentCount').textContent = stats.sent || 0;
                    document.getElementById('emailsPendingCount').textContent = stats.pending || 0;
                }

                if (receiptsRes.ok) {
                    const data = await receiptsRes.json();
                    receipts = data.receipts || [];
                    renderReceipts();
                }
            } catch (error) {
                console.error('Error loading receipts:', error);
            }
        }

        function renderReceipts() {
            const tbody = document.getElementById('receiptsTableBody');
            if (!tbody) return;

            if (receipts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-slate-400">
                            No receipts found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = receipts.map(r => {
                const amount = Number(r.amount || 0);
                const emailColors = {
                    SENT: 'bg-green-900/50 text-green-400',
                    DELIVERED: 'bg-green-900/50 text-green-400',
                    PENDING: 'bg-yellow-900/50 text-yellow-400',
                    FAILED: 'bg-red-900/50 text-red-400'
                };
                const emailClass = emailColors[r.emailStatus] || 'bg-slate-800 text-slate-300';

                return `
                <tr class="hover:bg-slate-900/50">
                    <td class="px-6 py-4">
                        <span class="text-sm font-medium text-white">${r.receiptNumber}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm font-mono text-slate-300">${r.orderId?.slice(0, 8)}...</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-white">${r.customerName || r.customerEmail || 'N/A'}</div>
                        ${r.customerName && r.customerEmail ? `<div class="text-xs text-slate-400">${r.customerEmail}</div>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-lg font-bold text-white">$${amount.toFixed(2)}</span>
                        <div class="text-xs text-slate-500">${r.token || 'USDC'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-slate-300">${(r.chain || '').replace('_', ' ')}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded ${emailClass}">${r.emailStatus}</span>
                    </td>
                    <td class="px-6 py-4 text-slate-400 text-sm">
                        ${new Date(r.paymentDate || r.createdAt).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button onclick="downloadReceipt('${r.id}')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded">
                            PDF
                        </button>
                        ${r.customerEmail ? `
                        <button onclick="resendReceipt('${r.id}')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded">
                            Resend
                        </button>
                        ` : ''}
                    </td>
                </tr>
                `;
            }).join('');
        }

        window.downloadReceipt = function(receiptId) {
            window.open(`${API_BASE}/api/v1/receipts/${receiptId}/pdf`, '_blank');
        };

        window.resendReceipt = async function(receiptId) {
            if (!confirm('Resend receipt email to customer?')) return;
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/receipts/${receiptId}/resend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader(),
                        'x-admin-key': sessionStorage.getItem('adminToken')
                    }
                });
                if (response.ok) {
                    alert('Receipt email sent!');
                    await loadReceipts();
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.error || 'Failed to resend'));
                }
            } catch (error) {
                console.error('Error resending receipt:', error);
                alert('Error: ' + error.message);
            }
        };

        // i18n functionality
        let currentLang = localStorage.getItem('preferredLanguage') || 'en';
        let translations = {};

        async function loadTranslations(lang) {
            try {
                const response = await fetch(`./locales/enterprise-admin-${lang}.json`);
                translations = await response.json();
                applyTranslations();
            } catch (error) {
                console.error('Failed to load translations:', error);
            }
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const keys = key.split('.');
                let value = translations;

                for (const k of keys) {
                    value = value[k];
                    if (!value) break;
                }

                if (value) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = value;
                    } else {
                        element.textContent = value;
                    }
                }
            });
        }

        // Language selector
        const langSelector = document.getElementById('languageSelector');
        if (langSelector) {
            langSelector.addEventListener('change', (e) => {
                currentLang = e.target.value;
                localStorage.setItem('preferredLanguage', currentLang);
                loadTranslations(currentLang);
            });

            // Set initial language
            langSelector.value = currentLang;
            loadTranslations(currentLang);
        }

        // Day/Night mode toggle (dark mode is default, day mode is light)
        const nightModeToggle = document.getElementById('nightModeToggle');
        const dayIcon = nightModeToggle?.querySelector('.day-icon');
        const nightIcon = nightModeToggle?.querySelector('.night-icon');

        if (nightModeToggle) {
            // Check for saved preference (dayMode = light theme)
            const savedDayMode = localStorage.getItem('dayMode');
            if (savedDayMode === 'true') {
                document.body.classList.add('day-mode');
                if (dayIcon) dayIcon.classList.remove('hidden');
                if (nightIcon) nightIcon.classList.add('hidden');
            }

            nightModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('day-mode');
                const isDayMode = document.body.classList.contains('day-mode');

                // Toggle icons
                if (dayIcon) dayIcon.classList.toggle('hidden', !isDayMode);
                if (nightIcon) nightIcon.classList.toggle('hidden', isDayMode);

                localStorage.setItem('dayMode', isDayMode);
            });
        }

        // Initialize
        checkAuth();
        loadSystemSettings();
    </script>
</body>
</html>
