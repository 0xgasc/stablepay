<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Dashboard - StablePay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/chain-config.js"></script>
    <style>
        body {
            background: #0a0a0f;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        * {
            color: inherit;
        }
        .network-badge {
            background: linear-gradient(90deg, #f59e0b, #ef4444);
            animation: gradient 3s ease infinite;
            background-size: 400% 400%;
        }
        .mainnet-badge {
            background: linear-gradient(90deg, #059669, #0891b2);
            animation: gradient 3s ease infinite;
            background-size: 400% 400%;
        }
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .status-pending { @apply bg-yellow-900/20 text-yellow-400 border border-yellow-800; }
        .status-paid { @apply bg-blue-900/20 text-blue-400 border border-blue-800; }
        .status-confirmed { @apply bg-green-900/20 text-green-400 border border-green-800; }
        .status-failed { @apply bg-red-900/20 text-red-400 border border-red-800; }
        .status-expired { @apply bg-slate-900/20 text-slate-400 border border-slate-800; }
    </style>
</head>
<body class="bg-slate-950">

    <!-- Navigation -->

    <!-- Pending Account Banner -->
    <div id="pendingBanner" class="hidden bg-yellow-50 border-b-2 border-yellow-400">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">‚è≥</span>
                    <div>
                        <p class="font-semibold text-yellow-800">Account Pending Approval</p>
                        <p class="text-sm text-yellow-700">Your account is being reviewed. Full features will be enabled once activated by our team.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <nav class="bg-slate-950 shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        StablePay
                    </a>
                    <span class="ml-4 px-3 py-1 bg-blue-900/20 text-blue-800 rounded-full text-sm font-medium">
                        Merchant Dashboard
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-slate-400" id="merchantInfo">
                        <span class="font-medium text-white" id="merchantName">Loading...</span>
                    </div>
                    <button
                        id="logoutBtn"
                        class="text-slate-400 hover:text-white px-3 py-2 text-sm font-medium"
                    >
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Merchant Profile Card -->
        <div class="bg-slate-950 border shadow-sm border mb-8 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-slate-950 rounded-full flex items-center justify-center text-3xl">
                            üè¢
                        </div>
                        <div class="text-white">
                            <h1 class="text-2xl font-bold" id="profileCompanyName">Loading...</h1>
                            <p class="text-blue-100" id="profileEmail">...</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium mb-2" id="profileStatusBadge">
                            <span class="mr-2">‚è≥</span>
                            <span>Pending Approval</span>
                        </div>
                        <div class="text-white text-sm">
                            <span class="opacity-75">Plan:</span>
                            <span class="font-semibold text-white ml-1" id="profilePlan">Starter</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-950">
                <div class="grid grid-cols-3 gap-6">
                    <div>
                        <div class="text-sm text-slate-400 mb-1">Contact</div>
                        <div class="font-medium text-white" id="profileContact">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-slate-400 mb-1">Total Orders</div>
                        <div class="font-medium text-white" id="profileOrderCount">0</div>
                    </div>
                    <div>
                        <div class="text-sm text-slate-400 mb-1">Member Since</div>
                        <div class="font-medium text-white" id="profileCreatedAt">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-slate-950 border p-6 shadow-sm border">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-900/20 border">
                        <span class="text-2xl">üìã</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-400">Total Orders</p>
                        <p class="text-2xl font-bold text-white" id="totalOrders">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-950 border p-6 shadow-sm border">
                <div class="flex items-center">
                    <div class="p-2 bg-green-900/20 border">
                        <span class="text-2xl">‚úÖ</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-400">Confirmed</p>
                        <p class="text-2xl font-bold text-green-400" id="confirmedOrders">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-950 border p-6 shadow-sm border">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-900/20 border">
                        <span class="text-2xl">‚è≥</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-400">Pending</p>
                        <p class="text-2xl font-bold text-yellow-600" id="pendingOrders">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-950 border p-6 shadow-sm border">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-900/20 border">
                        <span class="text-2xl">üí∞</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-400">Total Volume</p>
                        <p class="text-2xl font-bold text-purple-400" id="totalVolume">$0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="bg-slate-950 border shadow-sm border">
            <!-- Tab Navigation -->
            <div class="border-b border-slate-800">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button class="tab-btn border-blue-500 text-blue-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="orders">
                        Orders
                    </button>
                    <button class="tab-btn border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="wallets">
                        Wallets
                    </button>
                    <button class="tab-btn border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="developer">
                        Developer
                    </button>
                    <button class="tab-btn border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="payments">
                        Payment Links
                    </button>
                    <button class="tab-btn border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="settings">
                        Settings
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Orders Tab -->
                <div id="ordersTab" class="tab-content">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-white">Recent Orders</h3>
                        <button 
                            id="refreshOrdersBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 border font-medium transition-colors text-sm"
                        >
                            üîÑ Refresh
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-950">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Order ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Chain</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Created</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody" class="bg-slate-950 divide-y divide-slate-800">
                                <tr>
                                    <td colspan="6" class="px-6 py-12 text-center text-slate-400">
                                        <div class="flex flex-col items-center">
                                            <div class="animate-pulse w-8 h-8 bg-gray-300 rounded mb-4"></div>
                                            <p>Loading orders...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Wallets Tab -->
                <div id="walletsTab" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-white">üí∞ Payment Chains & Wallets</h3>
                            <p class="text-sm text-slate-400 mt-1">Configure which blockchains to accept payments on and set your wallet addresses</p>
                        </div>
                        <button
                            id="saveWalletsBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 border font-medium transition-colors"
                        >
                            üíæ Save Configuration
                        </button>
                    </div>

                    <div id="walletsContainer" class="space-y-3">
                        <!-- Populated dynamically with chain toggles -->
                    </div>

                    <!-- Quick Actions -->
                    <div class="mt-8 bg-slate-950 border border-slate-800 p-6">
                        <h4 class="text-lg font-semibold text-white mb-4">üöÄ Quick Actions</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <button
                                id="createDemoStoreBtn"
                                class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-3 border font-medium transition-all shadow-lg hover:shadow-xl"
                            >
                                üè™ Create Demo Store
                            </button>
                            <button
                                id="testPaymentBtn"
                                class="bg-black border-2 border-blue-600 hover:border-blue-500 text-blue-400 px-6 py-3 font-medium transition-all"
                            >
                                ‚ö° Test Payment
                            </button>
                        </div>
                        <p class="text-sm text-slate-400 mt-3">
                            üí° Create a demo store with your configured wallets or test a payment flow
                        </p>
                    </div>
                </div>

                <!-- Developer Tab -->
                <div id="developerTab" class="tab-content hidden">
                    <div class="space-y-6">
                        <!-- API Keys Section -->
                        <div class="bg-slate-950 border shadow-sm border p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-white">üîë API Keys</h3>
                                    <p class="text-sm text-slate-400 mt-1">Use these keys to integrate StablePay into your application</p>
                                </div>
                                <button id="generateApiKeyBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 border font-medium transition-colors text-sm">
                                    ‚ûï Generate New Key
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-slate-950 border p-4 border border-slate-800">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="text-sm font-medium text-slate-300 mb-1">Merchant ID</div>
                                            <code class="text-sm bg-slate-950 px-3 py-2 rounded border border-slate-800 inline-block font-mono" id="apiMerchantId">Loading...</code>
                                        </div>
                                        <button onclick="navigator.clipboard.writeText(document.getElementById('apiMerchantId').textContent); alert('‚úÖ Copied!')" class="text-blue-400 hover:text-blue-700 text-sm font-medium ml-4">
                                            üìã Copy
                                        </button>
                                    </div>
                                </div>

                                <div class="bg-yellow-50 border p-4 border border-yellow-300">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                                        <div>
                                            <div class="text-sm font-medium text-yellow-800 mb-1">Keep your API keys secure</div>
                                            <p class="text-xs text-yellow-700">Never share your API keys publicly or commit them to version control</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- API Documentation -->
                        <div class="bg-slate-950 border shadow-sm border p-6">
                            <h3 class="text-lg font-semibold text-white mb-6">üìö API Endpoints</h3>

                            <!-- Create Order -->
                            <div class="mb-8">
                                <div class="flex items-center mb-3">
                                    <span class="px-3 py-1 bg-green-900/20 text-green-800 rounded-full text-xs font-bold mr-3">POST</span>
                                    <code class="text-sm font-mono text-slate-300">/api/orders-simple</code>
                                </div>
                                <p class="text-sm text-slate-400 mb-4">Create a new payment order</p>

                                <div class="bg-gray-900 border p-4 overflow-x-auto">
                                    <pre class="text-xs text-green-400 font-mono">curl -X POST https://stablepay-nine.vercel.app/api/orders-simple \\
  -H "Content-Type: application/json" \\
  -d '{
    "merchantId": "YOUR_MERCHANT_ID",
    "amount": "10.00",
    "chain": "BASE_SEPOLIA",
    "customerEmail": "customer@example.com"
  }'</pre>
                                </div>

                                <button onclick="testCreateOrder()" class="mt-3 text-blue-400 hover:text-blue-700 text-sm font-medium">
                                    ‚ö° Test this endpoint
                                </button>
                            </div>

                            <!-- Get Order -->
                            <div class="mb-8">
                                <div class="flex items-center mb-3">
                                    <span class="px-3 py-1 bg-blue-900/20 text-blue-800 rounded-full text-xs font-bold mr-3">GET</span>
                                    <code class="text-sm font-mono text-slate-300">/api/orders/:orderId</code>
                                </div>
                                <p class="text-sm text-slate-400 mb-4">Get order status and details</p>

                                <div class="bg-gray-900 border p-4 overflow-x-auto">
                                    <pre class="text-xs text-green-400 font-mono">curl https://stablepay-nine.vercel.app/api/orders/ORDER_ID</pre>
                                </div>
                            </div>

                            <!-- List Orders -->
                            <div>
                                <div class="flex items-center mb-3">
                                    <span class="px-3 py-1 bg-blue-900/20 text-blue-800 rounded-full text-xs font-bold mr-3">GET</span>
                                    <code class="text-sm font-mono text-slate-300">/api/v1/admin?resource=orders&merchantId=YOUR_ID</code>
                                </div>
                                <p class="text-sm text-slate-400 mb-4">List all orders for your merchant account</p>

                                <div class="bg-gray-900 border p-4 overflow-x-auto">
                                    <pre class="text-xs text-green-400 font-mono">curl https://stablepay-nine.vercel.app/api/v1/admin?resource=orders&merchantId=YOUR_ID \\
  -H "Authorization: Bearer YOUR_TOKEN"</pre>
                                </div>
                            </div>
                        </div>

                        <!-- Code Examples -->
                        <div class="bg-slate-950 border shadow-sm border p-6">
                            <h3 class="text-lg font-semibold text-white mb-6">üíª Code Examples</h3>

                            <div class="space-y-4">
                                <!-- JavaScript -->
                                <div>
                                    <div class="flex items-center mb-2">
                                        <span class="text-yellow-500 mr-2">üì¶</span>
                                        <span class="font-medium text-white">JavaScript / Node.js</span>
                                    </div>
                                    <div class="bg-gray-900 border p-4 overflow-x-auto">
                                        <pre class="text-xs text-green-400 font-mono">const response = await fetch('https://stablepay-nine.vercel.app/api/orders-simple', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    merchantId: 'YOUR_MERCHANT_ID',
    amount: '10.00',
    chain: 'BASE_SEPOLIA',
    customerEmail: 'customer@example.com'
  })
});

const order = await response.json();
console.log('Order created:', order.id);</pre>
                                    </div>
                                </div>

                                <!-- Python -->
                                <div>
                                    <div class="flex items-center mb-2">
                                        <span class="text-blue-500 mr-2">üêç</span>
                                        <span class="font-medium text-white">Python</span>
                                    </div>
                                    <div class="bg-gray-900 border p-4 overflow-x-auto">
                                        <pre class="text-xs text-green-400 font-mono">import requests

response = requests.post(
    'https://stablepay-nine.vercel.app/api/orders-simple',
    json={
        'merchantId': 'YOUR_MERCHANT_ID',
        'amount': '10.00',
        'chain': 'BASE_SEPOLIA',
        'customerEmail': 'customer@example.com'
    }
)

order = response.json()
print(f"Order created: {order['id']}")</pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Webhooks -->
                        <div class="bg-slate-950 border shadow-sm border p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-white">üîî Webhooks</h3>
                                    <p class="text-sm text-slate-400 mt-1">Get notified when payment status changes</p>
                                </div>
                                <span class="px-3 py-1 bg-purple-900/20 text-purple-800 rounded-full text-xs font-medium">
                                    Coming Soon
                                </span>
                            </div>
                            <p class="text-sm text-slate-400">Configure webhook endpoints to receive real-time payment notifications</p>
                        </div>
                    </div>
                </div>

                <!-- Payment Links Tab -->
                <div id="paymentsTab" class="tab-content hidden">
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üîó</div>
                        <h3 class="text-xl font-bold text-white mb-2">Payment Links</h3>
                        <p class="text-slate-400 mb-6">Create shareable payment links - Coming soon!</p>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content hidden">
                    <div class="space-y-8">
                        <!-- Account Information -->
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4">Account Information</h3>
                            <div class="bg-slate-950 border p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Company Name</label>
                                        <input type="text" id="companyName" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Contact Name</label>
                                        <input type="text" id="contactName" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                                        <input type="email" id="email" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Plan</label>
                                        <input type="text" id="plan" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" readonly>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button id="saveProfileBtn" type="button" class="bg-blue-600 text-white px-6 py-2 border hover:bg-blue-700 transition-colors">
                                        üíæ Save Profile
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Wallet Modal -->
    <div id="addWalletModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-slate-950 border max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Add Payment Wallet</h3>
                        <button id="closeWalletModal" class="text-slate-400 hover:text-slate-300">
                            <span class="text-2xl">&times;</span>
                        </button>
                    </div>
                    
                    <form id="addWalletForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Blockchain</label>
                            <select id="walletChain" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be populated dynamically based on network mode -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Wallet Address</label>
                            <input
                                type="text"
                                id="walletAddress"
                                placeholder="Enter your wallet address"
                                class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                required
                            >
                            <p class="text-xs text-slate-400 mt-1">This is where USDC payments will be sent</p>
                        </div>
                        <div class="flex space-x-4 pt-4">
                            <button 
                                type="submit"
                                class="flex-1 bg-blue-600 text-white py-2 border hover:bg-blue-700 transition-colors"
                            >
                                Add Wallet
                            </button>
                            <button 
                                type="button"
                                id="cancelWalletModal"
                                class="flex-1 bg-gray-300 text-slate-300 py-2 border hover:bg-gray-400 transition-colors"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Payment Modal -->
    <div id="testPaymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-950 border border-slate-800 shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-white mb-6">‚ö° Test Payment</h2>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Stablecoin</label>
                    <select id="testToken" class="w-full px-4 py-3 bg-black text-white border border-slate-800 focus:border-blue-600 focus:outline-none">
                        <option value="USDC">üíµ USDC</option>
                        <option value="USDT">üíµ USDT</option>
                        <option value="EURC">üí∂ EURC</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Amount</label>
                    <input type="number" id="testAmount" step="0.01" min="0.01" placeholder="0.1"
                           class="w-full px-4 py-3 bg-black text-white border border-slate-800 focus:border-blue-600 focus:outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Select Chain</label>
                    <select id="testChain" class="w-full px-4 py-3 bg-black text-white border border-slate-800 focus:border-blue-600 focus:outline-none">
                        <!-- Populated dynamically -->
                    </select>
                </div>

                <div id="testWalletSelector" class="hidden">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Select Wallet</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="connectMetaMask" class="bg-slate-900 hover:bg-slate-800 border border-slate-700 px-4 py-3 rounded transition-colors">
                            <div class="text-2xl mb-1">ü¶ä</div>
                            <div class="text-sm">MetaMask</div>
                        </button>
                        <button id="connectPhantom" class="bg-slate-900 hover:bg-slate-800 border border-slate-700 px-4 py-3 rounded transition-colors">
                            <div class="text-2xl mb-1">üëª</div>
                            <div class="text-sm">Phantom</div>
                        </button>
                    </div>
                </div>

                <div id="testWalletInfo" class="hidden bg-black border border-slate-800 p-4 rounded">
                    <div class="text-xs text-slate-400 mb-1">Payment will be sent to:</div>
                    <div id="testWalletAddress" class="text-sm text-blue-400 font-mono break-all"></div>
                </div>

                <div id="testConnectedWallet" class="hidden bg-green-900/20 border border-green-800 p-4 rounded">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-green-400 mb-1">Connected Wallet</div>
                            <div id="testConnectedAddress" class="text-sm text-white font-mono break-all"></div>
                        </div>
                        <button id="testDisconnectWallet" class="text-red-400 hover:text-red-300 text-sm">
                            Disconnect
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3">
                <button id="testPayBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 font-medium transition-colors">
                    Pay
                </button>
                <button id="closeTestPaymentModal" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 font-medium transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script>
        let currentMerchant = null;
        let currentTab = 'orders';
        let merchantWallets = [];

        // Chain configuration
        const CHAINS = [
            { id: 'BASE_SEPOLIA', name: 'Base Sepolia', network: 'testnet', icon: 'üîµ' },
            { id: 'BASE_MAINNET', name: 'Base Mainnet', network: 'mainnet', icon: 'üîµ' },
            { id: 'ETHEREUM_SEPOLIA', name: 'Ethereum Sepolia', network: 'testnet', icon: '‚ü†' },
            { id: 'ETHEREUM_MAINNET', name: 'Ethereum Mainnet', network: 'mainnet', icon: '‚ü†' },
            { id: 'POLYGON_MAINNET', name: 'Polygon Mainnet', network: 'mainnet', icon: 'üü£' },
            { id: 'POLYGON_MUMBAI', name: 'Polygon Mumbai', network: 'testnet', icon: 'üü£' },
            { id: 'ARBITRUM_MAINNET', name: 'Arbitrum Mainnet', network: 'mainnet', icon: 'üî∑' },
            { id: 'ARBITRUM_SEPOLIA', name: 'Arbitrum Sepolia', network: 'testnet', icon: 'üî∑' },
            { id: 'SOLANA_MAINNET', name: 'Solana Mainnet', network: 'mainnet', icon: 'üåû' },
            { id: 'SOLANA_DEVNET', name: 'Solana Devnet', network: 'testnet', icon: 'üåû' }
        ];

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-400');
                btn.classList.add('border-transparent', 'text-slate-400', 'hover:text-slate-300', 'hover:border-slate-800');
            });
            
            // Highlight active tab
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.remove('border-transparent', 'text-slate-400', 'hover:text-slate-300', 'hover:border-slate-800');
            activeBtn.classList.add('border-blue-500', 'text-blue-400');
            
            currentTab = tabName;
            
            // Load tab content
            if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'wallets') {
                loadWallets();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }


        // Load merchant data
        async function loadMerchantData() {
            try {
                // Get merchant ID and token from session
                const merchantId = sessionStorage.getItem('merchantId');
                const merchantToken = sessionStorage.getItem('merchantToken');
                
                if (!merchantId && !merchantToken) {
                    console.error('No merchant authentication found');
                    window.location.href = '/login.html';
                    return;
                }

                // Fetch actual merchant data from API
                console.log('Loading merchant data with:', { merchantId, hasToken: !!merchantToken });
                const response = await fetch(`/api/merchant-profile?${merchantId ? 'id=' + merchantId : 'token=' + merchantToken}`);

                console.log('API response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error:', errorText);
                    throw new Error('Failed to load merchant data: ' + errorText);
                }

                currentMerchant = await response.json();
                console.log('Loaded merchant:', currentMerchant);
                
                // Set defaults if missing
                currentMerchant.plan = currentMerchant.plan || 'STARTER';
                currentMerchant.networkMode = currentMerchant.networkMode || 'TESTNET';
                currentMerchant.paymentMode = currentMerchant.paymentMode || 'DIRECT';

                document.getElementById('merchantName').textContent = currentMerchant.companyName;

                // Update profile card
                document.getElementById('profileCompanyName').textContent = currentMerchant.companyName;
                document.getElementById('profileEmail').textContent = currentMerchant.email;
                document.getElementById('profileContact').textContent = currentMerchant.contactName;
                document.getElementById('profilePlan').textContent = currentMerchant.plan || 'None';
                document.getElementById('profileOrderCount').textContent = currentMerchant.orderCount || 0;

                // Format created date
                if (currentMerchant.createdAt) {
                    const created = new Date(currentMerchant.createdAt);
                    document.getElementById('profileCreatedAt').textContent = created.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                }

                // Update status badge
                const statusBadge = document.getElementById('profileStatusBadge');
                if (currentMerchant.isActive) {
                    statusBadge.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium mb-2 bg-green-900/20 text-green-800';
                    statusBadge.innerHTML = '<span class="mr-2">‚úÖ</span><span>Active</span>';
                    document.getElementById('pendingBanner').classList.add('hidden');
                } else {
                    statusBadge.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium mb-2 bg-yellow-900/20 text-yellow-800';
                    statusBadge.innerHTML = '<span class="mr-2">‚è≥</span><span>Pending Approval</span>';
                    document.getElementById('pendingBanner').classList.remove('hidden');
                }

                // Update settings form
                document.getElementById('companyName').value = currentMerchant.companyName;
                document.getElementById('contactName').value = currentMerchant.contactName;
                document.getElementById('email').value = currentMerchant.email;
                document.getElementById('plan').value = currentMerchant.plan;

                // Update API developer section
                document.getElementById('apiMerchantId').textContent = currentMerchant.id;

                // Load current tab content after merchant data is ready
                if (currentTab === 'orders') {
                    loadOrders();
                } else if (currentTab === 'wallets') {
                    loadWallets();
                }
            } catch (error) {
                console.error('Error loading merchant data:', error);
                // Show error to user
                document.getElementById('merchantName').textContent = 'Error Loading Data';
                alert('Failed to load merchant data. Please check console for details.');
            }
        }

        // Test Create Order API
        window.testCreateOrder = async function() {
            if (!currentMerchant) {
                alert('Please wait for merchant data to load');
                return;
            }

            if (merchantWallets.length === 0) {
                alert('‚ö†Ô∏è Please configure at least one wallet first');
                return;
            }

            // Use first configured chain
            const firstChain = merchantWallets[0].chain;

            try {
                const response = await fetch('/api/orders-simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        merchantId: currentMerchant.id,
                        amount: '10.00',
                        chain: firstChain,
                        customerEmail: 'test@example.com'
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Test order created successfully!\n\nOrder ID: ${result.id}\nChain: ${firstChain}\nAmount: 10.00 USDC`);
                } else {
                    alert(`‚ùå Test failed: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Test failed: ${error.message}`);
            }
        };

        // Load orders
        async function loadOrders() {
            try {
                if (!currentMerchant?.id) {
                    renderOrdersTable([]);
                    updateStats({ orders: [], pagination: { total: 0 } });
                    return;
                }

                // Fetch orders for this merchant
                const merchantToken = sessionStorage.getItem('merchantToken');
                const response = await fetch(`/api/v1/admin?resource=orders&merchantId=${currentMerchant.id}`, {
                    headers: { 'Authorization': `Bearer ${merchantToken}` }
                });

                if (response.ok) {
                    const orders = await response.json();
                    updateStats({ orders, pagination: { total: orders.length } });
                    renderOrdersTable(orders);
                } else {
                    // No orders yet
                    renderOrdersTable([]);
                    updateStats({ orders: [], pagination: { total: 0 } });
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                renderOrdersTable([]);
                updateStats({ orders: [], pagination: { total: 0 } });
            }
        }

        function updateStats(data) {
            const total = data.pagination ? data.pagination.total : data.orders.length;
            const confirmed = data.orders.filter(o => o.status === 'PAID' || o.status === 'CONFIRMED').length;
            const pending = data.orders.filter(o => o.status === 'PENDING').length;
            const totalVolume = data.orders.reduce((sum, o) => sum + (o.amount || 0), 0);

            document.getElementById('totalOrders').textContent = total;
            document.getElementById('confirmedOrders').textContent = confirmed;
            document.getElementById('pendingOrders').textContent = pending;
            document.getElementById('totalVolume').textContent = '$' + totalVolume.toFixed(2);
        }

        function renderOrdersTable(orders) {
            const tbody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const statusClass = `status-${order.status.toLowerCase()}`;
                const shortId = order.id.slice(0, 8) + '...';
                const createdAt = new Date(order.createdAt).toLocaleDateString();
                
                return `
                    <tr class="hover:bg-slate-950">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-white">${shortId}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-white">${order.amount} USDC</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-slate-400">${order.chain.replace('_', ' ')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${order.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-slate-400">${order.customerEmail || 'Anonymous'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">
                            ${createdAt}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load wallets
        async function loadWallets() {
            if (!currentMerchant) {
                console.log('loadWallets: currentMerchant not loaded yet');
                return;
            }

            console.log('loadWallets: Loading wallets for merchant', currentMerchant.id);

            try {
                // Use wallets from currentMerchant (already loaded from merchant-profile API)
                if (currentMerchant.wallets) {
                    merchantWallets = currentMerchant.wallets;
                    console.log('loadWallets: Using cached wallets', merchantWallets.length, 'wallets');
                } else {
                    merchantWallets = [];
                    console.log('loadWallets: No wallets found for merchant');
                }

                renderChainToggles();
            } catch (error) {
                console.error('Error loading wallets:', error);
                merchantWallets = [];
                renderChainToggles();
            }
        }

        // Render chain toggles
        function renderChainToggles() {
            const container = document.getElementById('walletsContainer');
            console.log('renderChainToggles: Rendering', CHAINS.length, 'chains with', merchantWallets.length, 'existing wallets');

            container.innerHTML = CHAINS.map(chain => {
                const wallet = merchantWallets.find(w => w.chain === chain.id);
                const isEnabled = !!wallet;
                const address = wallet?.address || '';

                return `
                    <div class="bg-slate-950 border p-4 border border-slate-800 hover:border-slate-800 transition">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${chain.icon}</span>
                                <div>
                                    <div class="font-medium text-white">${chain.name}</div>
                                    <div class="text-xs text-slate-400">${chain.network}</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox"
                                       class="sr-only peer chain-toggle"
                                       data-chain="${chain.id}"
                                       ${isEnabled ? 'checked' : ''}
                                       onchange="toggleChainInput('${chain.id}')">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-950 after:border-slate-800 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div id="wallet-input-${chain.id}" class="${isEnabled ? '' : 'hidden'} mt-2">
                            <input type="text"
                                   class="w-full px-3 py-2 text-sm bg-black border border-slate-800 text-white font-mono"
                                   placeholder="0x... or wallet address"
                                   data-wallet-chain="${chain.id}"
                                   value="${address}">
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle chain input visibility
        window.toggleChainInput = function(chainId) {
            const input = document.getElementById(`wallet-input-${chainId}`);
            const checkbox = document.querySelector(`input[data-chain="${chainId}"]`);

            if (checkbox.checked) {
                input.classList.remove('hidden');
            } else {
                input.classList.add('hidden');
                const walletInput = input.querySelector('input');
                if (walletInput) walletInput.value = '';
            }
        };

        // Save wallets
        document.getElementById('saveWalletsBtn').addEventListener('click', async () => {
            if (!currentMerchant) return;

            // Collect wallet configurations
            const wallets = [];
            document.querySelectorAll('.chain-toggle').forEach(toggle => {
                if (toggle.checked) {
                    const chain = toggle.dataset.chain;
                    const addressInput = document.querySelector(`input[data-wallet-chain="${chain}"]`);
                    const address = addressInput?.value.trim();

                    if (address) {
                        wallets.push({ chain, address });
                    }
                }
            });

            try {
                const merchantToken = sessionStorage.getItem('merchantToken');
                const response = await fetch(`/api/v1/admin?resource=wallets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${merchantToken}`
                    },
                    body: JSON.stringify({
                        merchantId: currentMerchant.id,
                        wallets
                    })
                });

                if (response.ok) {
                    alert('‚úÖ Wallet configuration saved successfully!');
                    loadWallets(); // Reload
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save wallets'));
                }
            } catch (error) {
                alert('Error saving wallets: ' + error.message);
            }
        });

        // Create Demo Store
        document.getElementById('createDemoStoreBtn').addEventListener('click', async () => {
            if (!currentMerchant) {
                alert('Please wait for merchant data to load');
                return;
            }

            if (merchantWallets.length === 0) {
                alert('‚ö†Ô∏è Please configure at least one wallet before creating a demo store');
                return;
            }

            // Generate a unique store URL for this merchant
            const storeUrl = `${window.location.origin}/store.html?merchant=${currentMerchant.id}`;

            // Show modal with store URL and preview
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-slate-950 border shadow-2xl p-8 max-w-2xl w-full mx-4">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h2 class="text-3xl font-bold text-white mb-2">Demo Store Created!</h2>
                        <p class="text-slate-400">Your custom payment store is ready with your configured wallets</p>
                    </div>

                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border p-6 mb-6 border border-purple-200">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-slate-300">Your Store URL:</span>
                            <button onclick="navigator.clipboard.writeText('${storeUrl}'); alert('‚úÖ Copied!')"
                                    class="text-blue-400 hover:text-blue-700 text-sm font-medium">
                                üìã Copy
                            </button>
                        </div>
                        <div class="bg-slate-950 border p-3 border border-slate-800">
                            <code class="text-sm text-purple-700 break-all">${storeUrl}</code>
                        </div>
                    </div>

                    <div class="bg-blue-50 border p-4 mb-6 border border-blue-200">
                        <h4 class="font-semibold text-blue-900 mb-2">üìù Store Features:</h4>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>‚úÖ ${merchantWallets.length} blockchain${merchantWallets.length > 1 ? 's' : ''} enabled</li>
                            <li>‚úÖ Accepts USDC payments</li>
                            <li>‚úÖ Real-time order tracking</li>
                            <li>‚úÖ Automatic wallet selection</li>
                        </ul>
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="window.open('${storeUrl}', '_blank')"
                                class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-3 border font-medium transition-all">
                            üöÄ Open Store
                        </button>
                        <button onclick="this.closest('.fixed').remove()"
                                class="px-6 py-3 border border-slate-800 border text-slate-300 hover:bg-slate-950 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        });

        // Test Payment Modal
        let testPaymentProvider = null;
        let testPaymentSigner = null;
        let testConnectedWalletAddress = null;
        let testWalletType = null; // 'metamask' or 'phantom'

        document.getElementById('testPaymentBtn').addEventListener('click', () => {
            if (merchantWallets.length === 0) {
                alert('‚ö†Ô∏è Please configure at least one wallet first');
                return;
            }

            // Populate chain selector with only chains that have wallets
            const testChain = document.getElementById('testChain');
            testChain.innerHTML = merchantWallets.map(w => {
                const chain = CHAINS.find(c => c.id === w.chain);
                return `<option value="${w.chain}">${chain ? chain.icon + ' ' + chain.name : w.chain}</option>`;
            }).join('');

            // Show wallet address for first chain
            if (merchantWallets.length > 0) {
                updateTestWalletDisplay(merchantWallets[0].chain);
            }

            // Show modal
            document.getElementById('testPaymentModal').classList.remove('hidden');
        });

        document.getElementById('closeTestPaymentModal').addEventListener('click', () => {
            document.getElementById('testPaymentModal').classList.add('hidden');
            resetTestPaymentModal();
        });

        document.getElementById('testChain').addEventListener('change', (e) => {
            const chainId = e.target.value;
            updateTestWalletDisplay(chainId);

            // Reset wallet connection when chain changes
            resetWalletConnection();

            // Show wallet selector based on chain type
            const isSolana = chainId.includes('SOLANA');
            if (isSolana) {
                document.getElementById('testWalletSelector').classList.remove('hidden');
            } else {
                document.getElementById('testWalletSelector').classList.remove('hidden');
            }
        });

        function updateTestWalletDisplay(chainId) {
            const wallet = merchantWallets.find(w => w.chain === chainId);
            if (wallet) {
                document.getElementById('testWalletAddress').textContent = wallet.address;
                document.getElementById('testWalletInfo').classList.remove('hidden');
            }
        }

        function resetWalletConnection() {
            testConnectedWalletAddress = null;
            testWalletType = null;
            document.getElementById('testConnectedWallet').classList.add('hidden');
            document.getElementById('testWalletSelector').classList.remove('hidden');
        }

        function resetTestPaymentModal() {
            resetWalletConnection();
            testPaymentProvider = null;
            testPaymentSigner = null;
            document.getElementById('testWalletSelector').classList.add('hidden');
        }

        // MetaMask connection
        document.getElementById('connectMetaMask').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('‚ö†Ô∏è Please install MetaMask');
                    window.open('https://metamask.io/download/', '_blank');
                    return;
                }

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts || accounts.length === 0) {
                    alert('‚ö†Ô∏è No accounts found');
                    return;
                }

                testPaymentProvider = new ethers.BrowserProvider(window.ethereum);
                testPaymentSigner = await testPaymentProvider.getSigner();
                testConnectedWalletAddress = await testPaymentSigner.getAddress();
                testWalletType = 'metamask';

                document.getElementById('testConnectedAddress').textContent =
                    testConnectedWalletAddress.slice(0, 6) + '...' + testConnectedWalletAddress.slice(-4);
                document.getElementById('testConnectedWallet').classList.remove('hidden');
                document.getElementById('testWalletSelector').classList.add('hidden');

            } catch (error) {
                console.error('MetaMask connection error:', error);
                alert('‚ùå Failed to connect MetaMask: ' + error.message);
            }
        });

        // Phantom connection
        document.getElementById('connectPhantom').addEventListener('click', async () => {
            try {
                const phantom = window.solana;
                if (!phantom?.isPhantom) {
                    alert('‚ö†Ô∏è Please install Phantom wallet');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }

                const resp = await phantom.connect();
                testConnectedWalletAddress = resp.publicKey.toString();
                testWalletType = 'phantom';

                document.getElementById('testConnectedAddress').textContent =
                    testConnectedWalletAddress.slice(0, 6) + '...' + testConnectedWalletAddress.slice(-4);
                document.getElementById('testConnectedWallet').classList.remove('hidden');
                document.getElementById('testWalletSelector').classList.add('hidden');

            } catch (error) {
                console.error('Phantom connection error:', error);
                alert('‚ùå Failed to connect Phantom: ' + error.message);
            }
        });

        // Disconnect wallet
        document.getElementById('testDisconnectWallet').addEventListener('click', () => {
            resetWalletConnection();
        });

        document.getElementById('testPayBtn').addEventListener('click', async () => {
            const amount = document.getElementById('testAmount').value;
            const chainId = document.getElementById('testChain').value;
            const token = document.getElementById('testToken').value;

            if (!amount || parseFloat(amount) <= 0) {
                alert('‚ö†Ô∏è Please enter a valid amount');
                return;
            }

            if (!testConnectedWalletAddress) {
                alert('‚ö†Ô∏è Please connect your wallet first');
                return;
            }

            const wallet = merchantWallets.find(w => w.chain === chainId);
            if (!wallet) {
                alert('‚ö†Ô∏è Wallet not found for selected chain');
                return;
            }

            // Check if correct wallet type for chain
            const isSolana = chainId.includes('SOLANA');
            if (isSolana && testWalletType !== 'phantom') {
                alert('‚ö†Ô∏è Please connect Phantom wallet for Solana');
                return;
            }
            if (!isSolana && testWalletType !== 'metamask') {
                alert('‚ö†Ô∏è Please connect MetaMask for EVM chains');
                return;
            }

            await initiateTestPayment(amount, chainId, wallet.address, token);
        });

        async function initiateTestPayment(amount, chainId, merchantWallet, token) {
            try {
                const isSolana = chainId.includes('SOLANA');

                if (isSolana) {
                    await initiateSolanaPayment(amount, chainId, merchantWallet, token);
                } else {
                    await initiateEVMPayment(amount, chainId, merchantWallet, token);
                }

            } catch (error) {
                console.error('Test payment error:', error);
                alert('‚ùå Payment failed: ' + error.message);
            }
        }

        async function initiateEVMPayment(amount, chainId, merchantWallet, token) {
            try {
                console.log('Connected wallet:', testConnectedWalletAddress);

                // Get chain config
                const chainConfig = getChainConfig(chainId, token);
                if (!chainConfig) {
                    alert('‚ö†Ô∏è Chain configuration not found');
                    return;
                }

                // Switch to correct network
                const network = await testPaymentProvider.getNetwork();
                const currentChainId = network.chainId;
                const targetChainId = parseInt(chainConfig.chainId, 16);

                if (currentChainId !== BigInt(targetChainId)) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: chainConfig.chainId }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: chainConfig.chainId,
                                    chainName: chainConfig.chainName,
                                    rpcUrls: chainConfig.rpcUrls,
                                    nativeCurrency: chainConfig.nativeCurrency,
                                    blockExplorerUrls: chainConfig.blockExplorerUrls
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }

                    testPaymentProvider = new ethers.BrowserProvider(window.ethereum);
                    testPaymentSigner = await testPaymentProvider.getSigner();
                }

                // Create order first
                const orderResponse = await fetch('/api/v1/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        merchantId: currentMerchant.id,
                        productName: 'Test Payment',
                        amount: parseFloat(amount),
                        chain: chainId,
                        customerEmail: testConnectedWalletAddress,
                        paymentAddress: merchantWallet
                    })
                });

                if (!orderResponse.ok) {
                    throw new Error('Failed to create order');
                }

                const orderData = await orderResponse.json();
                console.log('Order created:', orderData);

                // Initiate token transfer
                const tokenContract = new ethers.Contract(
                    chainConfig.tokenAddress,
                    ['function transfer(address to, uint256 amount) returns (bool)'],
                    testPaymentSigner
                );

                const amountWei = ethers.parseUnits(amount, 6); // Stablecoins have 6 decimals

                alert(`‚úÖ Order created! Now approve the ${token} transfer in your wallet.`);

                const tx = await tokenContract.transfer(merchantWallet, amountWei);
                console.log('Transaction sent:', tx.hash);

                alert(`‚è≥ Payment sent! Transaction: ${tx.hash}`);

                // Wait for confirmation
                await tx.wait();

                alert('‚úÖ Payment confirmed! Check your Orders tab.');

                // Close modal and refresh orders
                document.getElementById('testPaymentModal').classList.add('hidden');
                loadOrders();

            } catch (error) {
                console.error('EVM payment error:', error);
                alert('‚ùå Payment failed: ' + error.message);
            }
        }

        async function initiateSolanaPayment(amount, chainId, merchantWallet, token) {
            try {
                const phantom = window.solana;

                // Get token mint address
                const tokenMints = {
                    'SOLANA_DEVNET': {
                        USDC: 'Gh9ZwEmdLJ8DscKNTkTqPbNwLNNBjuSzaG9Vp2KGtKJr', // Devnet USDC
                        USDT: '',
                        EURC: ''
                    },
                    'SOLANA_MAINNET': {
                        USDC: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', // Mainnet USDC
                        USDT: 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB', // Mainnet USDT
                        EURC: 'HzwqbKZw8HxMN6bF2yFZNrht3c2iXXzpKcFu7uBEDKtr' // Mainnet EURC
                    }
                };

                const mintAddress = tokenMints[chainId]?.[token];
                if (!mintAddress) {
                    alert(`‚ö†Ô∏è ${token} not available on this Solana network`);
                    return;
                }

                // Create order first
                const orderResponse = await fetch('/api/v1/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        merchantId: currentMerchant.id,
                        productName: 'Test Payment',
                        amount: parseFloat(amount),
                        chain: chainId,
                        customerEmail: testConnectedWalletAddress,
                        paymentAddress: merchantWallet
                    })
                });

                if (!orderResponse.ok) {
                    throw new Error('Failed to create order');
                }

                const orderData = await orderResponse.json();
                console.log('Order created:', orderData);

                alert(`‚úÖ Order created! Now approve the ${token} transfer in Phantom.`);

                // For Solana SPL token transfer, we need to use @solana/spl-token
                // Simplified: ask user to send manually for now
                const rpcUrl = chainId === 'SOLANA_MAINNET'
                    ? 'https://api.mainnet-beta.solana.com'
                    : 'https://api.devnet.solana.com';

                const connection = new solanaWeb3.Connection(rpcUrl);
                const fromPubkey = new solanaWeb3.PublicKey(testConnectedWalletAddress);
                const toPubkey = new solanaWeb3.PublicKey(merchantWallet);

                // Note: This is simplified - full SPL token transfer requires token accounts
                alert(`‚ö†Ô∏è Solana SPL token transfers require additional setup. Please send ${amount} ${token} to ${merchantWallet} manually for now.`);

                // Close modal and refresh orders
                document.getElementById('testPaymentModal').classList.add('hidden');
                loadOrders();

            } catch (error) {
                console.error('Solana payment error:', error);
                alert('‚ùå Payment failed: ' + error.message);
            }
        }

        function getChainConfig(chainId, token = 'USDC') {
            const tokenAddresses = {
                'BASE_SEPOLIA': {
                    USDC: '0x036CbD53842c5426634e7929541eC2318f3dCF7e',
                    USDT: '0x', // Add if available
                    EURC: '0x'  // Add if available
                },
                'BASE_MAINNET': {
                    USDC: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
                    USDT: '0x', // Add USDT address
                    EURC: '0x60a3E35Cc302bFA44Cb288Bc5a4F316Fdb1adb42'
                },
                'ETHEREUM_SEPOLIA': {
                    USDC: '0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238',
                    USDT: '0x', // Add if available
                    EURC: '0x'  // Add if available
                },
                'ETHEREUM_MAINNET': {
                    USDC: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                    USDT: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                    EURC: '0x1aBaEA1f7C830bD89Acc67eC4af516284b1bC33c'
                },
                'POLYGON_MAINNET': {
                    USDC: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
                    USDT: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F',
                    EURC: '0x'  // Add if available
                },
                'POLYGON_MUMBAI': {
                    USDC: '0x0FA8781a83E46826621b3BC094Ea2A0212e71B23',
                    USDT: '0x', // Add if available
                    EURC: '0x'  // Add if available
                },
                'ARBITRUM_MAINNET': {
                    USDC: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831',
                    USDT: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9',
                    EURC: '0x'  // Add if available
                },
                'ARBITRUM_SEPOLIA': {
                    USDC: '0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d',
                    USDT: '0x', // Add if available
                    EURC: '0x'  // Add if available
                }
            };

            const configs = {
                'BASE_SEPOLIA': {
                    chainId: '0x14a34',
                    chainName: 'Base Sepolia',
                    rpcUrls: ['https://sepolia.base.org'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://sepolia.basescan.org']
                },
                'BASE_MAINNET': {
                    chainId: '0x2105',
                    chainName: 'Base',
                    rpcUrls: ['https://mainnet.base.org'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://basescan.org']
                },
                'ETHEREUM_SEPOLIA': {
                    chainId: '0xaa36a7',
                    chainName: 'Ethereum Sepolia',
                    rpcUrls: ['https://rpc.sepolia.org'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://sepolia.etherscan.io']
                },
                'ETHEREUM_MAINNET': {
                    chainId: '0x1',
                    chainName: 'Ethereum',
                    rpcUrls: ['https://eth.llamarpc.com'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://etherscan.io']
                },
                'POLYGON_MAINNET': {
                    chainId: '0x89',
                    chainName: 'Polygon',
                    rpcUrls: ['https://polygon-rpc.com'],
                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                    blockExplorerUrls: ['https://polygonscan.com']
                },
                'POLYGON_MUMBAI': {
                    chainId: '0x13881',
                    chainName: 'Polygon Mumbai',
                    rpcUrls: ['https://rpc-mumbai.maticvigil.com'],
                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                    blockExplorerUrls: ['https://mumbai.polygonscan.com']
                },
                'ARBITRUM_MAINNET': {
                    chainId: '0xa4b1',
                    chainName: 'Arbitrum One',
                    rpcUrls: ['https://arb1.arbitrum.io/rpc'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://arbiscan.io']
                },
                'ARBITRUM_SEPOLIA': {
                    chainId: '0x66eee',
                    chainName: 'Arbitrum Sepolia',
                    rpcUrls: ['https://sepolia-rollup.arbitrum.io/rpc'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://sepolia.arbiscan.io']
                }
            };

            const config = configs[chainId];
            if (!config) return null;

            // Add token address
            config.tokenAddress = tokenAddresses[chainId]?.[token];

            return config;
        }

        // Load settings
        function loadSettings() {
            // Settings are already loaded in loadMerchantData
        }

        // Modal functions (unused, wallet modal was replaced with inline form)
        function showAddWalletModal() {
            const modal = document.getElementById('addWalletModal');
            modal.classList.remove('hidden');
        }

        function hideAddWalletModal() {
            document.getElementById('addWalletModal').classList.add('hidden');
            document.getElementById('addWalletForm').reset();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });


            // Refresh button
            const refreshBtn = document.getElementById('refreshOrdersBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadOrders);
            }

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    sessionStorage.removeItem('merchantToken');
                    window.location.href = '/login.html';
                });
            }

            // Save profile button
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch(`/api/merchant-profile`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: currentMerchant.id,
                            companyName: document.getElementById('companyName').value,
                            contactName: document.getElementById('contactName').value,
                            email: document.getElementById('email').value
                        })
                    });

                    if (response.ok) {
                        currentMerchant.companyName = document.getElementById('companyName').value;
                        currentMerchant.contactName = document.getElementById('contactName').value;
                        currentMerchant.email = document.getElementById('email').value;

                        // Update profile card
                        document.getElementById('merchantName').textContent = currentMerchant.companyName;
                        document.getElementById('profileCompanyName').textContent = currentMerchant.companyName;
                        document.getElementById('profileEmail').textContent = currentMerchant.email;
                        document.getElementById('profileContact').textContent = currentMerchant.contactName;

                        alert('‚úÖ Profile updated successfully!');
                    } else {
                        alert('‚ùå Failed to update profile');
                    }
                } catch (error) {
                    console.error('Error saving profile:', error);
                    alert('‚ùå Failed to save profile');
                }
                });
            }

            // Initialize
            // Check for pending status
            const isPending = sessionStorage.getItem("isPending") === "true";
            if (isPending) {
                document.getElementById("pendingBanner").classList.remove("hidden");
            }

            // Load merchant data first, it will trigger loading the current tab
            loadMerchantData();
        });
    </script>
</body>
</html>