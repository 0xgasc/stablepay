<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Dashboard - StablePay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/chain-config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap');

        * {
            font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f8f8f8;
            color: #000;
            min-height: 100vh;
        }

        /* Neo-brutalism elements */
        .brutal-border {
            border: 4px solid #000;
            box-shadow: 8px 8px 0px #000;
        }

        .brutal-border-thin {
            border: 3px solid #000;
            box-shadow: 6px 6px 0px #000;
        }

        .brutal-shadow {
            box-shadow: 6px 6px 0px #000;
        }

        .brutal-shadow-sm {
            box-shadow: 4px 4px 0px #000;
        }

        .btn-brutal {
            background: #000;
            color: #fff;
            border: 4px solid #000;
            box-shadow: 6px 6px 0px #000;
            transition: all 0.15s ease;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-brutal:hover {
            transform: translate(-2px, -2px);
            box-shadow: 8px 8px 0px #000;
        }

        .btn-brutal:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        /* Cold color palette */
        .accent-cyan {
            background: #00E5FF;
        }

        .accent-blue {
            background: #4FC3F7;
        }

        .accent-indigo {
            background: #7C4DFF;
        }

        .accent-teal {
            background: #1DE9B6;
        }

        .bg-cyan-100 {
            background: #B2EBF2;
        }

        .bg-teal-100 {
            background: #B2DFDB;
        }

        .bg-indigo-100 {
            background: #C5CAE9;
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-shadow {
            0%, 100% { box-shadow: 8px 8px 0px #000; }
            50% { box-shadow: 12px 12px 0px #000; }
        }

        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .network-badge {
            background: linear-gradient(90deg, #f59e0b, #ef4444);
            animation: gradient 3s ease infinite;
            background-size: 400% 400%;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
        }

        .mainnet-badge {
            background: linear-gradient(90deg, #059669, #0891b2);
            animation: gradient 3s ease infinite;
            background-size: 400% 400%;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
        }

        .status-paid {
            background: #dbeafe;
            color: #1e3a8a;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
        }

        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
        }

        .status-failed {
            background: #fee2e2;
            color: #991b1b;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
        }

        .status-expired {
            background: #e2e8f0;
            color: #475569;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
        }

        h1, h2, h3 {
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* Night mode styles */
        body.night-mode {
            background: #1a1a1a;
            color: #fff;
        }

        body.night-mode .brutal-border,
        body.night-mode .brutal-border-thin {
            border-color: #fff;
            box-shadow: 8px 8px 0px #fff;
        }

        body.night-mode .brutal-shadow {
            box-shadow: 6px 6px 0px #fff;
        }

        body.night-mode .brutal-shadow-sm {
            box-shadow: 4px 4px 0px #fff;
        }

        body.night-mode .btn-brutal {
            background: #fff;
            color: #000;
            border-color: #fff;
            box-shadow: 6px 6px 0px #fff;
        }

        body.night-mode .btn-brutal:hover {
            box-shadow: 8px 8px 0px #fff;
        }

        body.night-mode .btn-brutal:active {
            box-shadow: 2px 2px 0px #fff;
        }

        body.night-mode .bg-white {
            background: #000;
        }

        body.night-mode .bg-gray-100,
        body.night-mode .bg-gray-50 {
            background: #222;
        }

        body.night-mode .text-black {
            color: #fff !important;
        }

        body.night-mode .text-gray-700,
        body.night-mode .text-gray-600 {
            color: #ccc !important;
        }

        body.night-mode .text-gray-500 {
            color: #888 !important;
        }

        body.night-mode .text-gray-400 {
            color: #999 !important;
        }

        body.night-mode .bg-cyan-100,
        body.night-mode .bg-indigo-100,
        body.night-mode .bg-teal-100 {
            background: #1e3a8a;
        }

        body.night-mode .network-badge,
        body.night-mode .mainnet-badge {
            border-color: #fff;
            box-shadow: 4px 4px 0px #fff;
        }

        body.night-mode .status-pending,
        body.night-mode .status-paid,
        body.night-mode .status-confirmed,
        body.night-mode .status-failed,
        body.night-mode .status-expired {
            border-color: #fff;
            box-shadow: 4px 4px 0px #fff;
        }

        #pendingBanner {
            border-bottom: 4px solid #000;
        }

        body.night-mode #pendingBanner {
            background: #92400e;
            border-color: #fff;
        }

        body.night-mode #pendingBanner .text-yellow-800,
        body.night-mode #pendingBanner .text-yellow-700 {
            color: #fff;
        }
    </style>
</head>
<body class="bg-slate-950">

    <!-- Navigation -->

    <!-- Pending Account Banner -->
    <div id="pendingBanner" class="hidden bg-yellow-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center">

                    <div>
                        <p class="font-semibold text-yellow-800">Account Pending Approval</p>
                        <p class="text-sm text-yellow-700">Your account is being reviewed. Full features will be enabled once activated by our team.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <nav class="bg-white brutal-border mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center">
                    <a href="/" class="text-3xl font-black text-black uppercase">
                        StablePay
                    </a>
                    <span class="ml-4 px-4 py-2 bg-cyan-100 text-black border-4 border-black brutal-shadow-sm text-sm font-black uppercase" data-i18n="nav.merchantDashboard">
                        Merchant Dashboard
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-black font-bold" id="merchantInfo">
                        <span class="font-black" id="merchantName">Loading...</span>
                    </div>
                    <select id="langSelector" onchange="changeLanguage(this.value)" class="bg-white border-4 border-black px-3 py-1 font-bold text-sm cursor-pointer hover:bg-gray-100">
                        <option value="en">EN</option>
                        <option value="es">ES</option>
                        <option value="fr">FR</option>
                        <option value="pt">PT</option>
                    </select>
                    <button id="nightModeToggle" class="px-3 py-1 border-4 border-black bg-white hover:bg-gray-100 font-bold text-sm">
                        <span class="night-icon">NIGHT</span>
                        <span class="day-icon hidden">DAY</span>
                    </button>
                    <button
                        id="logoutBtn"
                        class="bg-black text-white px-6 py-2 font-black border-4 border-black brutal-shadow-sm hover:translate-x-[-2px] hover:translate-y-[-2px] transition-all uppercase text-sm"
                    >
                        <span data-i18n="nav.logout">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Merchant Profile Card -->
        <div class="bg-slate-950 border shadow-sm border mb-8 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-slate-950 rounded-full flex items-center justify-center text-3xl">
                            Company
                        </div>
                        <div class="text-white">
                            <h1 class="text-2xl font-bold" id="profileCompanyName">Loading...</h1>
                            <p class="text-blue-100" id="profileEmail">...</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium mb-2" id="profileStatusBadge">
                            
                            <span>Pending Approval</span>
                        </div>
                        <div class="text-white text-sm payment-plan-ref">
                            <span class="opacity-75">Plan:</span>
                            <span class="font-semibold text-white ml-1" id="profilePlan">Starter</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-950">
                <div class="grid grid-cols-3 gap-6">
                    <div>
                        <div class="text-sm text-slate-400 mb-1">Contact</div>
                        <div class="font-medium text-white" id="profileContact">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-slate-400 mb-1">Total Orders</div>
                        <div class="font-medium text-white" id="profileOrderCount">0</div>
                    </div>
                    <div>
                        <div class="text-sm text-slate-400 mb-1">Member Since</div>
                        <div class="font-medium text-white" id="profileCreatedAt">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Tier Card -->
        <div class="bg-cyan-100 border-4 border-black brutal-shadow mb-8 p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-2xl font-black text-black uppercase" id="currentPlanName">FREE TIER</h3>
                    <p class="text-sm text-black font-medium" data-i18n="pricing.tierDescription">Your current pricing plan</p>
                </div>
                <button id="upgradeBtn" class="bg-black text-white px-6 py-3 font-bold uppercase border-4 border-black brutal-shadow hover:translate-x-[-2px] hover:translate-y-[-2px] transition-all" data-i18n="pricing.upgrade">
                    UPGRADE
                </button>
            </div>

            <!-- Usage Bar -->
            <div class="mb-4">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-bold text-black uppercase" data-i18n="pricing.monthlyUsage">Monthly Volume Used</span>
                    <span class="text-sm font-bold text-black" id="volumeUsageText">$0 / $1,000</span>
                </div>
                <div class="w-full bg-white border-4 border-black h-8">
                    <div id="volumeUsageBar" class="bg-indigo-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p class="text-xs text-black font-medium mt-2" id="billingCycleText">Billing cycle resets in 30 days</p>
            </div>

            <!-- Plan Features -->
            <div class="grid grid-cols-2 gap-4 text-sm font-medium text-black">
                <div>
                    <span class="font-bold uppercase" data-i18n="pricing.features.blockchains">Blockchains:</span>
                    <span id="planBlockchains">1</span>
                </div>
                <div>
                    <span class="font-bold uppercase" data-i18n="pricing.features.fee">Fee:</span>
                    <span id="planFee">0.5%</span>
                </div>
                <div>
                    <span class="font-bold uppercase" data-i18n="pricing.features.refunds">Refunds:</span>
                    <span id="planRefunds">No</span>
                </div>
                <div>
                    <span class="font-bold uppercase" data-i18n="pricing.features.webhooks">Webhooks:</span>
                    <span id="planWebhooks">No</span>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-slate-950 border p-6 shadow-sm border">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-900/20 border">
                        
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-400">Total Orders</p>
                        <p class="text-2xl font-bold text-white" id="totalOrders">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-950 border p-6 shadow-sm border">
                <div class="flex items-center">
                    <div class="p-2 bg-green-900/20 border">
                        
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-400">Confirmed</p>
                        <p class="text-2xl font-bold text-green-400" id="confirmedOrders">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-950 border p-6 shadow-sm border">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-900/20 border">
                        
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-400">Pending</p>
                        <p class="text-2xl font-bold text-yellow-600" id="pendingOrders">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-950 border p-6 shadow-sm border">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-900/20 border">
                        
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-400">Total Volume</p>
                        <p class="text-2xl font-bold text-purple-400" id="totalVolume">$0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="bg-slate-950 border shadow-sm border">
            <!-- Tab Navigation -->
            <div class="border-b border-slate-800">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button class="tab-btn border-blue-500 text-blue-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="orders">
                        Orders
                    </button>
                    <button class="tab-btn border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="wallets">
                        Wallets
                    </button>
                    <button class="tab-btn border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="developer">
                        Developer
                    </button>
                    <button class="tab-btn border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="payments">
                        Payment Links
                    </button>
                    <button class="tab-btn border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-800 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="settings">
                        Settings
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Orders Tab -->
                <div id="ordersTab" class="tab-content">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-white">Recent Orders</h3>
                        <div class="flex gap-3">
                            <input
                                type="text"
                                id="orderSearchInput"
                                placeholder="Search orders..."
                                class="bg-black text-white border border-slate-800 px-4 py-2 text-sm focus:border-blue-600 focus:outline-none"
                            />
                            <button
                                id="refreshOrdersBtn"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 border font-medium transition-colors text-sm"
                            >
                                Refresh
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-950">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer hover:text-slate-200" onclick="sortOrders('id')">
                                        Order ID <span class="ml-1">â‡…</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer hover:text-slate-200" onclick="sortOrders('amount')">
                                        Amount <span class="ml-1">â‡…</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer hover:text-slate-200" onclick="sortOrders('chain')">
                                        Chain <span class="ml-1">â‡…</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer hover:text-slate-200" onclick="sortOrders('status')">
                                        Status <span class="ml-1">â‡…</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Transaction</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Receipt</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer hover:text-slate-200" onclick="sortOrders('customer')">
                                        Customer <span class="ml-1">â‡…</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer hover:text-slate-200" onclick="sortOrders('created')">
                                        Created <span class="ml-1">â‡…</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody" class="bg-slate-950 divide-y divide-slate-800">
                                <tr>
                                    <td colspan="8" class="px-6 py-12 text-center text-slate-400">
                                        <div class="flex flex-col items-center">
                                            <div class="animate-pulse w-8 h-8 bg-gray-300 rounded mb-4"></div>
                                            <p>Loading orders...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Batch Refund Section -->
                    <div class="mt-8 border-t border-slate-800 pt-8">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-white">Batch Refund</h3>
                                <p class="text-sm text-slate-400 mt-1">Process multiple refunds in a single transaction (EVM only)</p>
                            </div>
                            <button id="clearBatchRefunds" class="text-red-400 hover:text-red-300 text-sm">
                                Clear Selection
                            </button>
                        </div>

                        <div id="batchRefundSection" class="bg-slate-950 border border-slate-800 p-6 rounded">
                            <div id="batchRefundEmpty" class="text-center py-8 text-slate-400">
                                Select orders from the table above to add them to batch refund
                            </div>

                            <div id="batchRefundList" class="hidden">
                                <div class="mb-4">
                                    <div class="text-sm text-slate-400 mb-2">Selected Orders (<span id="batchRefundCount">0</span>)</div>
                                    <div id="batchRefundItems" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- Populated dynamically -->
                                    </div>
                                </div>

                                <div class="flex items-center justify-between pt-4 border-t border-slate-800">
                                    <div class="text-white">
                                        Total: <span id="batchRefundTotal" class="font-bold">0</span> USDC
                                    </div>
                                    <button id="executeBatchRefundBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 font-medium transition-colors rounded">
                                        Execute Batch Refund
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wallets Tab -->
                <div id="walletsTab" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-white">Payment Chains &amp; Wallets</h3>
                            <p class="text-sm text-slate-400 mt-1">Configure which blockchains to accept payments on and set your wallet addresses</p>
                        </div>
                        <button
                            id="saveWalletsBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 border font-medium transition-colors"
                        >
                            Save Configuration
                        </button>
                    </div>

                    <div id="walletsContainer" class="space-y-3">
                        <!-- Populated dynamically with chain toggles -->
                    </div>
                </div>

                <!-- Developer Tab -->
                <div id="developerTab" class="tab-content hidden">
                    <div class="space-y-6">

                        <!-- Quick Start Guide -->
                        <div class="bg-gradient-to-br from-blue-900/20 to-purple-900/20 border border-blue-800 p-6">
                            <h2 class="text-2xl font-bold text-white mb-2">Add Crypto Payments in 3 Steps</h2>
                            <p class="text-slate-300 mb-6">Copy-paste this code to accept USDC on your website</p>

                            <div class="space-y-4">
                                <!-- Step 1 -->
                                <div class="bg-slate-950 border border-slate-800 p-4">
                                    <div class="flex items-center mb-3">
                                        <div class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3">1</div>
                                        <h3 class="text-white font-semibold">Add Script to Your Website</h3>
                                    </div>
                                    <p class="text-sm text-slate-400 mb-3">Add this before your closing &lt;/head&gt; tag:</p>
                                    <div class="bg-gray-900 p-3 rounded border border-slate-700 relative">
                                        <pre class="text-xs text-green-400 font-mono overflow-x-auto">&lt;script src="https://stablepay-nine.vercel.app/checkout-widget.js"&gt;&lt;/script&gt;</pre>
                                        <button onclick="copyToClipboard(this, '&lt;script src=&quot;https://stablepay-nine.vercel.app/checkout-widget.js&quot;&gt;&lt;/script&gt;')" class="absolute top-2 right-2 bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded text-xs">
                                            Copy
                                        </button>
                                    </div>
                                </div>

                                <!-- Step 2 -->
                                <div class="bg-slate-950 border border-slate-800 p-4">
                                    <div class="flex items-center mb-3">
                                        <div class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3">2</div>
                                        <h3 class="text-white font-semibold">Add Checkout Widget</h3>
                                    </div>
                                    <p class="text-sm text-slate-400 mb-3">Paste this where you want the payment button:</p>
                                    <div class="bg-gray-900 p-3 rounded border border-slate-700 relative">
                                        <pre class="text-xs text-green-400 font-mono overflow-x-auto" id="widgetCode">&lt;div class="stablepay-checkout"
     data-merchant="<span id="widgetMerchantId" class="text-yellow-400">YOUR_MERCHANT_ID</span>"
     data-amount="10.00"
     data-chain="BASE_MAINNET"&gt;
&lt;/div&gt;</pre>
                                        <button onclick="copyToClipboard(this, document.getElementById('widgetCode').textContent)" class="absolute top-2 right-2 bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded text-xs">
                                            Copy
                                        </button>
                                    </div>
                                </div>

                                <!-- Step 3 -->
                                <div class="bg-slate-950 border border-slate-800 p-4">
                                    <div class="flex items-center mb-3">
                                        <div class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3">3</div>
                                        <h3 class="text-white font-semibold">Test & Go Live!</h3>
                                    </div>
                                    <p class="text-sm text-slate-400 mb-3">That's it! Your customers can now pay with USDC.</p>
                                    <div class="flex space-x-3">
                                        <a href="/docs/GETTING_STARTED.md" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium">
                                            Full Guide
                                        </a>
                                        <button onclick="openTestPayment()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium">
                                            Test Payment
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Your Credentials -->
                        <div class="bg-slate-950 border shadow-sm border p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">Your Credentials</h3>

                            <div class="space-y-4">
                                <div class="bg-slate-900 border border-slate-800 p-4 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="text-sm font-medium text-slate-300">Merchant ID</div>
                                        <button onclick="copyMerchantId()" class="text-blue-400 hover:text-blue-300 text-sm font-medium">
                                            Copy
                                        </button>
                                    </div>
                                    <code class="text-sm bg-slate-950 px-3 py-2 rounded border border-slate-700 inline-block font-mono text-green-400" id="apiMerchantId">Loading...</code>
                                    <p class="text-xs text-slate-500 mt-2">Use this in data-merchant attribute</p>
                                </div>

                                <div class="bg-slate-900 border border-slate-800 p-4 rounded">
                                    <div class="text-sm font-medium text-slate-300 mb-2">Configured Wallets</div>
                                    <div id="configuredWalletsList" class="space-y-2 text-sm">
                                        <div class="text-slate-400">Loading...</div>
                                    </div>
                                </div>

                                <div class="bg-yellow-900/20 border border-yellow-800 p-4 rounded">
                                    <div class="text-sm font-medium text-yellow-300 mb-1">Security</div>
                                    <p class="text-xs text-yellow-200">Your merchant ID is public (safe to use in frontend code). Your wallet private keys stay with you.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Framework Examples -->
                        <div class="bg-slate-950 border shadow-sm border p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-white">Framework Examples</h3>
                                    <p class="text-sm text-slate-400 mt-1">Ready-to-use code for popular frameworks</p>
                                </div>
                                <a href="/docs/EXAMPLES.md" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm font-medium">
                                    View All Examples â†’
                                </a>
                            </div>

                            <!-- Framework Tabs -->
                            <div class="mb-4">
                                <div class="flex space-x-2 border-b border-slate-800">
                                    <button onclick="showFramework('react')" id="tab-react" class="framework-tab px-4 py-2 text-sm font-medium text-slate-400 hover:text-white border-b-2 border-transparent">
                                        React
                                    </button>
                                    <button onclick="showFramework('nextjs')" id="tab-nextjs" class="framework-tab px-4 py-2 text-sm font-medium text-slate-400 hover:text-white border-b-2 border-transparent">
                                        Next.js
                                    </button>
                                    <button onclick="showFramework('vue')" id="tab-vue" class="framework-tab px-4 py-2 text-sm font-medium text-slate-400 hover:text-white border-b-2 border-transparent">
                                        Vue
                                    </button>
                                    <button onclick="showFramework('wordpress')" id="tab-wordpress" class="framework-tab px-4 py-2 text-sm font-medium text-slate-400 hover:text-white border-b-2 border-transparent">
                                        WordPress
                                    </button>
                                </div>
                            </div>

                            <!-- React Example -->
                            <div id="framework-react" class="framework-content hidden">
                                <div class="bg-gray-900 border border-slate-700 p-4 overflow-x-auto relative">
                                    <pre class="text-xs text-green-400 font-mono">import { useEffect } from 'react';

export default function Checkout() {
  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://stablepay-nine.vercel.app/checkout-widget.js';
    document.head.appendChild(script);

    document.addEventListener('stablepay:payment.success', (event) => {
      console.log('Payment successful:', event.detail);
      // Save to your database
    });
  }, []);

  return (
    &lt;div className="stablepay-checkout"
         data-merchant="YOUR_MERCHANT_ID"
         data-amount="10.00"
         data-chain="BASE_MAINNET"&gt;
    &lt;/div&gt;
  );
}</pre>
                                    <button onclick="copyToClipboard(this, document.getElementById('framework-react').querySelector('pre').textContent)" class="absolute top-2 right-2 bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded text-xs">
                                        Copy
                                    </button>
                                </div>
                            </div>

                            <!-- Next.js Example -->
                            <div id="framework-nextjs" class="framework-content hidden">
                                <div class="bg-gray-900 border border-slate-700 p-4 overflow-x-auto relative">
                                    <pre class="text-xs text-green-400 font-mono">'use client';
import Script from 'next/script';

export default function CheckoutPage() {
  return (
    &lt;&gt;
      &lt;Script src="https://stablepay-nine.vercel.app/checkout-widget.js" /&gt;

      &lt;div className="stablepay-checkout"
           data-merchant={process.env.NEXT_PUBLIC_STABLEPAY_MERCHANT_ID}
           data-amount="10.00"
           data-chain="BASE_MAINNET"&gt;
      &lt;/div&gt;
    &lt;/&gt;
  );
}</pre>
                                    <button onclick="copyToClipboard(this, document.getElementById('framework-nextjs').querySelector('pre').textContent)" class="absolute top-2 right-2 bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded text-xs">
                                        Copy
                                    </button>
                                </div>
                            </div>

                            <!-- Vue Example -->
                            <div id="framework-vue" class="framework-content hidden">
                                <div class="bg-gray-900 border border-slate-700 p-4 overflow-x-auto relative">
                                    <pre class="text-xs text-green-400 font-mono">&lt;template&gt;
  &lt;div class="stablepay-checkout"
       :data-merchant="merchantId"
       data-amount="10.00"
       data-chain="BASE_MAINNET"&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { onMounted } from 'vue';

const merchantId = import.meta.env.VITE_STABLEPAY_MERCHANT_ID;

onMounted(() => {
  const script = document.createElement('script');
  script.src = 'https://stablepay-nine.vercel.app/checkout-widget.js';
  document.head.appendChild(script);
});
&lt;/script&gt;</pre>
                                    <button onclick="copyToClipboard(this, document.getElementById('framework-vue').querySelector('pre').textContent)" class="absolute top-2 right-2 bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded text-xs">
                                        Copy
                                    </button>
                                </div>
                            </div>

                            <!-- WordPress Example -->
                            <div id="framework-wordpress" class="framework-content hidden">
                                <div class="bg-gray-900 border border-slate-700 p-4 overflow-x-auto relative">
                                    <pre class="text-xs text-green-400 font-mono">&lt;!-- Add to your WordPress post/page --&gt;

&lt;script src="https://stablepay-nine.vercel.app/checkout-widget.js"&gt;&lt;/script&gt;

&lt;div class="stablepay-checkout"
     data-merchant="YOUR_MERCHANT_ID"
     data-amount="10.00"
     data-chain="BASE_MAINNET"&gt;
&lt;/div&gt;

&lt;!-- Or use shortcode (requires plugin) --&gt;
[stablepay_checkout amount="10.00" product="Premium Membership"]</pre>
                                    <button onclick="copyToClipboard(this, document.getElementById('framework-wordpress').querySelector('pre').textContent)" class="absolute top-2 right-2 bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded text-xs">
                                        Copy
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Resources -->
                        <div class="bg-slate-950 border shadow-sm border p-6">
                            <h3 class="text-lg font-semibold text-white mb-6">Documentation & Resources</h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <a href="/docs/GETTING_STARTED.md" target="_blank" class="bg-slate-900 hover:bg-slate-800 border border-slate-800 p-4 rounded transition-colors group">
                                    <div class="text-white font-semibold mb-2 group-hover:text-blue-400">Getting Started Guide</div>
                                    <p class="text-sm text-slate-400">Complete setup guide in 5 minutes</p>
                                </a>

                                <a href="/docs/API.md" target="_blank" class="bg-slate-900 hover:bg-slate-800 border border-slate-800 p-4 rounded transition-colors group">
                                    <div class="text-white font-semibold mb-2 group-hover:text-blue-400">API Documentation</div>
                                    <p class="text-sm text-slate-400">Full API reference with examples</p>
                                </a>

                                <a href="/docs/EXAMPLES.md" target="_blank" class="bg-slate-900 hover:bg-slate-800 border border-slate-800 p-4 rounded transition-colors group">
                                    <div class="text-white font-semibold mb-2 group-hover:text-blue-400">Code Examples</div>
                                    <p class="text-sm text-slate-400">React, Vue, WordPress & more</p>
                                </a>

                                <a href="/docs/TROUBLESHOOTING.md" target="_blank" class="bg-slate-900 hover:bg-slate-800 border border-slate-800 p-4 rounded transition-colors group">
                                    <div class="text-white font-semibold mb-2 group-hover:text-blue-400">Troubleshooting</div>
                                    <p class="text-sm text-slate-400">Common issues and solutions</p>
                                </a>
                            </div>

                            <div class="mt-6 bg-blue-900/20 border border-blue-800 p-4 rounded">
                                <div class="flex items-start">
                                    <div class="text-blue-400 mr-3 text-xl">ðŸ’¬</div>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-blue-300 mb-1">Need Help?</div>
                                        <p class="text-xs text-blue-200 mb-2">Our support team is here to help you integrate StablePay</p>
                                        <a href="mailto:support@stablepay.com" class="text-sm text-blue-400 hover:text-blue-300 font-medium">
                                            support@stablepay.com
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Links Tab -->
                <div id="paymentsTab" class="tab-content hidden">
                    <div class="bg-slate-950 border border-slate-800 p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">Payment Links</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button
                                id="createDemoStoreBtn"
                                class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-3 border font-medium transition-all shadow-lg hover:shadow-xl"
                            >
                                Create Demo Store
                            </button>
                            <button
                                id="testPaymentBtn"
                                class="bg-black border-2 border-blue-600 hover:border-blue-500 text-blue-400 px-6 py-3 font-medium transition-all"
                            >
                                Test Payment
                            </button>
                        </div>
                        <p class="text-sm text-slate-400 mt-3">
                            Create a demo store with your configured wallets or test a payment flow
                        </p>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content hidden">
                    <div class="space-y-8">
                        <!-- Account Information -->
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4">Account Information</h3>
                            <div class="bg-slate-950 border p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Company Name</label>
                                        <input type="text" id="companyName" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Contact Name</label>
                                        <input type="text" id="contactName" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                                        <input type="email" id="email" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="payment-plan-ref">
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Plan</label>
                                        <input type="text" id="plan" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" readonly>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button id="saveProfileBtn" type="button" class="bg-blue-600 text-white px-6 py-2 border hover:bg-blue-700 transition-colors">
                                        Save Profile
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Wallet Modal -->
    <div id="addWalletModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-slate-950 border max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Add Payment Wallet</h3>
                        <button id="closeWalletModal" class="text-slate-400 hover:text-slate-300">
                            <span class="text-2xl">&times;</span>
                        </button>
                    </div>
                    
                    <form id="addWalletForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Blockchain</label>
                            <select id="walletChain" class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be populated dynamically based on network mode -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Wallet Address</label>
                            <input
                                type="text"
                                id="walletAddress"
                                placeholder="Enter your wallet address"
                                class="w-full px-3 py-2 bg-black text-white border border-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                required
                            >
                            <p class="text-xs text-slate-400 mt-1">This is where USDC payments will be sent</p>
                        </div>
                        <div class="flex space-x-4 pt-4">
                            <button 
                                type="submit"
                                class="flex-1 bg-blue-600 text-white py-2 border hover:bg-blue-700 transition-colors"
                            >
                                Add Wallet
                            </button>
                            <button 
                                type="button"
                                id="cancelWalletModal"
                                class="flex-1 bg-gray-300 text-slate-300 py-2 border hover:bg-gray-400 transition-colors"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Payment Modal -->
    <div id="testPaymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-950 border border-slate-800 shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-white mb-6">Test Payment</h2>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Stablecoin</label>
                    <select id="testToken" class="w-full px-4 py-3 bg-black text-white border border-slate-800 focus:border-blue-600 focus:outline-none">
                        <option value="USDC">USDC</option>
                        <option value="USDT">USDT</option>
                        <option value="EURC">EURC</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Amount</label>
                    <input type="number" id="testAmount" step="0.01" min="0.01" placeholder="0.1"
                           class="w-full px-4 py-3 bg-black text-white border border-slate-800 focus:border-blue-600 focus:outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Select Chain</label>
                    <select id="testChain" class="w-full px-4 py-3 bg-black text-white border border-slate-800 focus:border-blue-600 focus:outline-none">
                        <!-- Populated dynamically -->
                    </select>
                </div>

                <div id="testWalletSelector" class="hidden">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Select Wallet</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="connectMetaMask" class="bg-slate-900 hover:bg-slate-800 border border-slate-700 px-4 py-3 rounded transition-colors">
                            <div class="text-2xl mb-1">ðŸ¦Š</div>
                            <div class="text-sm">MetaMask</div>
                        </button>
                        <button id="connectPhantom" class="bg-slate-900 hover:bg-slate-800 border border-slate-700 px-4 py-3 rounded transition-colors">
                            <div class="text-2xl mb-1">ðŸ‘»</div>
                            <div class="text-sm">Phantom</div>
                        </button>
                    </div>
                </div>

                <div id="testWalletInfo" class="hidden bg-black border border-slate-800 p-4 rounded">
                    <div class="text-xs text-slate-400 mb-1">Payment will be sent to:</div>
                    <div id="testWalletAddress" class="text-sm text-blue-400 font-mono break-all"></div>
                </div>

                <div id="testConnectedWallet" class="hidden bg-green-900/20 border border-green-800 p-4 rounded">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-green-400 mb-1">Connected Wallet</div>
                            <div id="testConnectedAddress" class="text-sm text-white font-mono break-all"></div>
                        </div>
                        <button id="testDisconnectWallet" class="text-red-400 hover:text-red-300 text-sm">
                            Disconnect
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3">
                <button id="testPayBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 font-medium transition-colors">
                    Pay
                </button>
                <button id="closeTestPaymentModal" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 font-medium transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Refund Modal -->
    <div id="refundModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-950 border border-slate-800 shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Process Refund</h3>
                <button id="closeRefundModal" class="text-slate-400 hover:text-slate-300 text-2xl">&times;</button>
            </div>

            <!-- Wallet Connection Section -->
            <div id="refundWalletConnection" class="mb-6">
                <div id="refundWalletNotConnected" class="bg-blue-900/20 border border-blue-800 rounded p-4 mb-4">
                    <div class="text-sm text-blue-300 font-medium mb-3">Connect Your Wallet</div>
                    <div class="text-xs text-blue-400 mb-4">
                        Connect the wallet that will send the refund to the customer
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="refundConnectMetaMask" class="bg-slate-900 hover:bg-slate-800 border border-slate-700 px-4 py-3 rounded transition-colors">
                            <div class="text-2xl mb-1">ðŸ¦Š</div>
                            <div class="text-sm text-white">MetaMask</div>
                        </button>
                        <button id="refundConnectPhantom" class="bg-slate-900 hover:bg-slate-800 border border-slate-700 px-4 py-3 rounded transition-colors">
                            <div class="text-2xl mb-1">ðŸ‘»</div>
                            <div class="text-sm text-white">Phantom</div>
                        </button>
                    </div>
                </div>

                <div id="refundWalletConnected" class="hidden bg-green-900/20 border border-green-800 p-4 rounded mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-green-400 mb-1">Connected Wallet</div>
                            <div id="refundConnectedAddress" class="text-sm text-white font-mono break-all"></div>
                        </div>
                        <button id="refundDisconnectWallet" class="text-red-400 hover:text-red-300 text-sm">
                            Disconnect
                        </button>
                    </div>
                </div>
            </div>

            <!-- Refund Details -->
            <div class="space-y-4" id="refundDetailsSection">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Order ID</label>
                    <input type="text" id="refundOrderId" readonly
                           class="w-full px-4 py-3 bg-slate-900 border border-slate-700 text-white rounded">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Original Amount</label>
                    <input type="text" id="refundOriginalAmount" readonly
                           class="w-full px-4 py-3 bg-slate-900 border border-slate-700 text-white rounded">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Chain</label>
                    <input type="text" id="refundChain" readonly
                           class="w-full px-4 py-3 bg-slate-900 border border-slate-700 text-white rounded">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Refund Amount (USDC)</label>
                    <input type="number" id="refundAmount" step="0.01" min="0.01"
                           placeholder="Enter amount to refund"
                           class="w-full px-4 py-3 bg-slate-900 border border-slate-700 text-white rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    <div class="text-xs text-slate-500 mt-1">Partial refunds are allowed</div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Reason for Refund</label>
                    <textarea id="refundReason" rows="3"
                              placeholder="Explain why you're issuing this refund..."
                              class="w-full px-4 py-3 bg-slate-900 border border-slate-700 text-white rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Customer Wallet Address</label>
                    <input type="text" id="refundCustomerWallet"
                           placeholder="0x... or Solana address"
                           class="w-full px-4 py-3 bg-slate-900 border border-slate-700 text-white font-mono text-sm rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    <div class="text-xs text-slate-500 mt-1">Address where refund will be sent</div>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button id="executeRefundBtn" disabled
                        class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 font-medium transition-colors rounded disabled:bg-slate-700 disabled:cursor-not-allowed">
                    Execute Refund
                </button>
                <button id="cancelRefundBtn"
                        class="flex-1 bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 font-medium transition-colors rounded">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script>
        // SPL Token helper functions
        const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');
        const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL');

        async function getAssociatedTokenAddress(mint, owner) {
            const [address] = await solanaWeb3.PublicKey.findProgramAddress(
                [owner.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), mint.toBuffer()],
                ASSOCIATED_TOKEN_PROGRAM_ID
            );
            return address;
        }

        function createAssociatedTokenAccountInstruction(payer, associatedToken, owner, mint) {
            const keys = [
                { pubkey: payer, isSigner: true, isWritable: true },
                { pubkey: associatedToken, isSigner: false, isWritable: true },
                { pubkey: owner, isSigner: false, isWritable: false },
                { pubkey: mint, isSigner: false, isWritable: false },
                { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
                { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
            ];

            // ATA program expects empty instruction data
            const data = new Uint8Array(0);

            return new solanaWeb3.TransactionInstruction({
                keys,
                programId: ASSOCIATED_TOKEN_PROGRAM_ID,
                data
            });
        }

        function createTransferInstruction(source, destination, owner, amount) {
            // Create data buffer for SPL token transfer instruction
            const dataArr = new Uint8Array(9);
            dataArr[0] = 3; // Transfer instruction index

            // Write amount as little-endian u64
            const amountBigInt = BigInt(amount);

            // Manual little-endian encoding for u64
            for (let i = 0; i < 8; i++) {
                dataArr[1 + i] = Number((amountBigInt >> BigInt(i * 8)) & BigInt(0xFF));
            }

            console.log('Transfer instruction data created:', Array.from(dataArr));
            console.log('Amount to encode:', amount, 'as BigInt:', amountBigInt.toString());

            const keys = [
                { pubkey: source, isSigner: false, isWritable: true },
                { pubkey: destination, isSigner: false, isWritable: true },
                { pubkey: owner, isSigner: true, isWritable: false }
            ];

            return new solanaWeb3.TransactionInstruction({
                keys,
                programId: TOKEN_PROGRAM_ID,
                data: dataArr
            });
        }

        // Create splToken namespace for compatibility
        window.splToken = {
            getAssociatedTokenAddress,
            createAssociatedTokenAccountInstruction,
            createTransferInstruction
        };
    </script>
    <script>
        let currentMerchant = null;
        let currentTab = 'orders';
        let merchantWallets = [];

        // Apply system settings visibility
        function applySystemSettings() {
            const showPaymentPlans = localStorage.getItem('showPaymentPlans') !== 'false';

            const planElements = document.querySelectorAll('.payment-plan-ref');
            planElements.forEach(el => {
                el.style.display = showPaymentPlans ? '' : 'none';
            });
        }

        // Chain configuration - grouped by blockchain
        const CHAIN_GROUPS = [
            {
                name: 'Base',
                icon: 'ðŸ”µ',
                networks: [
                    { id: 'BASE_MAINNET', label: 'Mainnet', type: 'mainnet' },
                    { id: 'BASE_SEPOLIA', label: 'Sepolia (Testnet)', type: 'testnet' }
                ]
            },
            {
                name: 'Ethereum',
                icon: 'âŸ ',
                networks: [
                    { id: 'ETHEREUM_MAINNET', label: 'Mainnet', type: 'mainnet' },
                    { id: 'ETHEREUM_SEPOLIA', label: 'Sepolia (Testnet)', type: 'testnet' }
                ]
            },
            {
                name: 'Polygon',
                icon: 'ðŸŸ£',
                networks: [
                    { id: 'POLYGON_MAINNET', label: 'Mainnet', type: 'mainnet' },
                    { id: 'POLYGON_MUMBAI', label: 'Mumbai (Testnet)', type: 'testnet' }
                ]
            },
            {
                name: 'Arbitrum',
                icon: 'ðŸ”·',
                networks: [
                    { id: 'ARBITRUM_MAINNET', label: 'Mainnet', type: 'mainnet' },
                    { id: 'ARBITRUM_SEPOLIA', label: 'Sepolia (Testnet)', type: 'testnet' }
                ]
            },
            {
                name: 'Solana',
                icon: 'ðŸŒž',
                networks: [
                    { id: 'SOLANA_MAINNET', label: 'Mainnet', type: 'mainnet' },
                    { id: 'SOLANA_DEVNET', label: 'Devnet (Testnet)', type: 'testnet' }
                ]
            }
        ];

        // Legacy CHAINS array for compatibility with other functions
        const CHAINS = CHAIN_GROUPS.flatMap(group =>
            group.networks.map(net => ({
                id: net.id,
                name: `${group.name} ${net.label}`,
                network: net.type,
                icon: group.icon
            }))
        );

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-400');
                btn.classList.add('border-transparent', 'text-slate-400', 'hover:text-slate-300', 'hover:border-slate-800');
            });
            
            // Highlight active tab
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.remove('border-transparent', 'text-slate-400', 'hover:text-slate-300', 'hover:border-slate-800');
            activeBtn.classList.add('border-blue-500', 'text-blue-400');
            
            currentTab = tabName;
            
            // Load tab content
            if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'wallets') {
                loadWallets();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }


        // Load merchant data
        const PRICING_TIERS = {
            FREE: {
                name: 'Free',
                limit: null, // No combined limit
                testnetLimit: null, // Unlimited testnet
                mainnetLimit: 100, // $100 mainnet
                mainnetTxLimit: 10, // 10 mainnet transactions
                blockchains: 1,
                fee: '0.5%',
                refunds: true,
                webhooks: true
            },
            STARTER: { name: 'Starter', limit: 100000, blockchains: 6, fee: '0.5%', refunds: true, webhooks: true },
            PRO: { name: 'Pro', limit: null, blockchains: 6, fee: '0.3%', refunds: true, webhooks: true },
            ENTERPRISE: { name: 'Enterprise', limit: null, blockchains: 6, fee: '0.2%', refunds: true, webhooks: true }
        };

        function updatePricingTierDisplay(merchant) {
            const plan = merchant.plan || 'FREE';
            const tier = PRICING_TIERS[plan];
            if (!tier) return;

            // Update plan name
            document.getElementById('currentPlanName').textContent = tier.name.toUpperCase() + ' TIER';

            // Update usage - special handling for FREE tier with mainnet/testnet split
            if (plan === 'FREE') {
                const mainnetVolumeUsed = parseFloat(merchant.mainnetVolumeUsed || 0);
                const mainnetTxns = merchant.mainnetTransactions || 0;
                const testnetVolumeUsed = parseFloat(merchant.testnetVolumeUsed || 0);
                const testnetTxns = merchant.testnetTransactions || 0;

                // Show mainnet usage (what matters for FREE tier)
                const volumePercentage = Math.min((mainnetVolumeUsed / tier.mainnetLimit) * 100, 100);
                const txnPercentage = Math.min((mainnetTxns / tier.mainnetTxLimit) * 100, 100);
                const maxPercentage = Math.max(volumePercentage, txnPercentage);

                document.getElementById('volumeUsageBar').style.width = maxPercentage + '%';
                document.getElementById('volumeUsageText').innerHTML = `
                    <div class="text-sm">
                        <div><strong>Mainnet:</strong> ${mainnetTxns}/${tier.mainnetTxLimit} txns | $${mainnetVolumeUsed.toFixed(2)}/$${tier.mainnetLimit}</div>
                        <div class="text-xs text-gray-600 mt-1"><strong>Testnet:</strong> ${testnetTxns} txns | $${testnetVolumeUsed.toFixed(2)} (unlimited)</div>
                    </div>
                `;

                // Change color based on usage
                const bar = document.getElementById('volumeUsageBar');
                if (maxPercentage >= 90) bar.style.background = '#EF4444'; // Red
                else if (maxPercentage >= 75) bar.style.background = '#F59E0B'; // Orange
                else bar.style.background = '#7C4DFF'; // Indigo
            } else {
                // Standard volume tracking for other tiers
                const volumeUsed = parseFloat(merchant.monthlyVolumeUsed || 0);
                const volumeLimit = tier.limit;

                if (volumeLimit) {
                    const percentage = Math.min((volumeUsed / volumeLimit) * 100, 100);
                    document.getElementById('volumeUsageBar').style.width = percentage + '%';
                    document.getElementById('volumeUsageText').textContent = `$${volumeUsed.toFixed(2)} / $${volumeLimit.toLocaleString()}`;

                    // Change color based on usage
                    const bar = document.getElementById('volumeUsageBar');
                    if (percentage >= 90) bar.style.background = '#EF4444'; // Red
                    else if (percentage >= 75) bar.style.background = '#F59E0B'; // Orange
                    else bar.style.background = '#7C4DFF'; // Indigo
                } else {
                    document.getElementById('volumeUsageBar').style.width = '0%';
                    document.getElementById('volumeUsageText').textContent = `$${volumeUsed.toFixed(2)} / Unlimited`;
                }
            }

            // Calculate days until reset
            if (merchant.billingCycleStart) {
                const cycleStart = new Date(merchant.billingCycleStart);
                const now = new Date();
                const daysPassed = Math.floor((now - cycleStart) / (1000 * 60 * 60 * 24));
                const daysRemaining = Math.max(30 - daysPassed, 0);
                document.getElementById('billingCycleText').textContent = `Billing cycle resets in ${daysRemaining} days`;
            }

            // Update features
            document.getElementById('planBlockchains').textContent = tier.blockchains;
            document.getElementById('planFee').textContent = tier.fee;
            document.getElementById('planRefunds').textContent = tier.refunds ? 'Yes' : 'No';
            document.getElementById('planWebhooks').textContent = tier.webhooks ? 'Yes' : 'No';

            // Show/hide upgrade button
            const upgradeBtn = document.getElementById('upgradeBtn');
            if (plan === 'ENTERPRISE') {
                upgradeBtn.style.display = 'none';
            } else {
                upgradeBtn.style.display = 'block';
                upgradeBtn.onclick = () => window.location.href = '/pricing.html';
            }
        }

        async function loadMerchantData() {
            try {
                // Get merchant ID and token from session
                const merchantId = sessionStorage.getItem('merchantId');
                const merchantToken = sessionStorage.getItem('merchantToken');
                
                if (!merchantId && !merchantToken) {
                    console.error('No merchant authentication found');
                    window.location.href = '/login.html';
                    return;
                }

                // Fetch actual merchant data from API
                console.log('Loading merchant data with:', { merchantId, hasToken: !!merchantToken });
                const response = await fetch(`/api/merchant-profile?${merchantId ? 'id=' + merchantId : 'token=' + merchantToken}`);

                console.log('API response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error:', errorText);
                    throw new Error('Failed to load merchant data: ' + errorText);
                }

                currentMerchant = await response.json();
                console.log('Loaded merchant:', currentMerchant);

                // Set defaults if missing
                currentMerchant.plan = currentMerchant.plan || 'STARTER';
                currentMerchant.networkMode = currentMerchant.networkMode || 'TESTNET';
                currentMerchant.paymentMode = currentMerchant.paymentMode || 'DIRECT';

                // Apply visibility settings based on merchant config
                applySystemSettings();

                document.getElementById('merchantName').textContent = currentMerchant.companyName;

                // Update profile card
                document.getElementById('profileCompanyName').textContent = currentMerchant.companyName;
                document.getElementById('profileEmail').textContent = currentMerchant.email;
                document.getElementById('profileContact').textContent = currentMerchant.contactName;
                document.getElementById('profilePlan').textContent = currentMerchant.plan || 'None';
                document.getElementById('profileOrderCount').textContent = currentMerchant.orderCount || 0;

                // Format created date
                if (currentMerchant.createdAt) {
                    const created = new Date(currentMerchant.createdAt);
                    document.getElementById('profileCreatedAt').textContent = created.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                }

                // Update pricing tier card
                updatePricingTierDisplay(currentMerchant);

                // Update status badge
                const statusBadge = document.getElementById('profileStatusBadge');
                if (currentMerchant.isActive) {
                    statusBadge.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium mb-2 bg-green-900/20 text-green-800';
                    statusBadge.innerHTML = '<span>Active</span>';
                    document.getElementById('pendingBanner').classList.add('hidden');
                } else {
                    statusBadge.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium mb-2 bg-yellow-900/20 text-yellow-800';
                    statusBadge.innerHTML = '<span>Pending Approval</span>';
                    document.getElementById('pendingBanner').classList.remove('hidden');
                }

                // Update settings form
                document.getElementById('companyName').value = currentMerchant.companyName;
                document.getElementById('contactName').value = currentMerchant.contactName;
                document.getElementById('email').value = currentMerchant.email;
                document.getElementById('plan').value = currentMerchant.plan;

                // Update API developer section
                document.getElementById('apiMerchantId').textContent = currentMerchant.id;

                // Update merchant ID in code example
                const exampleMerchantId = document.getElementById('exampleMerchantId');
                if (exampleMerchantId) {
                    exampleMerchantId.textContent = currentMerchant.id;
                }

                // Update widget code with merchant ID
                updateWidgetCode();

                // Load current tab content after merchant data is ready
                if (currentTab === 'orders') {
                    loadOrders();
                } else if (currentTab === 'wallets') {
                    loadWallets();
                }
            } catch (error) {
                console.error('Error loading merchant data:', error);
                // Show error to user
                document.getElementById('merchantName').textContent = 'Error Loading Data';
                alert('Failed to load merchant data. Please check console for details.');
            }
        }

        // Test Create Order API
        window.testCreateOrder = async function() {
            if (!currentMerchant) {
                alert('Please wait for merchant data to load');
                return;
            }

            if (merchantWallets.length === 0) {
                alert('Please configure at least one wallet first');
                return;
            }

            // Use first configured chain
            const firstChain = merchantWallets[0].chain;

            try {
                const response = await fetch('/api/v1/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('merchantToken')}`
                    },
                    body: JSON.stringify({
                        merchantId: currentMerchant.id,
                        amount: '10.00',
                        chain: firstChain,
                        customerEmail: 'test@example.com',
                        customerName: 'API Test Order',
                        paymentAddress: merchantWallets[0].address
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`[SUCCESS] Test order created successfully!\n\nOrder ID: ${result.order.id}\nChain: ${firstChain}\nAmount: 10.00 USDC\nStatus: ${result.order.status}\n\nCheck the Orders tab to see it!`);
                } else {
                    alert(`[ERROR] Test failed: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`[ERROR] Test failed: ${error.message}`);
            }
        };

        // Load orders
        async function loadOrders() {
            try {
                if (!currentMerchant?.id) {
                    renderOrdersTable([]);
                    updateStats({ orders: [], pagination: { total: 0 } });
                    return;
                }

                // Fetch orders for this merchant
                const response = await fetch(`/api/v1/orders?merchantId=${currentMerchant.id}`);

                if (response.ok) {
                    const orders = await response.json();
                    allOrders = orders;
                    updateStats({ orders, pagination: { total: orders.length } });
                    renderOrdersTable(orders);
                } else {
                    // No orders yet
                    allOrders = [];
                    renderOrdersTable([]);
                    updateStats({ orders: [], pagination: { total: 0 } });
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                renderOrdersTable([]);
                updateStats({ orders: [], pagination: { total: 0 } });
            }
        }

        function updateStats(data) {
            const total = data.pagination ? data.pagination.total : data.orders.length;
            const confirmed = data.orders.filter(o => o.status === 'PAID' || o.status === 'CONFIRMED').length;
            const pending = data.orders.filter(o => o.status === 'PENDING').length;
            const totalVolume = data.orders
                .filter(o => o.status === 'CONFIRMED' || o.status === 'PAID')
                .reduce((sum, o) => {
                    const amount = typeof o.amount === 'object' ? parseFloat(o.amount.toString()) : parseFloat(o.amount || 0);
                    return sum + amount;
                }, 0);

            document.getElementById('totalOrders').textContent = total;
            document.getElementById('confirmedOrders').textContent = confirmed;
            document.getElementById('pendingOrders').textContent = pending;
            document.getElementById('totalVolume').textContent = '$' + totalVolume.toFixed(2);
        }

        function renderOrdersTable(orders) {
            const tbody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-slate-400">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const statusClass = `status-${order.status.toLowerCase()}`;
                const shortId = order.id.slice(0, 8) + '...';
                const createdAt = new Date(order.createdAt).toLocaleDateString();
                const amount = typeof order.amount === 'object' ? order.amount.toString() : order.amount;

                // Get transaction hash from transactions array
                const txHash = order.transactions && order.transactions.length > 0
                    ? order.transactions[0].txHash
                    : null;
                const explorerUrl = txHash ? getExplorerUrl(order.chain, txHash) : null;

                return `
                    <tr class="hover:bg-slate-950">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-white">${shortId}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-white">${amount} USDC</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-slate-400">${order.chain.replace('_', ' ')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${order.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${txHash ? `
                                <a href="${explorerUrl}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs font-mono">
                                    ${txHash.slice(0, 6)}...${txHash.slice(-4)}
                                    <span class="ml-1">â†—</span>
                                </a>
                            ` : '<span class="text-slate-500 text-xs">Pending</span>'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${(order.status === 'CONFIRMED' || order.status === 'PAID') ? `
                                <button onclick="viewReceipt('${order.id}')" class="text-blue-400 hover:text-blue-300 text-xs">
                                    View Receipt
                                </button>
                            ` : '<span class="text-slate-500 text-xs">-</span>'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-slate-400">${order.customerEmail || 'Anonymous'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">
                            ${createdAt}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${(order.status === 'CONFIRMED' || order.status === 'PAID') ? `
                                <div class="flex gap-2">
                                    <button onclick="openRefundModal('${order.id}', '${amount}', '${order.chain}')"
                                            class="text-orange-400 hover:text-orange-300 text-xs font-medium">
                                        Refund
                                    </button>
                                    ${!order.chain.includes('SOLANA') ? `
                                        <button onclick="addToBatchRefund('${order.id}')"
                                                class="text-blue-400 hover:text-blue-300 text-xs font-medium">
                                            + Batch
                                        </button>
                                    ` : ''}
                                </div>
                            ` : '<span class="text-slate-600 text-xs">-</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Orders sorting and filtering
        let allOrders = [];
        let currentSortField = 'created';
        let currentSortDirection = 'desc';

        function sortOrders(field) {
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }

            const sorted = [...allOrders].sort((a, b) => {
                let aVal, bVal;

                switch(field) {
                    case 'amount':
                        aVal = typeof a.amount === 'object' ? parseFloat(a.amount.toString()) : parseFloat(a.amount);
                        bVal = typeof b.amount === 'object' ? parseFloat(b.amount.toString()) : parseFloat(b.amount);
                        break;
                    case 'created':
                        aVal = new Date(a.createdAt);
                        bVal = new Date(b.createdAt);
                        break;
                    case 'status':
                        aVal = a.status;
                        bVal = b.status;
                        break;
                    case 'chain':
                        aVal = a.chain;
                        bVal = b.chain;
                        break;
                    case 'customer':
                        aVal = a.customerEmail || '';
                        bVal = b.customerEmail || '';
                        break;
                    default:
                        aVal = a.id;
                        bVal = b.id;
                }

                if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderOrdersTable(sorted);
        }

        // Search/filter orders
        document.getElementById('orderSearchInput')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allOrders.filter(order => {
                return (
                    order.id.toLowerCase().includes(searchTerm) ||
                    order.chain.toLowerCase().includes(searchTerm) ||
                    order.status.toLowerCase().includes(searchTerm) ||
                    (order.customerEmail && order.customerEmail.toLowerCase().includes(searchTerm)) ||
                    (order.amount && order.amount.toString().includes(searchTerm))
                );
            });
            renderOrdersTable(filtered);
        });

        // Load wallets
        async function loadWallets() {
            if (!currentMerchant) {
                console.log('loadWallets: currentMerchant not loaded yet');
                return;
            }

            console.log('loadWallets: Loading wallets for merchant', currentMerchant.id);

            try {
                // Use wallets from currentMerchant (already loaded from merchant-profile API)
                if (currentMerchant.wallets) {
                    merchantWallets = currentMerchant.wallets;
                    console.log('loadWallets: Using cached wallets', merchantWallets.length, 'wallets');
                } else {
                    merchantWallets = [];
                    console.log('loadWallets: No wallets found for merchant');
                }

                renderChainToggles();
            } catch (error) {
                console.error('Error loading wallets:', error);
                merchantWallets = [];
                renderChainToggles();
            }
        }

        // Render chain toggles
        function renderChainToggles() {
            const container = document.getElementById('walletsContainer');
            console.log('renderChainToggles: Rendering', CHAIN_GROUPS.length, 'chain groups with', merchantWallets.length, 'existing wallets');

            container.innerHTML = CHAIN_GROUPS.map(group => {
                // Check if any network in this group has a wallet
                const hasAnyWallet = group.networks.some(net =>
                    merchantWallets.find(w => w.chain === net.id)
                );

                return `
                    <div class="bg-slate-950 border p-5 border-slate-800 hover:border-slate-700 transition">
                        <div class="flex items-center space-x-3 mb-4">
                            <span class="text-3xl">${group.icon}</span>
                            <div class="flex-1">
                                <div class="font-semibold text-white text-lg">${group.name}</div>
                                <div class="text-xs text-slate-500">Configure wallet addresses for each network</div>
                            </div>
                        </div>

                        <div class="space-y-3 ml-11">
                            ${group.networks.map(network => {
                                const wallet = merchantWallets.find(w => w.chain === network.id);
                                const isEnabled = !!wallet;
                                const address = wallet?.address || '';

                                return `
                                    <div class="border border-slate-800 bg-slate-900/50 rounded p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="flex items-center space-x-3 cursor-pointer flex-1">
                                                <input type="checkbox"
                                                       class="chain-toggle w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2"
                                                       data-chain="${network.id}"
                                                       ${isEnabled ? 'checked' : ''}
                                                       onchange="toggleChainInput('${network.id}')">
                                                <div>
                                                    <div class="font-medium text-white text-sm">${network.label}</div>
                                                    <div class="text-xs text-slate-500">${network.type === 'mainnet' ? 'Production' : 'Testing'}</div>
                                                </div>
                                            </label>
                                        </div>
                                        <div id="wallet-input-${network.id}" class="${isEnabled ? '' : 'hidden'}">
                                            <input type="text"
                                                   class="w-full px-3 py-2 text-sm bg-slate-950 border border-slate-700 text-white font-mono rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                                   placeholder="${network.id.includes('SOLANA') ? 'Solana address...' : '0x... Ethereum address'}"
                                                   data-wallet-chain="${network.id}"
                                                   value="${address}">
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle chain input visibility
        window.toggleChainInput = function(chainId) {
            const input = document.getElementById(`wallet-input-${chainId}`);
            const checkbox = document.querySelector(`input[data-chain="${chainId}"]`);

            if (checkbox.checked) {
                input.classList.remove('hidden');
            } else {
                input.classList.add('hidden');
                const walletInput = input.querySelector('input');
                if (walletInput) walletInput.value = '';
            }
        };

        // Save wallets
        document.getElementById('saveWalletsBtn').addEventListener('click', async () => {
            if (!currentMerchant) return;

            // Collect wallet configurations
            const wallets = [];
            document.querySelectorAll('.chain-toggle').forEach(toggle => {
                if (toggle.checked) {
                    const chain = toggle.dataset.chain;
                    const addressInput = document.querySelector(`input[data-wallet-chain="${chain}"]`);
                    const address = addressInput?.value.trim();

                    if (address) {
                        wallets.push({ chain, address });
                    }
                }
            });

            try {
                const merchantToken = sessionStorage.getItem('merchantToken');
                const response = await fetch(`/api/v1/admin?resource=wallets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${merchantToken}`
                    },
                    body: JSON.stringify({
                        merchantId: currentMerchant.id,
                        wallets
                    })
                });

                if (response.ok) {
                    alert('Wallet configuration saved successfully!');
                    loadWallets(); // Reload
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save wallets'));
                }
            } catch (error) {
                alert('Error saving wallets: ' + error.message);
            }
        });

        // Create Demo Store
        document.getElementById('createDemoStoreBtn').addEventListener('click', async () => {
            if (!currentMerchant) {
                alert('Please wait for merchant data to load');
                return;
            }

            if (merchantWallets.length === 0) {
                alert('Please configure at least one wallet before creating a demo store');
                return;
            }

            // Generate a unique store URL for this merchant
            const storeUrl = `${window.location.origin}/store.html?merchant=${currentMerchant.id}`;

            // Show modal with store URL and preview
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-slate-950 border shadow-2xl p-8 max-w-2xl w-full mx-4">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4"></div>
                        <h2 class="text-3xl font-bold text-white mb-2">Demo Store Created!</h2>
                        <p class="text-slate-400">Your custom payment store is ready with your configured wallets</p>
                    </div>

                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border p-6 mb-6 border border-purple-200">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-slate-300">Your Store URL:</span>
                            <button onclick="navigator.clipboard.writeText('${storeUrl}'); alert('Copied!')"
                                    class="text-blue-400 hover:text-blue-700 text-sm font-medium">
                                Copy
                            </button>
                        </div>
                        <div class="bg-slate-950 border p-3 border border-slate-800">
                            <code class="text-sm text-purple-700 break-all">${storeUrl}</code>
                        </div>
                    </div>

                    <div class="bg-blue-50 border p-4 mb-6 border border-blue-200">
                        <h4 class="font-semibold text-blue-900 mb-2">Store Features:</h4>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>${merchantWallets.length} blockchain${merchantWallets.length > 1 ? 's' : ''} enabled</li>
                            <li>Accepts USDC payments</li>
                            <li>Real-time order tracking</li>
                            <li>Automatic wallet selection</li>
                        </ul>
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="window.open('${storeUrl}', '_blank')"
                                class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-3 border font-medium transition-all">
                            Open Store
                        </button>
                        <button onclick="this.closest('.fixed').remove()"
                                class="px-6 py-3 border border-slate-800 border text-slate-300 hover:bg-slate-950 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        });

        // Test Payment Modal
        let testPaymentProvider = null;
        let testPaymentSigner = null;
        let testConnectedWalletAddress = null;
        let testWalletType = null; // 'metamask' or 'phantom'

        document.getElementById('testPaymentBtn').addEventListener('click', () => {
            if (merchantWallets.length === 0) {
                alert('Please configure at least one wallet first');
                return;
            }

            // Populate chain selector with only chains that have wallets
            const testChain = document.getElementById('testChain');
            testChain.innerHTML = merchantWallets.map(w => {
                const chain = CHAINS.find(c => c.id === w.chain);
                return `<option value="${w.chain}">${chain ? chain.icon + ' ' + chain.name : w.chain}</option>`;
            }).join('');

            // Show wallet address for first chain
            if (merchantWallets.length > 0) {
                updateTestWalletDisplay(merchantWallets[0].chain);
            }

            // Show wallet selector initially
            document.getElementById('testWalletSelector').classList.remove('hidden');

            // Show modal
            document.getElementById('testPaymentModal').classList.remove('hidden');
        });

        document.getElementById('closeTestPaymentModal').addEventListener('click', () => {
            document.getElementById('testPaymentModal').classList.add('hidden');
            resetTestPaymentModal();
        });

        document.getElementById('testChain').addEventListener('change', (e) => {
            const chainId = e.target.value;
            updateTestWalletDisplay(chainId);

            // Reset wallet connection when chain changes
            resetWalletConnection();

            // Show wallet selector based on chain type
            const isSolana = chainId.includes('SOLANA');
            if (isSolana) {
                document.getElementById('testWalletSelector').classList.remove('hidden');
            } else {
                document.getElementById('testWalletSelector').classList.remove('hidden');
            }
        });

        function updateTestWalletDisplay(chainId) {
            const wallet = merchantWallets.find(w => w.chain === chainId);
            if (wallet) {
                document.getElementById('testWalletAddress').textContent = wallet.address;
                document.getElementById('testWalletInfo').classList.remove('hidden');
            }
        }

        function resetWalletConnection() {
            testConnectedWalletAddress = null;
            testWalletType = null;
            document.getElementById('testConnectedWallet').classList.add('hidden');
            document.getElementById('testWalletSelector').classList.remove('hidden');
        }

        function resetTestPaymentModal() {
            resetWalletConnection();
            testPaymentProvider = null;
            testPaymentSigner = null;
            document.getElementById('testWalletSelector').classList.add('hidden');
        }

        // MetaMask connection
        document.getElementById('connectMetaMask').addEventListener('click', async () => {
            try {
                // Check for MetaMask specifically, not just window.ethereum
                // Phantom also injects window.ethereum, so we need to distinguish
                let ethereum = window.ethereum;

                // If multiple providers exist, find MetaMask
                if (window.ethereum?.providers) {
                    ethereum = window.ethereum.providers.find(p => p.isMetaMask);
                } else if (!window.ethereum?.isMetaMask && window.ethereum?.isPhantom) {
                    // If only Phantom is installed
                    alert('Please install MetaMask. Phantom is detected but MetaMask is required for EVM chains.');
                    window.open('https://metamask.io/download/', '_blank');
                    return;
                }

                if (!ethereum) {
                    alert('Please install MetaMask');
                    window.open('https://metamask.io/download/', '_blank');
                    return;
                }

                const accounts = await ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts || accounts.length === 0) {
                    alert('No accounts found');
                    return;
                }

                testPaymentProvider = new ethers.BrowserProvider(ethereum);
                testPaymentSigner = await testPaymentProvider.getSigner();
                testConnectedWalletAddress = await testPaymentSigner.getAddress();
                testWalletType = 'metamask';

                document.getElementById('testConnectedAddress').textContent =
                    testConnectedWalletAddress.slice(0, 6) + '...' + testConnectedWalletAddress.slice(-4);
                document.getElementById('testConnectedWallet').classList.remove('hidden');
                document.getElementById('testWalletSelector').classList.add('hidden');

            } catch (error) {
                console.error('MetaMask connection error:', error);
                alert('Failed to connect MetaMask: ' + error.message);
            }
        });

        // Phantom connection
        document.getElementById('connectPhantom').addEventListener('click', async () => {
            try {
                const phantom = window.solana;
                if (!phantom?.isPhantom) {
                    alert('Please install Phantom wallet');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }

                const resp = await phantom.connect();
                testConnectedWalletAddress = resp.publicKey.toString();
                testWalletType = 'phantom';

                document.getElementById('testConnectedAddress').textContent =
                    testConnectedWalletAddress.slice(0, 6) + '...' + testConnectedWalletAddress.slice(-4);
                document.getElementById('testConnectedWallet').classList.remove('hidden');
                document.getElementById('testWalletSelector').classList.add('hidden');

            } catch (error) {
                console.error('Phantom connection error:', error);
                alert('Failed to connect Phantom: ' + error.message);
            }
        });

        // Disconnect wallet
        document.getElementById('testDisconnectWallet').addEventListener('click', () => {
            resetWalletConnection();
        });

        document.getElementById('testPayBtn').addEventListener('click', async () => {
            const amount = document.getElementById('testAmount').value;
            const chainId = document.getElementById('testChain').value;
            const token = document.getElementById('testToken').value;

            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            if (!testConnectedWalletAddress) {
                alert('Please connect your wallet first');
                return;
            }

            const wallet = merchantWallets.find(w => w.chain === chainId);
            if (!wallet) {
                alert('Wallet not found for selected chain');
                return;
            }

            // Check if correct wallet type for chain
            const isSolana = chainId.includes('SOLANA');
            if (isSolana && testWalletType !== 'phantom') {
                alert('Please connect Phantom wallet for Solana');
                return;
            }
            if (!isSolana && testWalletType !== 'metamask') {
                alert('Please connect MetaMask for EVM chains');
                return;
            }

            await initiateTestPayment(amount, chainId, wallet.address, token);
        });

        async function initiateTestPayment(amount, chainId, merchantWallet, token) {
            try {
                const isSolana = chainId.includes('SOLANA');

                if (isSolana) {
                    await initiateSolanaPayment(amount, chainId, merchantWallet, token);
                } else {
                    await initiateEVMPayment(amount, chainId, merchantWallet, token);
                }

            } catch (error) {
                console.error('Test payment error:', error);
                alert('Payment failed: ' + error.message);
            }
        }

        async function initiateEVMPayment(amount, chainId, merchantWallet, token) {
            try {
                // Get the correct Ethereum provider (MetaMask)
                let ethereum = window.ethereum;
                if (window.ethereum?.providers) {
                    ethereum = window.ethereum.providers.find(p => p.isMetaMask);
                }

                // Check if MetaMask is connected
                if (!ethereum || !ethereum.isConnected()) {
                    alert('MetaMask disconnected. Please refresh the page and try again.');
                    return;
                }

                console.log('Connected wallet:', testConnectedWalletAddress);

                // Get chain config
                const chainConfig = getChainConfig(chainId, token);
                if (!chainConfig) {
                    alert('Chain configuration not found');
                    return;
                }

                // Switch to correct network
                const network = await testPaymentProvider.getNetwork();
                const currentChainId = network.chainId;
                const targetChainId = parseInt(chainConfig.chainId, 16);

                if (currentChainId !== BigInt(targetChainId)) {
                    try {
                        await ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: chainConfig.chainId }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: chainConfig.chainId,
                                    chainName: chainConfig.chainName,
                                    rpcUrls: chainConfig.rpcUrls,
                                    nativeCurrency: chainConfig.nativeCurrency,
                                    blockExplorerUrls: chainConfig.blockExplorerUrls
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }

                    testPaymentProvider = new ethers.BrowserProvider(ethereum);
                    testPaymentSigner = await testPaymentProvider.getSigner();
                }

                // Create order first
                const orderResponse = await fetch('/api/v1/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        merchantId: currentMerchant.id,
                        productName: `Test Payment - ${currentMerchant.companyName}`,
                        amount: parseFloat(amount),
                        chain: chainId,
                        customerEmail: testConnectedWalletAddress,
                        paymentAddress: merchantWallet
                    })
                });

                if (!orderResponse.ok) {
                    const errorData = await orderResponse.json();
                    console.error('Order creation failed:', errorData);
                    throw new Error(errorData.error || errorData.details || 'Failed to create order');
                }

                const orderData = await orderResponse.json();
                console.log('Order created:', orderData);

                // Get token info for better display
                const tokenContract = new ethers.Contract(
                    chainConfig.tokenAddress,
                    [
                        'function transfer(address to, uint256 amount) returns (bool)',
                        'function name() view returns (string)',
                        'function symbol() view returns (string)',
                        'function decimals() view returns (uint8)'
                    ],
                    testPaymentSigner
                );

                // Fetch token details
                let tokenSymbol = token;
                let tokenDecimals = 6;
                try {
                    tokenSymbol = await tokenContract.symbol();
                    tokenDecimals = await tokenContract.decimals();
                } catch (e) {
                    console.log('Could not fetch token details, using defaults');
                }

                const amountWei = ethers.parseUnits(amount, tokenDecimals);

                // Ask user to sign a message for verification (adds context in MetaMask)
                try {
                    const signatureMessage = `StablePay Payment Authorization\n\nMerchant: ${currentMerchant.companyName}\nAmount: ${amount} ${tokenSymbol}\nChain: ${chainConfig.chainName}\nRecipient: ${merchantWallet}\n\nBy signing, you authorize this payment.`;
                    await testPaymentSigner.signMessage(signatureMessage);
                } catch (signError) {
                    console.log('Signature skipped or rejected');
                    // If they reject the signature, don't proceed with payment
                    if (signError.code === 4001) {
                        throw new Error('Payment authorization cancelled');
                    }
                }

                const tx = await tokenContract.transfer(merchantWallet, amountWei);
                console.log('Transaction sent:', tx.hash);

                // Get explorer URL
                const explorerUrl = getExplorerUrl(chainId, tx.hash);

                alert(`Payment sent!\n\nTransaction: ${tx.hash}\n\nWaiting for confirmation...`);

                // Wait for confirmation
                const receipt = await tx.wait();
                console.log('Transaction confirmed:', receipt);

                // Update order status to CONFIRMED
                try {
                    const confirmResponse = await fetch(`/api/v1/orders`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderId: orderData.order.id,
                            txHash: tx.hash,
                            blockNumber: receipt.blockNumber.toString(),
                            status: 'CONFIRMED'
                        })
                    });

                    if (!confirmResponse.ok) {
                        console.error('Failed to confirm order:', await confirmResponse.text());
                    } else {
                        console.log('Order confirmed successfully');
                    }
                } catch (e) {
                    console.error('Failed to update order status:', e);
                }

                // Show success with explorer link
                const viewTxMessage = `Payment confirmed!\n\nTransaction: ${tx.hash}\n\nView on explorer:\n${explorerUrl}`;
                alert(viewTxMessage);

                // Open explorer link
                if (confirm('Would you like to view the transaction on the block explorer?')) {
                    window.open(explorerUrl, '_blank');
                }

                // Close modal and refresh orders
                document.getElementById('testPaymentModal').classList.add('hidden');
                loadOrders();

            } catch (error) {
                console.error('EVM payment error:', error);

                // Check if MetaMask disconnected
                if (error.message && error.message.includes('Disconnected from MetaMask')) {
                    alert('MetaMask disconnected. Please refresh this page and try again.');
                    return;
                }

                // User rejected transaction
                if (error.code === 4001 || error.message.includes('User rejected')) {
                    alert('Transaction cancelled');
                    return;
                }

                alert('Payment failed: ' + error.message);
            }
        }

        async function initiateSolanaPayment(amount, chainId, merchantWallet, token) {
            try {
                const phantom = window.solana;

                if (!phantom || !phantom.isPhantom) {
                    alert('Please install Phantom wallet to make Solana payments');
                    return;
                }

                // Get token mint address
                const tokenMints = {
                    'SOLANA_DEVNET': {
                        USDC: '4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU', // Devnet USDC (SPL Token)
                        USDT: '',
                        EURC: 'HzwqbKZw8HxMN6bF2yFZNrht3c2iXXzpKcFu7uBEDKtr' // Devnet EURC
                    },
                    'SOLANA_MAINNET': {
                        USDC: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', // Mainnet USDC
                        USDT: 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB', // Mainnet USDT
                        EURC: 'HzwqbKZw8HxMN6bF2yFZNrht3c2iXXzpKcFu7uBEDKtr' // Mainnet EURC
                    }
                };

                const mintAddress = tokenMints[chainId]?.[token];
                if (!mintAddress) {
                    alert(`${token} not available on this Solana network`);
                    return;
                }

                // Create order first
                const orderResponse = await fetch('/api/v1/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        merchantId: currentMerchant.id,
                        productName: `Test Payment - ${currentMerchant.companyName}`,
                        amount: parseFloat(amount),
                        chain: chainId,
                        customerEmail: testConnectedWalletAddress,
                        paymentAddress: merchantWallet
                    })
                });

                if (!orderResponse.ok) {
                    const errorData = await orderResponse.json();
                    console.error('Order creation failed:', errorData);
                    throw new Error(errorData.error || errorData.details || 'Failed to create order');
                }

                const orderData = await orderResponse.json();
                console.log('Order created:', orderData);

                // Setup Solana connection
                const rpcUrl = chainId === 'SOLANA_MAINNET'
                    ? 'https://api.mainnet-beta.solana.com'
                    : 'https://api.devnet.solana.com';

                const connection = new solanaWeb3.Connection(rpcUrl, 'confirmed');

                // Connect to Phantom
                const resp = await phantom.connect();
                const fromPubkey = resp.publicKey;
                const toPubkey = new solanaWeb3.PublicKey(merchantWallet);
                const mintPubkey = new solanaWeb3.PublicKey(mintAddress);

                console.log('From wallet:', fromPubkey.toString());
                console.log('To wallet:', toPubkey.toString());
                console.log('Token mint:', mintPubkey.toString());

                // Convert amount to token decimals (USDC/EURC use 6 decimals)
                const decimals = 6;
                const transferAmount = Math.floor(parseFloat(amount) * Math.pow(10, decimals));

                console.log('Transfer amount (in smallest units):', transferAmount);

                // Get or create associated token accounts
                const fromTokenAccount = await splToken.getAssociatedTokenAddress(
                    mintPubkey,
                    fromPubkey
                );

                const toTokenAccount = await splToken.getAssociatedTokenAddress(
                    mintPubkey,
                    toPubkey
                );

                console.log('From token account:', fromTokenAccount.toString());
                console.log('To token account:', toTokenAccount.toString());

                // Check if BOTH token accounts exist
                const fromAccountInfo = await connection.getAccountInfo(fromTokenAccount);
                const toAccountInfo = await connection.getAccountInfo(toTokenAccount);

                if (!fromAccountInfo) {
                    throw new Error('Source token account does not exist! You need USDC in your Phantom wallet first.');
                }

                console.log('Source account exists:', !!fromAccountInfo);
                console.log('Destination account exists:', !!toAccountInfo);

                // Create destination token account if it doesn't exist
                if (!toAccountInfo) {
                    console.log('Destination token account does not exist. Creating it first...');

                    const createAccountTx = new solanaWeb3.Transaction().add(
                        splToken.createAssociatedTokenAccountInstruction(
                            fromPubkey, // payer
                            toTokenAccount, // associated token account
                            toPubkey, // owner
                            mintPubkey // mint
                        )
                    );

                    const createBlockhash = await connection.getLatestBlockhash();
                    createAccountTx.recentBlockhash = createBlockhash.blockhash;
                    createAccountTx.feePayer = fromPubkey;

                    console.log('Requesting approval to create token account...');
                    console.log('Create account tx instructions:', createAccountTx.instructions);
                    console.log('Instruction 0:', createAccountTx.instructions[0]);
                    console.log('Instruction keys:', createAccountTx.instructions[0].keys);
                    console.log('Instruction data:', createAccountTx.instructions[0].data);
                    console.log('Program ID:', createAccountTx.instructions[0].programId.toString());

                    const { signature: createSig } = await phantom.signAndSendTransaction(createAccountTx);
                    console.log('Token account creation tx:', createSig);

                    // Wait for account creation to confirm
                    await connection.confirmTransaction({
                        signature: createSig,
                        blockhash: createBlockhash.blockhash,
                        lastValidBlockHeight: createBlockhash.lastValidBlockHeight
                    });
                    console.log('Token account created successfully');
                } else {
                    console.log('Destination token account already exists');
                }

                // Now create transfer transaction
                const transferTx = new solanaWeb3.Transaction().add(
                    splToken.createTransferInstruction(
                        fromTokenAccount,
                        toTokenAccount,
                        fromPubkey,
                        transferAmount
                    )
                );

                // Get latest blockhash
                const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash();
                transferTx.recentBlockhash = blockhash;
                transferTx.feePayer = fromPubkey;

                console.log('Transfer transaction created, requesting signature from Phantom...');
                console.log('Transfer amount:', transferAmount);
                console.log('Transfer instruction data:', transferTx.instructions[0].data);

                // Try using separate sign and send
                let signature;
                try {
                    // First, sign the transaction
                    const signedTx = await phantom.signTransaction(transferTx);
                    console.log('Transaction signed successfully');

                    // Serialize and send the signed transaction
                    const rawTransaction = signedTx.serialize();
                    console.log('Transaction serialized, sending to network...');

                    signature = await connection.sendRawTransaction(rawTransaction, {
                        skipPreflight: false,
                        preflightCommitment: 'confirmed'
                    });

                    console.log('Transaction sent! Signature:', signature);
                    alert(`Transaction submitted! Confirming...`);
                } catch (signError) {
                    console.error('Sign/Send error:', signError);
                    throw signError;
                }

                // Wait for confirmation
                const confirmation = await connection.confirmTransaction({
                    signature,
                    blockhash,
                    lastValidBlockHeight
                });

                if (confirmation.value.err) {
                    throw new Error('Transaction failed: ' + JSON.stringify(confirmation.value.err));
                }

                console.log('Transaction confirmed!', signature);

                // Update order with transaction hash
                const confirmResponse = await fetch(`/api/v1/orders/${orderData.order.id}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        txHash: signature
                    })
                });

                if (!confirmResponse.ok) {
                    const errorData = await confirmResponse.json();
                    console.error('Failed to confirm order:', errorData);
                    throw new Error(`Failed to confirm order: ${JSON.stringify(errorData)}`);
                }

                const confirmData = await confirmResponse.json();
                console.log('Order confirmed:', confirmData);

                alert(`Payment successful!\n\nTx: ${signature}`);

                // Close modal and refresh orders
                document.getElementById('testPaymentModal').classList.add('hidden');
                loadOrders();

            } catch (error) {
                console.error('Solana payment error:', error);
                alert('Payment failed: ' + error.message);
            }
        }

        function getExplorerUrl(chainId, txHash) {
            const explorers = {
                'BASE_SEPOLIA': `https://sepolia.basescan.org/tx/${txHash}`,
                'BASE_MAINNET': `https://basescan.org/tx/${txHash}`,
                'ETHEREUM_SEPOLIA': `https://sepolia.etherscan.io/tx/${txHash}`,
                'ETHEREUM_MAINNET': `https://etherscan.io/tx/${txHash}`,
                'POLYGON_MAINNET': `https://polygonscan.com/tx/${txHash}`,
                'POLYGON_MUMBAI': `https://mumbai.polygonscan.com/tx/${txHash}`,
                'ARBITRUM_MAINNET': `https://arbiscan.io/tx/${txHash}`,
                'ARBITRUM_SEPOLIA': `https://sepolia.arbiscan.io/tx/${txHash}`,
                'SOLANA_MAINNET': `https://solscan.io/tx/${txHash}`,
                'SOLANA_DEVNET': `https://solscan.io/tx/${txHash}?cluster=devnet`
            };
            return explorers[chainId] || `https://etherscan.io/tx/${txHash}`;
        }

        // Receipt viewer
        function viewReceipt(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                alert('Order not found');
                return;
            }

            const txHash = order.transactions && order.transactions.length > 0
                ? order.transactions[0].txHash
                : 'N/A';
            const explorerUrl = txHash !== 'N/A' ? getExplorerUrl(order.chain, txHash) : null;
            const amount = typeof order.amount === 'object' ? order.amount.toString() : order.amount;
            const paidAt = order.transactions && order.transactions.length > 0 && order.transactions[0].createdAt
                ? new Date(order.transactions[0].createdAt).toLocaleString()
                : new Date(order.updatedAt).toLocaleString();

            // Create receipt HTML
            const receiptHTML = `
                <div class="bg-white text-black p-8 max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-blue-600 mb-2">PAYMENT RECEIPT</h1>
                        <p class="text-sm text-gray-600">StablePay - Stablecoin Payment Platform</p>
                    </div>

                    <div class="border-t border-b border-gray-300 py-6 mb-6">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-xs text-gray-600 uppercase">From (Merchant)</p>
                                <p class="font-semibold">${currentMerchant.companyName}</p>
                                <p class="text-sm text-gray-600">${currentMerchant.email}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-600 uppercase">To (Customer)</p>
                                <p class="font-semibold">${order.customerName || 'Customer'}</p>
                                <p class="text-sm text-gray-600">${order.customerEmail || 'N/A'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <div class="grid grid-cols-2 gap-4 mb-2">
                            <div>
                                <p class="text-xs text-gray-600 uppercase">Receipt Number</p>
                                <p class="font-mono text-sm">${order.id.slice(0, 12).toUpperCase()}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-600 uppercase">Payment Date</p>
                                <p class="text-sm">${paidAt}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-gray-700">Payment Amount</span>
                            <span class="text-2xl font-bold">${amount} USDC</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Network</span>
                            <span class="font-medium">${order.chain.replace('_', ' ')}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm mt-2">
                            <span class="text-gray-600">Status</span>
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">${order.status}</span>
                        </div>
                    </div>

                    ${txHash !== 'N/A' ? `
                        <div class="mb-8">
                            <p class="text-xs text-gray-600 uppercase mb-2">Transaction Hash</p>
                            <p class="font-mono text-xs break-all bg-gray-100 p-3 rounded">${txHash}</p>
                            ${explorerUrl ? `
                                <a href="${explorerUrl}" target="_blank" class="text-blue-600 text-sm hover:underline mt-2 inline-block">
                                    View on Blockchain Explorer â†—
                                </a>
                            ` : ''}
                        </div>
                    ` : ''}

                    <div class="text-center text-xs text-gray-500 mt-8 pt-6 border-t border-gray-300">
                        <p>This is an automatically generated receipt.</p>
                        <p class="mt-1">For questions, contact ${currentMerchant.email}</p>
                    </div>
                </div>
            `;

            // Show in a modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto relative">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">
                        Ã—
                    </button>
                    ${receiptHTML}
                    <div class="p-6 bg-gray-50 flex justify-between border-t">
                        <button onclick="printReceipt('${orderId}')" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                            Print Receipt
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 text-white px-6 py-2 rounded hover:bg-gray-700">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function printReceipt(orderId) {
            window.print();
        }

        // Refund State
        let refundWalletConnected = false;
        let refundWalletAddress = null;
        let refundWalletType = null; // 'metamask' or 'phantom'
        let currentRefundOrder = null;

        // Refund Functions
        window.openRefundModal = function(orderId, amount, chain) {
            // Populate modal
            document.getElementById('refundOrderId').value = orderId;
            document.getElementById('refundOriginalAmount').value = amount + ' USDC';
            document.getElementById('refundChain').value = chain;
            document.getElementById('refundAmount').value = amount;
            document.getElementById('refundAmount').max = amount;

            // Try to get customer wallet from order transaction
            const order = allOrders.find(o => o.id === orderId);
            currentRefundOrder = order;
            if (order && order.transactions && order.transactions.length > 0) {
                const fromAddress = order.transactions[0].fromAddress;
                if (fromAddress) {
                    document.getElementById('refundCustomerWallet').value = fromAddress;
                }
            }

            // Reset wallet connection state
            refundWalletConnected = false;
            refundWalletAddress = null;
            document.getElementById('refundWalletNotConnected').classList.remove('hidden');
            document.getElementById('refundWalletConnected').classList.add('hidden');
            document.getElementById('executeRefundBtn').disabled = true;

            // Show modal
            document.getElementById('refundModal').classList.remove('hidden');
        };

        // Connect MetaMask for refund
        document.getElementById('refundConnectMetaMask').addEventListener('click', async () => {
            if (!window.ethereum) {
                alert('MetaMask is not installed. Please install MetaMask to continue.');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const address = accounts[0];

                refundWalletConnected = true;
                refundWalletAddress = address;
                refundWalletType = 'metamask';

                document.getElementById('refundConnectedAddress').textContent = address;
                document.getElementById('refundWalletNotConnected').classList.add('hidden');
                document.getElementById('refundWalletConnected').classList.remove('hidden');
                document.getElementById('executeRefundBtn').disabled = false;
            } catch (error) {
                console.error('MetaMask connection error:', error);
                alert('Failed to connect MetaMask: ' + error.message);
            }
        });

        // Connect Phantom for refund
        document.getElementById('refundConnectPhantom').addEventListener('click', async () => {
            if (!window.solana || !window.solana.isPhantom) {
                alert('Phantom wallet is not installed. Please install Phantom to continue.');
                return;
            }

            try {
                const resp = await window.solana.connect();
                const address = resp.publicKey.toString();

                refundWalletConnected = true;
                refundWalletAddress = address;
                refundWalletType = 'phantom';

                document.getElementById('refundConnectedAddress').textContent = address;
                document.getElementById('refundWalletNotConnected').classList.add('hidden');
                document.getElementById('refundWalletConnected').classList.remove('hidden');
                document.getElementById('executeRefundBtn').disabled = false;
            } catch (error) {
                console.error('Phantom connection error:', error);
                alert('Failed to connect Phantom: ' + error.message);
            }
        });

        // Disconnect refund wallet
        document.getElementById('refundDisconnectWallet').addEventListener('click', () => {
            refundWalletConnected = false;
            refundWalletAddress = null;
            refundWalletType = null;

            document.getElementById('refundWalletNotConnected').classList.remove('hidden');
            document.getElementById('refundWalletConnected').classList.add('hidden');
            document.getElementById('executeRefundBtn').disabled = true;
        });

        // Close refund modal
        document.getElementById('closeRefundModal').addEventListener('click', () => {
            document.getElementById('refundModal').classList.add('hidden');
        });

        document.getElementById('cancelRefundBtn').addEventListener('click', () => {
            document.getElementById('refundModal').classList.add('hidden');
        });

        // Execute refund
        document.getElementById('executeRefundBtn').addEventListener('click', async () => {
            const orderId = document.getElementById('refundOrderId').value;
            const amount = document.getElementById('refundAmount').value;
            const reason = document.getElementById('refundReason').value;
            const customerWallet = document.getElementById('refundCustomerWallet').value;
            const chain = document.getElementById('refundChain').value;

            if (!refundWalletConnected || !refundWalletAddress) {
                alert('Please connect your wallet first');
                return;
            }

            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid refund amount');
                return;
            }

            if (!reason.trim()) {
                alert('Please provide a reason for the refund');
                return;
            }

            if (!customerWallet.trim()) {
                alert('Please provide a customer wallet address');
                return;
            }

            try {
                const btn = document.getElementById('executeRefundBtn');
                btn.disabled = true;
                btn.textContent = 'Processing...';

                // Step 1: Create refund record
                const createResponse = await fetch('/api/refunds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        amount: amount,
                        reason: reason,
                        status: 'PROCESSING'
                    })
                });

                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error || 'Failed to create refund record');
                }

                const { refund } = await createResponse.json();

                // Step 2: Execute blockchain transaction
                let txHash;
                if (refundWalletType === 'metamask') {
                    txHash = await executeEVMRefund(chain, customerWallet, amount);
                } else if (refundWalletType === 'phantom') {
                    txHash = await executeSolanaRefund(customerWallet, amount);
                }

                // Step 3: Update refund with transaction hash
                const updateResponse = await fetch(`/api/refunds/${refund.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: 'COMPLETED',
                        refundTxHash: txHash
                    })
                });

                if (!updateResponse.ok) {
                    console.error('Failed to update refund record, but transaction was successful');
                }

                alert('Refund executed successfully!\n\nTransaction Hash: ' + txHash + '\nRefund ID: ' + refund.id);
                document.getElementById('refundModal').classList.add('hidden');
                loadOrders(); // Refresh orders
            } catch (error) {
                console.error('Refund execution error:', error);
                alert('Error executing refund: ' + error.message);
            } finally {
                const btn = document.getElementById('executeRefundBtn');
                btn.disabled = false;
                btn.textContent = 'Execute Refund';
            }
        });

        // Execute EVM refund (MetaMask)
        async function executeEVMRefund(chain, recipientAddress, amount) {
            if (!window.ethereum) {
                throw new Error('MetaMask not found');
            }

            const provider = new ethers.BrowserProvider(window.ethereum);
            const signer = await provider.getSigner();

            // Get USDC token address for the chain
            const tokenConfig = getChainConfig(chain, 'USDC');
            const usdcAddress = tokenConfig.USDC;

            if (!usdcAddress || usdcAddress === '0x') {
                throw new Error(`USDC address not configured for ${chain}`);
            }

            // ERC20 ABI for transfer
            const erc20ABI = [
                'function transfer(address to, uint256 amount) returns (bool)',
                'function decimals() view returns (uint8)'
            ];

            const usdcContract = new ethers.Contract(usdcAddress, erc20ABI, signer);

            // USDC has 6 decimals
            const amountInSmallestUnit = ethers.parseUnits(amount.toString(), 6);

            // Execute transfer
            const tx = await usdcContract.transfer(recipientAddress, amountInSmallestUnit);
            console.log('Refund transaction sent:', tx.hash);

            // Wait for confirmation
            await tx.wait();
            console.log('Refund transaction confirmed');

            return tx.hash;
        }

        // Execute Solana refund (Phantom)
        async function executeSolanaRefund(recipientAddress, amount) {
            if (!window.solana || !window.solana.isPhantom) {
                throw new Error('Phantom wallet not found');
            }

            const connection = new solanaWeb3.Connection(
                solanaWeb3.clusterApiUrl('devnet'), // Change to mainnet for production
                'confirmed'
            );

            const fromWallet = window.solana.publicKey;
            const toWallet = new solanaWeb3.PublicKey(recipientAddress);

            // USDC Mint on Solana (Devnet)
            // Mainnet: EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v
            const usdcMint = new solanaWeb3.PublicKey('4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU'); // Devnet USDC

            // Get token accounts
            const fromTokenAccount = await getAssociatedTokenAddress(usdcMint, fromWallet);
            const toTokenAccount = await getAssociatedTokenAddress(usdcMint, toWallet);

            // USDC has 6 decimals on Solana
            const amountInSmallestUnit = amount * 1_000_000;

            // Create transfer instruction
            const transferInstruction = solanaWeb3.SystemProgram.transfer({
                fromPubkey: fromTokenAccount,
                toPubkey: toTokenAccount,
                lamports: amountInSmallestUnit
            });

            const transaction = new solanaWeb3.Transaction().add(transferInstruction);
            transaction.feePayer = fromWallet;

            const { blockhash } = await connection.getLatestBlockhash();
            transaction.recentBlockhash = blockhash;

            // Sign and send transaction
            const signed = await window.solana.signTransaction(transaction);
            const signature = await connection.sendRawTransaction(signed.serialize());

            // Wait for confirmation
            await connection.confirmTransaction(signature);
            console.log('Refund transaction confirmed:', signature);

            return signature;
        }

        // Batch Refund State
        let batchRefundOrders = [];

        // Add order to batch refund
        window.addToBatchRefund = function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            // Check if already added
            if (batchRefundOrders.some(o => o.id === orderId)) {
                alert('Order already added to batch refund');
                return;
            }

            // Get customer wallet from transaction
            let customerWallet = '';
            if (order.transactions && order.transactions.length > 0) {
                customerWallet = order.transactions[0].fromAddress;
            }

            batchRefundOrders.push({
                id: order.id,
                amount: parseFloat(order.amount),
                chain: order.chain,
                customerWallet: customerWallet
            });

            updateBatchRefundUI();
        };

        // Remove order from batch refund
        function removeFromBatchRefund(orderId) {
            batchRefundOrders = batchRefundOrders.filter(o => o.id !== orderId);
            updateBatchRefundUI();
        }

        // Update batch refund UI
        function updateBatchRefundUI() {
            const isEmpty = batchRefundOrders.length === 0;

            document.getElementById('batchRefundEmpty').classList.toggle('hidden', !isEmpty);
            document.getElementById('batchRefundList').classList.toggle('hidden', isEmpty);

            if (!isEmpty) {
                document.getElementById('batchRefundCount').textContent = batchRefundOrders.length;

                const total = batchRefundOrders.reduce((sum, o) => sum + o.amount, 0);
                document.getElementById('batchRefundTotal').textContent = total.toFixed(2);

                const itemsHtml = batchRefundOrders.map(order => `
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded">
                        <div class="flex-1">
                            <div class="text-white font-mono text-sm">${order.id}</div>
                            <div class="text-slate-400 text-xs">${order.amount} USDC â€¢ ${order.chain}</div>
                        </div>
                        <button onclick="removeFromBatchRefund('${order.id}')" class="text-red-400 hover:text-red-300 text-sm ml-4">
                            Remove
                        </button>
                    </div>
                `).join('');

                document.getElementById('batchRefundItems').innerHTML = itemsHtml;
            }
        }

        // Clear batch refund selection
        document.getElementById('clearBatchRefunds').addEventListener('click', () => {
            if (batchRefundOrders.length === 0) return;

            if (confirm(`Clear ${batchRefundOrders.length} selected orders?`)) {
                batchRefundOrders = [];
                updateBatchRefundUI();
            }
        });

        // Execute batch refund using Multicall3
        document.getElementById('executeBatchRefundBtn').addEventListener('click', async () => {
            if (batchRefundOrders.length === 0) {
                alert('No orders selected for batch refund');
                return;
            }

            // Check all orders are on the same chain
            const chains = [...new Set(batchRefundOrders.map(o => o.chain))];
            if (chains.length > 1) {
                alert('Batch refunds must be on the same chain. Selected orders span multiple chains: ' + chains.join(', '));
                return;
            }

            const chain = chains[0];

            // Check if chain is Solana (not supported for batch)
            if (chain.includes('SOLANA')) {
                alert('Batch refunds are not supported on Solana. Please process refunds individually.');
                return;
            }

            // Connect wallet if not connected
            if (!window.ethereum) {
                alert('MetaMask is not installed. Please install MetaMask to continue.');
                return;
            }

            try {
                const btn = document.getElementById('executeBatchRefundBtn');
                btn.disabled = true;
                btn.textContent = 'Processing...';

                // Connect wallet
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const walletAddress = accounts[0];

                // Execute batch refund
                const txHash = await executeBatchRefundTransaction(chain, batchRefundOrders);

                // Create refund records for each order
                for (const order of batchRefundOrders) {
                    try {
                        const createResponse = await fetch('/api/refunds', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                orderId: order.id,
                                amount: order.amount.toString(),
                                reason: `Batch refund (tx: ${txHash})`,
                                status: 'COMPLETED'
                            })
                        });

                        if (createResponse.ok) {
                            const { refund } = await createResponse.json();

                            // Update with tx hash
                            await fetch(`/api/refunds/${refund.id}`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    status: 'COMPLETED',
                                    refundTxHash: txHash
                                })
                            });
                        }
                    } catch (error) {
                        console.error(`Failed to create refund record for order ${order.id}:`, error);
                    }
                }

                alert(`Batch refund executed successfully!\n\nTransaction Hash: ${txHash}\n${batchRefundOrders.length} refunds processed`);

                // Clear batch and refresh
                batchRefundOrders = [];
                updateBatchRefundUI();
                loadOrders();
            } catch (error) {
                console.error('Batch refund error:', error);
                alert('Error executing batch refund: ' + error.message);
            } finally {
                const btn = document.getElementById('executeBatchRefundBtn');
                btn.disabled = false;
                btn.textContent = 'Execute Batch Refund';
            }
        });

        // Execute batch refund transaction using Multicall3
        async function executeBatchRefundTransaction(chain, orders) {
            const provider = new ethers.BrowserProvider(window.ethereum);
            const signer = await provider.getSigner();

            // Multicall3 address (same on all EVM chains)
            const multicall3Address = '0xcA11bde05977b3631167028862bE2a173976CA11';

            // Get USDC token address
            const tokenConfig = getChainConfig(chain, 'USDC');
            const usdcAddress = tokenConfig.USDC;

            if (!usdcAddress || usdcAddress === '0x') {
                throw new Error(`USDC address not configured for ${chain}`);
            }

            // ERC20 ABI for transfer
            const erc20Interface = new ethers.Interface([
                'function transfer(address to, uint256 amount) returns (bool)'
            ]);

            // Build calls array for Multicall3
            const calls = orders.map(order => {
                const amountInSmallestUnit = ethers.parseUnits(order.amount.toString(), 6);
                const callData = erc20Interface.encodeFunctionData('transfer', [
                    order.customerWallet,
                    amountInSmallestUnit
                ]);

                return {
                    target: usdcAddress,
                    allowFailure: false,
                    callData: callData
                };
            });

            // Multicall3 ABI
            const multicall3ABI = [
                'function aggregate3(tuple(address target, bool allowFailure, bytes callData)[] calls) returns (tuple(bool success, bytes returnData)[] returnData)'
            ];

            const multicall3Contract = new ethers.Contract(multicall3Address, multicall3ABI, signer);

            // Execute multicall
            const tx = await multicall3Contract.aggregate3(calls);
            console.log('Batch refund transaction sent:', tx.hash);

            // Wait for confirmation
            await tx.wait();
            console.log('Batch refund transaction confirmed');

            return tx.hash;
        }

        function getChainConfig(chainId, token = 'USDC') {
            const tokenAddresses = {
                'BASE_SEPOLIA': {
                    USDC: '0x036CbD53842c5426634e7929541eC2318f3dCF7e',
                    USDT: '0x', // Add if available
                    EURC: '0x'  // Add if available
                },
                'BASE_MAINNET': {
                    USDC: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
                    USDT: '0x', // Add USDT address
                    EURC: '0x60a3E35Cc302bFA44Cb288Bc5a4F316Fdb1adb42'
                },
                'ETHEREUM_SEPOLIA': {
                    USDC: '0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238',
                    USDT: '0x', // Add if available
                    EURC: '0x'  // Add if available
                },
                'ETHEREUM_MAINNET': {
                    USDC: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                    USDT: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                    EURC: '0x1aBaEA1f7C830bD89Acc67eC4af516284b1bC33c'
                },
                'POLYGON_MAINNET': {
                    USDC: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
                    USDT: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F',
                    EURC: '0x'  // Add if available
                },
                'POLYGON_MUMBAI': {
                    USDC: '0x0FA8781a83E46826621b3BC094Ea2A0212e71B23',
                    USDT: '0x', // Add if available
                    EURC: '0x'  // Add if available
                },
                'ARBITRUM_MAINNET': {
                    USDC: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831',
                    USDT: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9',
                    EURC: '0x'  // Add if available
                },
                'ARBITRUM_SEPOLIA': {
                    USDC: '0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d',
                    USDT: '0x', // Add if available
                    EURC: '0x'  // Add if available
                }
            };

            const configs = {
                'BASE_SEPOLIA': {
                    chainId: '0x14a34',
                    chainName: 'Base Sepolia',
                    rpcUrls: ['https://sepolia.base.org'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://sepolia.basescan.org']
                },
                'BASE_MAINNET': {
                    chainId: '0x2105',
                    chainName: 'Base',
                    rpcUrls: ['https://mainnet.base.org'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://basescan.org']
                },
                'ETHEREUM_SEPOLIA': {
                    chainId: '0xaa36a7',
                    chainName: 'Ethereum Sepolia',
                    rpcUrls: ['https://rpc.sepolia.org'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://sepolia.etherscan.io']
                },
                'ETHEREUM_MAINNET': {
                    chainId: '0x1',
                    chainName: 'Ethereum',
                    rpcUrls: ['https://eth.llamarpc.com'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://etherscan.io']
                },
                'POLYGON_MAINNET': {
                    chainId: '0x89',
                    chainName: 'Polygon',
                    rpcUrls: ['https://polygon-rpc.com'],
                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                    blockExplorerUrls: ['https://polygonscan.com']
                },
                'POLYGON_MUMBAI': {
                    chainId: '0x13881',
                    chainName: 'Polygon Mumbai',
                    rpcUrls: ['https://rpc-mumbai.maticvigil.com'],
                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                    blockExplorerUrls: ['https://mumbai.polygonscan.com']
                },
                'ARBITRUM_MAINNET': {
                    chainId: '0xa4b1',
                    chainName: 'Arbitrum One',
                    rpcUrls: ['https://arb1.arbitrum.io/rpc'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://arbiscan.io']
                },
                'ARBITRUM_SEPOLIA': {
                    chainId: '0x66eee',
                    chainName: 'Arbitrum Sepolia',
                    rpcUrls: ['https://sepolia-rollup.arbitrum.io/rpc'],
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    blockExplorerUrls: ['https://sepolia.arbiscan.io']
                }
            };

            const config = configs[chainId];
            if (!config) return null;

            // Add token address
            config.tokenAddress = tokenAddresses[chainId]?.[token];

            return config;
        }

        // Load settings
        function loadSettings() {
            // Settings are already loaded in loadMerchantData
        }

        // Modal functions (unused, wallet modal was replaced with inline form)
        function showAddWalletModal() {
            const modal = document.getElementById('addWalletModal');
            modal.classList.remove('hidden');
        }

        function hideAddWalletModal() {
            document.getElementById('addWalletModal').classList.add('hidden');
            document.getElementById('addWalletForm').reset();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Apply system settings
            applySystemSettings();

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });


            // Refresh button
            const refreshBtn = document.getElementById('refreshOrdersBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadOrders);
            }

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    sessionStorage.removeItem('merchantToken');
                    window.location.href = '/login.html';
                });
            }

            // Save profile button
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch(`/api/merchant-profile`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: currentMerchant.id,
                            companyName: document.getElementById('companyName').value,
                            contactName: document.getElementById('contactName').value,
                            email: document.getElementById('email').value
                        })
                    });

                    if (response.ok) {
                        currentMerchant.companyName = document.getElementById('companyName').value;
                        currentMerchant.contactName = document.getElementById('contactName').value;
                        currentMerchant.email = document.getElementById('email').value;

                        // Update profile card
                        document.getElementById('merchantName').textContent = currentMerchant.companyName;
                        document.getElementById('profileCompanyName').textContent = currentMerchant.companyName;
                        document.getElementById('profileEmail').textContent = currentMerchant.email;
                        document.getElementById('profileContact').textContent = currentMerchant.contactName;

                        alert('Profile updated successfully!');
                    } else {
                        alert('Failed to update profile');
                    }
                } catch (error) {
                    console.error('Error saving profile:', error);
                    alert('Failed to save profile');
                }
                });
            }

            // Initialize
            // Check for pending status
            const isPending = sessionStorage.getItem("isPending") === "true";
            if (isPending) {
                document.getElementById("pendingBanner").classList.remove("hidden");
            }

            // Load merchant data first, it will trigger loading the current tab
            loadMerchantData();
        });

        // Helper functions for Developer tab
        function copyToClipboard(button, text) {
            navigator.clipboard.writeText(text.trim());
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.classList.add('bg-green-700');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-700');
            }, 2000);
        }

        function copyMerchantId() {
            const merchantId = document.getElementById('apiMerchantId').textContent;
            navigator.clipboard.writeText(merchantId);
            alert('Merchant ID copied!');
        }

        function showFramework(framework) {
            // Hide all framework content
            document.querySelectorAll('.framework-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Remove active state from all tabs
            document.querySelectorAll('.framework-tab').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-white');
                tab.classList.add('border-transparent', 'text-slate-400');
            });

            // Show selected framework
            document.getElementById(`framework-${framework}`).classList.remove('hidden');

            // Mark tab as active
            const activeTab = document.getElementById(`tab-${framework}`);
            activeTab.classList.add('border-blue-500', 'text-white');
            activeTab.classList.remove('border-transparent', 'text-slate-400');
        }

        function openTestPayment() {
            document.getElementById('testPaymentBtn').click();
        }

        // Auto-populate merchant ID in widget code
        function updateWidgetCode() {
            if (currentMerchant && currentMerchant.id) {
                // Update widget merchant ID placeholder
                const widgetMerchantIdSpan = document.getElementById('widgetMerchantId');
                if (widgetMerchantIdSpan) {
                    widgetMerchantIdSpan.textContent = currentMerchant.id;
                }

                // Update configured wallets list
                if (merchantWallets && merchantWallets.length > 0) {
                    const walletsList = document.getElementById('configuredWalletsList');
                    walletsList.innerHTML = merchantWallets
                        .filter(w => w.isActive)
                        .map(w => `
                            <div class="flex justify-between items-center bg-slate-950 border border-slate-800 p-2 rounded">
                                <div>
                                    <div class="text-slate-300 font-mono text-xs">${w.chain}</div>
                                    <div class="text-slate-500 text-xs truncate" style="max-width: 200px">${w.address}</div>
                                </div>
                                <div class="text-green-400 text-xs">[OK]</div>
                            </div>
                        `).join('');
                } else {
                    const walletsList = document.getElementById('configuredWalletsList');
                    walletsList.innerHTML = '<div class="text-slate-400 text-sm">No wallets configured. Go to Wallets tab to add wallets.</div>';
                }
            }
        }

        // Show React framework by default when Developer tab loads
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                showFramework('react');
            }, 100);
        });

        // Night mode toggle
        const nightModeToggle = document.getElementById('nightModeToggle');
        const nightIcon = nightModeToggle.querySelector('.night-icon');
        const dayIcon = nightModeToggle.querySelector('.day-icon');

        // Check for saved preference
        const savedMode = localStorage.getItem('nightMode');
        if (savedMode === 'true') {
            document.body.classList.add('night-mode');
            nightIcon.classList.add('hidden');
            dayIcon.classList.remove('hidden');
        }

        nightModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('night-mode');
            nightIcon.classList.toggle('hidden');
            dayIcon.classList.toggle('hidden');
            localStorage.setItem('nightMode', document.body.classList.contains('night-mode'));
        });

        // i18n Translation system
        let translations = {};
        let currentLang = 'en';

        async function changeLanguage(lang) {
            try {
                const response = await fetch(`./locales/dashboard-${lang}.json`);
                translations = await response.json();
                currentLang = lang;
                localStorage.setItem('language', lang);
                document.getElementById('langSelector').value = lang;
                updatePageText();
            } catch (error) {
                console.error('Error loading translation:', error);
            }
        }

        function updatePageText() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const keys = key.split('.');
                let value = translations;

                for (const k of keys) {
                    value = value[k];
                    if (!value) break;
                }

                if (value) {
                    if (value.includes('<')) {
                        element.innerHTML = value;
                    } else {
                        element.textContent = value;
                    }
                }
            });
        }

        // Load saved language preference on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('language') || 'en';
            document.getElementById('langSelector').value = savedLang;
            changeLanguage(savedLang);
        });
    </script>
</body>
</html>